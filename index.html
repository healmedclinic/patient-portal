<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealMed Patient/Admin Portal</title>
    <!-- FullCalendar CSS -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.css" rel="stylesheet" />
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* All your CSS styles are now embedded here */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column; /* Changed to column to stack header on top */
            align-items: center;
            justify-content: flex-start; /* Align content from the top */
            overflow-y: auto; /* Allow scrolling for content that overflows viewport */
        }

        .container {
            width: 100%;
            max-width: 1200px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            margin: 20px;
            flex-grow: 1; /* Allow container to grow and fill space below header */
        }

        .hidden {
            display: none !important;
        }

        /* Top Header for Branding */
        .header-branding {
            width: 100%; /* Take full width */
            padding: 20px;
            background: #2c3e50; /* Dark background for header */
            color: white;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            margin-bottom: 20px; /* Space between header and container */
        }

        .header-branding h1 {
            font-size: 2.5em; /* Larger for main name */
            font-weight: 700;
            margin-bottom: 5px; /* Space between name and slogan */
        }
        .header-branding p {
            font-size: 1.2em; /* Slogan size */
            opacity: 0.8;
            margin: 0; /* Remove default paragraph margin */
        }


        /* Login Screen - NEW FLEXBOX LAYOUT */
        .login-screen-wrapper {
            display: flex;
            flex-direction: row; /* Default to row for larger screens */
            justify-content: center;
            align-items: flex-start; /* Align items to the top if they have different heights */
            width: 100%;
            padding: 20px;
            gap: 30px; /* Space between the two columns */
            flex-grow: 1; /* Allow it to grow and fill space */
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); /* Background for the whole area */
        }

        /* Specific styling for the login form and public access box */
        .login-form-container, .public-access-container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            flex-shrink: 0; /* Prevent shrinking */
        }

        .login-form-container {
            width: 450px; /* Fixed width for login form, adjust as needed */
            max-width: 100%; /* Ensure it doesn't overflow on very small screens */
        }

        .public-access-container {
            width: 450px; /* Fixed width for public access, adjust as needed */
            max-width: 100%; /* Ensure it doesn't overflow on very small screens */
            display: flex;
            flex-direction: column;
        }
        .public-access-container h2 {
            margin-bottom: 20px;
            color: #333;
            font-size: 28px;
            text-align: center;
        }

        .public-access-buttons {
            display: flex;
            flex-direction: column; /* Stack buttons vertically */
            gap: 15px; /* Spacing between buttons */
            margin-bottom: 20px; /* Space below buttons before info boxes */
        }

        .public-access-buttons .btn {
            background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%); /* Green for public access */
            padding: 15px;
            font-size: 1.1em;
            width: 100%; /* Ensure full width within its container */
            margin-bottom: 0; /* Override default btn margin */
            text-decoration: none !important; /* NEW: Remove underline */
            text-align: center; /* NEW: Center text */
        }
        .public-access-buttons .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .info-box {
            background: #e9ecef;
            border-left: 5px solid #667eea;
            border-radius: 8px;
            padding: 15px;
            font-size: 0.95em;
            color: #333;
            line-height: 1.5;
            margin-top: 15px; /* Space between info boxes */
        }


        .login-form h2 {
            margin-bottom: 30px;
            color: #333;
            font-size: 28px;
        }

        /* NEW: Centering buttons in login/signup forms */
        .login-form {
            text-align: center; /* Center all block/inline-block children */
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left; /* Keep labels/inputs left-aligned within their group */
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
            margin-bottom: 10px;
            text-decoration: none !important; /* NEW: Remove underline */
            text-align: center; /* NEW: Center text */
        }
        .btn.external-link-btn { /* Style for external link buttons */
            width: auto;
            padding: 10px 25px;
            margin-top: 15px;
            display: inline-block; /* Allows text to wrap without full width */
            text-decoration: none !important; /* NEW: Remove underline */
            text-align: center; /* NEW: Center text */
            margin-right: 10px; /* Space between multiple buttons */
        }
        /* Style for patient list buttons in admin panel */
        .btn.patient-card-btn {
            background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%); /* Admin patient card background */
            color: white;
            text-align: left; /* Keep left-aligned for more content */
            padding: 15px 20px;
            margin-bottom: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            font-size: 1.2em;
            font-weight: bold;
            display: flex; /* Use flex to align text and icon */
            justify-content: space-between; /* Push text to left, icon to right */
            align-items: center;
            width: 100%;
            text-decoration: none !important; /* NEW: Remove underline */
        }
        .btn.patient-card-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }

        /* New buttons for viewing specific patient data */
        .btn.view-patient-data-btn {
            background: #28a745;
            color: white;
            width: auto;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 15px;
            margin-right: 10px;
            margin-bottom: 10px;
            display: inline-block;
            text-decoration: none !important; /* NEW: Remove underline */
            text-align: center; /* NEW: Center text */
        }
        .btn.view-patient-data-btn.booked-appointments {
            background: linear-gradient(135deg, #ff8c00 0%, #ff5722 100%);
        }
        .btn.view-patient-data-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        .btn.view-patient-data-btn.booked-appointments:hover {
            background: #e66a00;
        }
        .patient-data-buttons-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            color: #333;
            text-decoration: none !important; /* NEW: Remove underline */
            text-align: center; /* NEW: Center text */
        }

        .link-btn {
            background: none;
            color: #667eea;
            text-decoration: none !important; /* NEW: Remove underline */
            border: none;
            cursor: pointer;
            font-size: 14px;
            padding: 0;
            display: inline-block; /* Essential for text-align to work on parent */
        }
        
        .radio-group-inline {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 10px;
        }
        .radio-option-inline {
            display: inline-flex;
            align-items: center;
        }
        .radio-option-inline input[type="radio"] {
            margin-right: 5px;
            width: auto;
            margin-top: 0;
        }
        .follow-up-question {
            margin-top: 10px;
            padding: 15px;
            background: #e9ecef;
            border-left: 5px solid #667eea;
            border-radius: 8px;
            font-size: 0.9em;
        }
        .follow-up-question label {
            font-weight: 600;
        }
        .follow-up-question textarea {
            min-height: 80px;
        }


        /* Dashboard */
        .dashboard {
            display: flex;
            min-height: 100%;
            position: relative;
        }

        .sidebar {
            width: 250px;
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px 0;
            flex-shrink: 0;
        }

        .sidebar h3 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
        }

        .sidebar ul {
            list-style: none;
        }

        .sidebar li {
            padding: 15px 30px;
            cursor: pointer;
            transition: background-color 0.3s;
            text-align: center; /* NEW: Center sidebar items text */
        }

        .sidebar li:hover, .sidebar li.active {
            background-color: rgba(255,255,255,0.1);
        }

        .main-content {
            flex: 1;
            padding: 40px;
            background: #f8f9fa;
            overflow-y: auto;
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }

        .section h2 {
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 24px;
        }

        /* Appointments */
        .appointment-card {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .appointment-card.booked-appt-card {
            background: linear-gradient(135deg, #ff8c00 0%, #ff5722 100%);
        }

        .appointment-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .status-pending {
            background: #f39c12;
        }

        .status-approved {
            background: #27ae60;
        }

        .status-denied {
            background: #e74c3c;
        }

        /* Mental Health Tests */
        .test-card {
            background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: transform 0.2s;
            text-decoration: none !important; /* NEW: Remove underline */
            text-align: center; /* NEW: Center text */
        }

        .test-card:hover {
            transform: translateY(-3px);
        }

        .question {
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            color: #333;
        }

        .question h4 {
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .radio-option:hover {
            background: #e9ecef;
        }

        .test-result-item {
            background: linear-gradient(135deg, #00b894 0%, #00a085 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            margin-bottom: 15px;
        }
        .tms-questionnaire-item {
            background: linear-gradient(135deg, #f0932b 0%, #eb4d4b 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            margin-bottom: 15px;
        }
        .tms-questionnaire-item ul {
            list-style: none;
            padding-left: 0;
            margin-top: 10px;
        }
        .tms-questionnaire-item li {
            margin-bottom: 5px;
        }

        /* Admin specific styles */
        .admin-card {
            background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .admin-card.approved-status {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        }
        .admin-card.denied-status {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
        .admin-card .document-image {
            max-width: 100px;
            max-height: 100px;
            border-radius: 8px;
            margin-top: 10px;
            border: 2px solid rgba(255,255,255,0.6);
            cursor: zoom-in;
            transition: transform 0.2s;
        }
        .admin-card .document-image:hover {
            transform: scale(1.05);
        }
        .admin-card .document-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed rgba(255,255,255,0.5);
        }
        .admin-card .document-item {
            margin-bottom: 10px;
        }

        .action-buttons {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        .btn-approve {
            background: #27ae60;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.2s;
            text-align: center; /* NEW: Center text */
        }
        .btn-approve:hover {
            transform: translateY(-2px);
        }

        .btn-deny {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.2s;
            text-align: center; /* NEW: Center text */
        }
        .btn-deny:hover {
            transform: translateY(-2px);
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 100;
            text-align: center; /* NEW: Center text */
        }

        .calendar-entry {
            background: linear-gradient(135deg, #81ecec 0%, #00cec9 100%);
            color: #333;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .calendar-entry h4 {
            color: #2c3e50;
            margin-bottom: 5px;
        }

        /* FullCalendar specific styles */
        #calendar {
            max-width: 900px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            min-height: 500px;
        }

        .fc .fc-toolbar-title {
            font-size: 1.8em;
            color: #2c3e50;
        }

        .fc .fc-button-primary {
            background-color: #667eea;
            border-color: #667eea;
            color: white;
            border-radius: 5px;
            padding: 8px 15px;
            transition: background-color 0.2s;
            text-decoration: none !important; /* NEW: Remove underline */
            text-align: center; /* NEW: Center text */
        }
        .fc .fc-button-primary:hover {
            background-color: #5a6de0;
            border-color: #5a6de0;
        }
        .fc .fc-button-primary:not(:disabled).fc-button-active {
            background-color: #4a5dc1;
            border-color: #4a5dc1;
        }

        /* Custom event rendering for FullCalendar: green circle */
        .fc-event-main-frame {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .event-circle {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #27ae60;
            flex-shrink: 0;
        }
        /* Default FullCalendar event background */
        .fc-event {
            background-color: #0984e3 !important;
            border-color: #0984e3 !important;
            border-radius: 5px !important;
            padding: 3px 5px !important;
            font-size: 0.85em !important;
            cursor: pointer;
            text-decoration: none !important; /* NEW: Remove underline */
            text-align: center; /* NEW: Center text */
        }
        /* Specific styling for the green dot events (if you want to override default background) */
        .fc-event.approved-event {
            background-color: #27ae60 !important;
            border-color: #27ae60 !important;
        }

        .fc-event-title {
            color: white !important;
            font-weight: bold;
        }
        
        .fc-event-time {
            color: rgba(255, 255, 255, 0.8) !important;
        }

        /* Modal for event details */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border: 1px solid #888;
            border-radius: 15px;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: relative;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-content h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 22px;
        }
        .modal-content p {
            margin-bottom: 8px;
            color: #555;
        }
        .modal-content hr {
            margin: 20px 0;
            border: 0;
            border-top: 1px solid #eee;
        }
        .modal-content .form-group {
            margin-bottom: 15px;
        }
        .modal-content .form-group label {
            font-weight: bold;
        }

        /* Admin TMS Submissions specific styles */
        .tms-submission-card, .public-test-submission-card { /* Combined style for similar cards */
            background: linear-gradient(135deg, #FFC107 0%, #FF9800 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            display: flex; /* Use flex for alignment */
            justify-content: space-between; /* Push content to left, buttons to right */
            align-items: center;
        }
        .public-test-submission-card {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%); /* Blue for public tests */
        }
        .tms-submission-card h4, .public-test-submission-card h4 {
            margin-bottom: 10px;
            font-size: 1.3em;
        }
        .tms-submission-card p, .public-test-submission-card p {
            margin-bottom: 5px;
            font-size: 0.95em;
        }
        .tms-submission-card .card-actions, .public-test-submission-card .card-actions {
            display: flex;
            flex-direction: column; /* Stack buttons vertically */
            gap: 8px;
            margin-left: 15px; /* Space from content */
            flex-shrink: 0; /* Prevent shrinking */
        }

        .tms-submission-card .btn-view-details, .public-test-submission-card .btn-view-details {
            background: #2c3e50;
            color: white;
            width: auto;
            padding: 8px 15px;
            border-radius: 5px;
            text-align: center;
            text-decoration: none !important;
        }
        .tms-submission-card .btn-view-details:hover, .public-test-submission-card .btn-view-details:hover {
            background: #34495e;
            transform: translateY(-2px);
        }

        /* Delete button styling (trash icon) */
        .btn-delete {
            background: none;
            border: none;
            color: #e74c3c; /* Red color for trash icon */
            font-size: 1.2em;
            cursor: pointer;
            padding: 5px;
            transition: color 0.2s, transform 0.2s;
        }
        .btn-delete:hover {
            color: #c0392b;
            transform: scale(1.1);
        }

        /* Public Mental Health Test Selection Screen */
        .public-test-selection {
            display: flex;
            flex-direction: column;
            gap: 20px;
            justify-content: center;
            align-items: center;
            padding: 40px;
            background: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%);
            min-height: 100%;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        }
        .public-test-selection h2 {
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 2em;
            text-align: center;
        }
        .public-test-selection .test-card {
            width: 80%;
            max-width: 400px;
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
            padding: 25px;
            font-size: 1.1em;
            text-align: center;
            cursor: pointer;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            text-decoration: none !important;
        }
        .public-test-selection .test-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .public-test-selection .test-card h3 {
            margin-bottom: 10px;
        }
        .public-test-selection .btn-back {
            margin-top: 30px;
            width: auto;
            padding: 10px 30px;
            background: #6c757d;
            color: white;
            text-align: center;
            text-decoration: none !important;
        }
        .public-test-selection .btn-back:hover {
            background: #5a6268;
        }

        /* Public Test Interface (reusing #testInterface, but styling differently for clarity) */
        #testInterface.public-test-interface {
            background: #f8f9fa;
            border-left: none;
            box-shadow: none;
            padding: 20px;
        }
        #testInterface.public-test-interface .question {
            background: white;
            border: 1px solid #e1e5e9;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        #testInterface.public-test-interface .btn {
            background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);
            text-align: center;
        }
        #testInterface.public-test-interface .btn-secondary {
            background: #6c757d;
            text-align: center;
        }

        /* Public Test Result Display */
        #publicTestResultDisplay {
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            color: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            text-align: center;
        }
        #publicTestResultDisplay h3 {
            font-size: 1.8em;
            margin-bottom: 15px;
        }
        #publicTestResultDisplay p {
            font-size: 1.1em;
            line-height: 1.6;
        }
        #publicTestResultDisplay .btn {
            margin-top: 25px;
            width: auto;
            padding: 10px 30px;
            background: #007bff;
            color: white;
            text-align: center;
            text-decoration: none !important;
        }
        #publicTestResultDisplay .btn-secondary {
            background: #6c757d;
            text-align: center;
            text-decoration: none !important;
        }

        @media (max-width: 768px) {
            .dashboard {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                padding: 10px 0;
            }

            .sidebar ul {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                padding: 0 5px;
                gap: 5px 10px;
            }

            .sidebar li {
                white-space: nowrap;
                flex-grow: 1;
                text-align: center;
                padding: 8px 12px;
                border-radius: 5px;
                margin: 0;
            }

            /* Specific spacing adjustments for the first three items (Manage Appointments, Mental Health Tests, Health Records) */
            #patientSidebarNav li:nth-child(1),
            #patientSidebarNav li:nth-child(2),
            #patientSidebarNav li:nth-child(3) {
                margin-bottom: 10px;
            }

            /* To decrease space between Profile and Forms (last two items), ensure no extra bottom margin */
            #patientSidebarNav li:nth-child(4),
            #patientSidebarNav li:nth-child(5) {
                margin-bottom: 0;
            }

            .main-content {
                padding: 15px;
            }

            .container {
                margin: 5px;
                border-radius: 10px;
            }

            /* Mobile specific for login screen */
            .login-screen-wrapper {
                flex-direction: column;
                gap: 20px;
                padding: 10px;
            }
            .login-form-container, .public-access-container {
                width: 100%;
                padding: 20px;
                border-radius: 10px;
            }
            .public-access-buttons .btn {
                padding: 12px;
                font-size: 1em;
            }

            .section {
                padding: 15px;
                border-radius: 10px;
            }

            /* Specifically target external link buttons for stacking on mobile */
            .btn.external-link-btn {
                display: block;
                width: 100%;
                margin-right: 0;
                margin-bottom: 10px;
                padding: 12px;
                font-size: 15px;
            }
            /* Adjust for the last button in a series to not have extra bottom margin */
            .section .btn.external-link-btn:last-child {
                margin-bottom: 0;
            }

            .patient-data-buttons-container {
                flex-direction: column;
                gap: 10px;
            }
            .btn.view-patient-data-btn {
                width: 100%;
                margin-right: 0;
                font-size: 14px;
            }

            #calendar {
                padding: 5px;
            }
            .fc .fc-toolbar-title {
                font-size: 1em;
            }

            .public-test-selection .test-card {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="header-branding">
        <h1>HealMed Clinic</h1>
        <p>Let's heal minds</p>
    </div>
    <div class="container">
        <!-- Login Screen and Public Access Container -->
        <div id="welcomeScreenWrapper" class="login-screen-wrapper">
            <!-- Left Side: Login/Signup Forms -->
            <div id="loginFormsContainer" class="login-form-container">
                <!-- Login Screen -->
                <div id="loginScreen">
                    <div class="login-form">
                        <h2>Patient Portal Login</h2>
                        <div class="form-group">
                            <label for="loginEmail">Email:</label>
                            <input type="email" id="loginEmail" placeholder="Enter your email" required>
                        </div>
                        <div class="form-group">
                            <label for="loginPassword">Password:</label>
                            <input type="password" id="loginPassword" placeholder="Enter your password" required>
                        </div>
                        <button class="btn" id="loginBtn">Login</button>
                        <button class="btn btn-secondary" id="showSignupBtn">Create Account</button>
                        <button class="link-btn" id="showAdminLoginBtn">Staff Login</button>
                    </div>
                </div>

                <!-- Signup Screen -->
                <div id="signupScreen" class="hidden">
                    <div class="login-form">
                        <h2>Create Account</h2>
                        <div class="form-group">
                            <label for="signupName">Full Name:</label>
                            <input type="text" id="signupName" placeholder="Enter your full name" required>
                        </div>
                        <div class="form-group">
                            <label for="signupEmail">Email:</label>
                            <input type="email" id="signupEmail" placeholder="Enter your email" required>
                        </div>
                        <div class="form-group">
                            <label for="signupPassword">Password:</label>
                            <input type="password" id="signupPassword" placeholder="Create a password" required>
                        </div>
                        <div class="form-group">
                            <label for="signupDob">Date of Birth:</label>
                            <input type="date" id="signupDob" required>
                        </div>
                        <div class="form-group">
                            <label for="signupPhone">Phone Number:</label>
                            <input type="tel" id="signupPhone" placeholder="Enter your phone number" required>
                        </div>
                        <div class="form-group">
                            <label for="signupGender">Gender:</label>
                            <select id="signupGender" required>
                                <option value="">Select Gender</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other</option>
                                <option value="prefer-not-to-say">Prefer not to say</option>
                            </select>
                        </div>
                        <button class="btn" id="signupBtn">Create Account</button>
                        <button class="link-btn" id="backToLoginBtn">Back to Login</button>
                    </div>
                </div>

                <!-- Admin Login Screen -->
                <div id="adminLoginScreen" class="hidden">
                    <div class="login-form">
                        <h2>Staff Login</h2>
                        <div class="form-group">
                            <label for="adminEmail">Email:</label>
                            <input type="email" id="adminEmail" placeholder="Enter admin email" required>
                        </div>
                        <div class="form-group">
                            <label for="adminPassword">Password:</label>
                            <input type="password" id="adminPassword" placeholder="Enter password" required>
                        </div>
                        <button class="btn" id="adminLoginBtn">Login</button>
                        <button class="link-btn" id="backToPatientLoginBtn">Back to Patient Login</button>
                    </div>
                </div>
            </div> <!-- End loginFormsContainer -->

            <!-- Right Side: Public Access Buttons -->
            <div class="public-access-container">
                <h2>Quick Access</h2>
                <div class="public-access-buttons">
                    <button class="btn" id="publicTmsQuestionnaireBtn">TMS Daily Questionnaire</button>
                    <button class="btn" id="publicMentalHealthTestsBtn">Mental Health Tests</button>
                    <!-- MOVED: New Patient Form now in Quick Access -->
                    <a href="https://www.jotform.com/sign/251304457972056/invite/01jtzza5kqcb83f96f3923b7ac" target="_blank" class="btn">New Patient Form</a>
                    <a href="https://v-gedipudi1.github.io/consent-forms/" target="_blank" class="btn">TMS Consent Form</a>
                    <a href="https://docs.google.com/forms/d/e/1FAIpQLScOt3ov7drpfVaJ3GPPa3GyyEG4i3qErkgpz704BUxhGItg6Q/viewform?usp=header" target="_blank" class="btn">Upload ID and Insurance Form</a>
                </div>
                <div class="info-box">
                    <p><strong>First-time patient?</strong> To book an appointment, please create an account first and then navigate to the "Manage Appointments" tab.</p>
                </div>
                <div class="info-box" style="margin-top: 10px;">
                    <p><strong>Want to track your mental health progress?</strong> Create an account to securely view your mental health test results, past TMS questionnaires, and manage your appointments.</p>
                </div>
            </div>
        </div> <!-- End welcomeScreenWrapper -->

        <!-- NEW: Public Mental Health Test Selection Screen (initially hidden) -->
        <div id="publicMentalHealthTestsSection" class="section public-test-selection hidden">
            <h2>Select a Mental Health Test</h2>
            <div class="test-card" data-test-type="depression">
                <h3>Depression Screening (PHQ-9)</h3>
                <p>Take a self-assessment to screen for depression symptoms</p>
            </div>
            <div class="test-card" data-test-type="anxiety">
                <h3>Anxiety Screening (GAD-7)</h3>
                <p>Take a self-assessment to screen for anxiety symptoms</p>
            </div>
            <div class="test-card" data-test-type="adhd">
                <h3>ADHD Screening</h3>
                <p>Take a self-assessment to screen for ADHD symptoms</p>
            </div>
            <button class="btn btn-back" id="backToPublicAccessBtn">Back to Main Screen</button>
        </div>

        <!-- TEST INTERFACE: MOVED HERE, OUTSIDE DASHBOARD -->
        <div id="testInterface" class="section hidden">
            <h2 id="testTitle"></h2>
            <!-- NEW: Full Name field for public tests -->
            <div id="publicTestNameField" class="form-group hidden">
                <label for="publicTestFullName">Your Full Name:</label>
                <input type="text" id="publicTestFullName" placeholder="Enter your full name" required>
            </div>
            <div id="testQuestions"></div>
            <button class="btn" id="submitTestBtn">Submit Test</button>
            <button class="btn btn-secondary" id="cancelTestBtn">Cancel</button>
            <!-- Public test result display will appear here -->
            <div id="publicTestResultDisplay" class="hidden"></div>
        </div>

        <!-- TMS DAILY QUESTIONNAIRE SECTION: MOVED HERE, OUTSIDE DASHBOARD -->
        <div id="tmsQuestionnaireSection" class="section hidden">
            <h2>TMS Daily Questionnaire</h2>
            <p>Please fill out the following information and questions.</p>
            <div class="form-group">
                <label for="tmsFullName">Full Name:</label>
                <input type="text" id="tmsFullName" placeholder="Your full name" required>
            </div>
            <div class="form-group">
                <label for="tmsEmail">Email:</label>
                <input type="email" id="tmsEmail" placeholder="Your email" required>
            </div>
            <div class="form-group">
                <label for="tmsPhone">Phone Number:</label>
                <input type="tel" id="tmsPhone" placeholder="Your phone number" required>
            </div>
            <hr style="margin: 30px 0; border: 0; border-top: 1px solid #ccc;">

            <div class="form-group">
                <label>1. Have you had anything to eat or drink today?</label>
                <div class="radio-group-inline">
                    <label class="radio-option-inline"><input type="radio" name="q1_eat_drink" value="yes" required> Yes</label>
                    <label class="radio-option-inline"><input type="radio" name="q1_eat_drink" value="no"> No</label>
                </div>
                <div id="q1_followup" class="follow-up-question hidden">
                    <label for="q1_eat_drink_details">What did you have to eat or drink?</label>
                    <textarea id="q1_eat_drink_details"></textarea>
                </div>
            </div>

            <div class="form-group">
                <label>3. Have you been taking your medication as prescribed and at the same time?</label>
                <div class="radio-group-inline">
                    <label class="radio-option-inline"><input type="radio" name="q2_med_prescribed" value="yes" required> Yes</label>
                    <label class="radio-option-inline"><input type="radio" name="q2_med_prescribed" value="no"> No</label>
                </div>
                <div id="q2_followup" class="follow-up-question hidden">
                    <label>3a. Any changes to your medication?</label>
                    <div class="radio-group-inline">
                        <label class="radio-option-inline"><input type="radio" name="q2a_med_changes" value="yes" required> Yes</label>
                        <label class="radio-option-inline"><input type="radio" name="q2a_med_changes" value="no"> No</label>
                    </div>
                    <div id="q2a_followup" class="follow-up-question hidden">
                        <label for="q2a_med_changes_details">Please specify changes to your medication:</label>
                        <textarea id="q2a_med_changes_details"></textarea>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="q3_sleep_hours">4. How did you sleep last night? Number of hours?</label>
                <input type="text" id="q3_sleep_hours" min="0" max="24" placeholder="Enter hours" required>
            </div>

            <div class="form-group">
                <label>5. Any caffeine intake today?</label>
                <div class="radio-group-inline">
                    <label class="radio-option-inline"><input type="radio" name="q4_caffeine" value="yes" required> Yes</label>
                    <label class="radio-option-inline"><input type="radio" name="q4_caffeine" value="no"> No</label>
                </div>
                <div id="q4_followup" class="follow-up-question hidden">
                    <label for="q4_caffeine_details">What caffeine drink did you have or how many?</label>
                    <textarea id="q4_caffeine_details"></textarea>
                </div>
            </div>

            <div class="form-group">
                <label>6. Any alcohol intake today?</label>
                <div class="radio-group-inline">
                    <label class="radio-option-inline"><input type="radio" name="q5_alcohol" value="yes" required> Yes</label>
                    <label class="radio-option-inline"><input type="radio" name="q5_alcohol" value="no"> No</label>
                </div>
                <div id="q5_followup" class="follow-up-question hidden">
                    <label for="q5_alcohol_details">How much alcohol?</label>
                    <textarea id="q5_alcohol_details"></textarea>
                </div>
            </div>

            <div class="form-group">
                <label>2. Have you consumed any substances that were NOT prescribed by any physicians today?</label>
                <div class="radio-group-inline">
                    <label class="radio-option-inline"><input type="radio" name="q_unprescribed_substance" value="yes" required> Yes</label> <!-- Changed name to avoid conflict -->
                    <label class="radio-option-inline"><input type="radio" name="q_unprescribed_substance" value="no"> No</label>
                </div>
            </div>

            <div class="form-group">
                <label>7. Do you have any metal in or around your head (above the collar)?</label>
                <div class="radio-group-inline">
                    <label class="radio-option-inline"><input type="radio" name="q6_metal_head" value="yes" required> Yes</label>
                    <label class="radio-option-inline"><input type="radio" name="q6_metal_head" value="no"> No</label>
                </div>
                <div id="q6_followup" class="follow-up-question hidden">
                    <label for="q6_metal_head_details">Please specify (e.g., dental implants, surgical clips, shrapnel, etc.):</label>
                    <textarea id="q6_metal_head_details"></textarea>
                </div>
            </div>

            <button class="btn" id="submitTmsQuestionnaireBtn">Submit Questionnaire</button>
            <button class="btn btn-secondary" id="cancelTmsQuestionnaireBtn">Cancel</button>
        </div>

        <!-- Patient Dashboard -->
        <div id="patientDashboard" class="dashboard hidden">
            <button class="logout-btn" id="patientLogoutBtn">Logout</button>
            <div class="sidebar">
                <h3>Patient Portal</h3>
                <ul id="patientSidebarNav">
                    <li class="active" data-section="appointments">Manage Appointments</li>
                    <li data-section="mentalHealth">Mental Health Tests</li>
                    <li data-section="healthRecords">Health Records</li>
                    <li data-section="profile">Profile</li>
                    <li data-section="forms">Forms</li>
                </ul>
            </div>
            <div class="main-content">
                <!-- Appointments Section -->
                <div id="appointmentsSection" class="section">
                    <h2>Manage Appointments</h2>
                    <div id="appointmentsList"></div>
                    <button class="btn" id="showBookingFormBtn">Book New Appointment</button>

                    <!-- Booking Form (Updated to include date picker and DOB) -->
                    <div id="bookingForm" class="hidden" style="margin-top: 20px; background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <h3>Book New Appointment</h3>
                        <div class="form-group">
                            <label for="bookApptDob">Your Date of Birth:</label>
                            <input type="date" id="bookApptDob" required>
                        </div>
                        <div class="form-group">
                            <label for="appointmentDate">Preferred Date:</label>
                            <input type="date" id="appointmentDate" required>
                        </div>
                        <div class="form-group">
                            <label for="appointmentTime">Preferred Appointment Time:</label>
                            <select id="appointmentTime" required>
                                <option value="">Select Time</option>
                                <option value="09:00">09:00 AM</option>
                                <option value="10:00">10:00 AM</option>
                                <option value="11:00">11:00 AM</option>
                                <option value="12:00">12:00 PM</option>
                                <option value="13:00">01:00 PM</option>
                                <option value="14:00">02:00 PM</option>
                                <option value="15:00">03:00 PM</option>
                                <option value="16:00">04:00 PM</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="appointmentReason">Reason for Visit:</label>
                            <textarea id="appointmentReason" placeholder="Please describe the reason for your visit" required></textarea>
                        </div>
                        <button class="btn" id="submitAppointmentRequestBtn">Submit Request</button>
                        <button class="btn btn-secondary" id="hideBookingFormBtn">Cancel</button>
                    </div>
                </div>

                <!-- Mental Health Tests Section -->
                <div id="mentalHealthSection" class="section hidden">
                    <h2>Mental Health Tests</h2>
                    <div class="test-card" data-test-type="depression">
                        <h3>Depression Screening (PHQ-9)</h3>
                        <p>Take a self-assessment to screen for depression symptoms</p>
                    </div>
                    <div class="test-card" data-test-type="anxiety">
                        <h3>Anxiety Screening (GAD-7)</h3>
                        <p>Take a self-assessment to screen for anxiety symptoms</p>
                    </div>
                    <div class="test-card" data-test-type="adhd">
                        <h3>ADHD Screening</h3>
                        <p>Take a self-assessment to screen for ADHD symptoms</p>
                    </div>
                    <h4>Your Past Test Results:</h4>
                    <div id="testResultsList"></div>
                </div>

                <!-- Health Records Section -->
                <div id="healthRecordsSection" class="section hidden">
                    <h2>Health Records</h2>
                    <p>Your health records and medical history will be displayed here.</p>
                    <div id="healthRecordsList"></div>
                </div>

                <!-- Profile Section -->
                <div id="profileSection" class="section hidden">
                    <h2>Profile</h2>
                    <div id="profileInfo"></div>
                </div>

                <!-- Patient Forms Section (Updated with TMS Daily Questionnaire) -->
                <div id="formsSection" class="section hidden">
                    <h2>Forms</h2>
                    <p>Please review and complete any necessary forms below.</p>
                    <button class="btn" id="showTmsQuestionnaireBtnLoggedIn" style="margin-top: 15px;">TMS Daily Questionnaire (Logged In)</button>
                    <!-- New Patient Form is now a direct link here -->
                    <a href="https://www.jotform.com/sign/251304457972056/invite/01jtzza5kqcb83f96f3923b7ac" target="_blank" class="btn external-link-btn">New Patient Form</a>
                    <a href="https://v-gedipudi1.github.io/consent-forms/" target="_blank" class="btn external-link-btn">TMS Consent Form</a>
                    <a href="https://docs.google.com/forms/d/e/1FAIpQLScOt3ov7drpfVaJ3GPPa3GyyEG4i3qErkgpz704BUxhGItg6Q/viewform?usp=header" target="_blank" class="btn external-link-btn">Upload ID and Insurance Form</a>
                </div>

            </div>
        </div>

        <!-- Admin Dashboard -->
        <div id="adminDashboard" class="dashboard hidden">
            <button class="logout-btn" id="adminLogoutBtn">Logout</button>
            <div class="sidebar">
                <h3>Admin Portal</h3>
                <ul id="adminSidebarNav">
                    <li class="active" data-section="appointments">Appointment Requests</li>
                    <li data-section="patients">Patient Management</li>
                    <li data-section="tmsSubmissions">View All TMS Submissions</li>
                    <li data-section="publicTestResults">Public Test Results</li> <!-- NEW ADMIN SIDEBAR ITEM -->
                    <li data-section="calendar">Calendar</li>
                    <li data-section="doctorPortal">Doctor Portal</li>
                </ul>
            </div>
            <div class="main-content">
                <!-- Admin Appointments Section -->
                <div id="adminAppointmentsSection" class="section">
                    <h2 id="adminAppointmentsTitle">Appointment Requests</h2>
                    <div id="adminPendingAppointmentsList"></div>
                </div>

                <!-- Admin Patients Section -->
                <div id="adminPatientsSection" class="section">
                    <h2>Patient Management</h2>
                    <button class="btn" id="showAddPatientFormBtn">Add New Patient (via Admin)</button>
                    
                    <!-- List of patient buttons -->
                    <div id="patientsList" class="patient-list-container"></div>

                    <!-- Patient Detail View (Initially Hidden) -->
                    <div id="patientDetailView" class="hidden">
                        <button class="btn btn-secondary" id="backToPatientsListBtn" style="margin-bottom: 20px;">Back to All Patients</button>
                        <h3>Patient Details: <span id="patientDetailName"></span></h3>
                        <div id="patientBasicInfo"></div>
                        <div class="patient-data-buttons-container">
                            <button class="btn view-patient-data-btn" id="viewPatientMentalHealthResultsBtn">View Mental Health Test Results</button>
                            <button class="btn view-patient-data-btn" id="viewPatientTmsQuestionnairesBtn">View TMS Daily Questionnaires</button>
                            <button class="btn view-patient-data-btn booked-appointments" id="viewPatientBookedAppointmentsBtn">View Booked Appointments</button>
                        </div>
                        <div id="patientSpecificDataResults" style="margin-top: 20px;"></div>
                    </div>

                    <!-- Add Patient Form -->
                    <div id="addPatientForm" class="hidden" style="margin-top: 20px; background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <h3>Add New Patient</h3>
                        <div class="form-group">
                            <label for="newPatientName">Full Name:</label>
                            <input type="text" id="newPatientName" required>
                        </div>
                        <div class="form-group">
                            <label for="newPatientEmail">Email:</label>
                            <input type="email" id="newPatientEmail" required>
                        </div>
                        <div class="form-group">
                            <label for="newPatientPassword">Password:</label>
                            <input type="password" id="newPatientPassword" required>
                        </div>
                        <div class="form-group">
                            <label for="newPatientDob">Date of Birth:</label>
                            <input type="date" id="newPatientDob" required>
                        </div>
                        <div class="form-group">
                            <label for="newPatientPhone">Phone:</label>
                            <input type="tel" id="newPatientPhone" required>
                        </div>
                        <div class="form-group">
                            <label for="newPatientGender">Gender:</label>
                            <select id="newPatientGender" required>
                                <option value="">Select Gender</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other</option>
                                <option value="prefer-not-to-say">Prefer not to say</option>
                            </select>
                        </div>
                        <button class="btn" id="addPatientBtn">Add Patient</button>
                        <button class="btn btn-secondary" id="hideAddPatientFormBtn">Cancel</button>
                    </div>
                </div>

                <!-- New Admin TMS Submissions Section -->
                <div id="adminTmsSubmissionsSection" class="section hidden">
                    <h2>All TMS Daily Questionnaires</h2>
                    <div id="tmsSubmissionsList">
                        <p>Loading TMS submissions...</p>
                    </div>
                </div>

                <!-- NEW ADMIN PUBLIC TEST RESULTS SECTION -->
                <div id="adminPublicTestResultsSection" class="section hidden">
                    <h2>All Mental Health Test Results</h2>
                    <div id="publicTestResultsList">
                        <p>Loading mental health test results...</p>
                    </div>
                </div>

                <!-- Admin Calendar Section (Updated for FullCalendar) -->
                <div id="adminCalendarSection" class="section hidden">
                    <h2>Approved Appointments Calendar</h2>
                    <div id="calendar"></div> <!-- FullCalendar will render here -->
                </div>

                <!-- Admin Doctor Portal Section -->
                <div id="adminDoctorPortalSection" class="section hidden">
                    <h2>Doctor Portal</h2>
                    <p>Access the specialized doctor's interface here.</p>
                    <a href="https://v-gedipudi1.github.io/consent-forms/doctor_portal.html" target="_blank" class="btn external-link-btn">Access Doctor Portal</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for displaying FullCalendar event details -->
    <div id="eventDetailsModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button" id="closeModalBtn">&times;</span>
            <h3 id="modalEventTitle"></h3>
            <p><strong>Patient:</strong> <span id="modalPatientName"></span></p>
            <p><strong>Email:</strong> <span id="modalPatientEmail"></span></p>
            <p><strong>Phone:</strong> <span id="modalPatientPhone"></span></p>
            <p><strong>Date & Time:</strong> <span id="modalEventDateTime"></span></p>
            <p><strong>Date of Birth:</strong> <span id="modalEventDob"></span></p>
            <p><strong>Reason:</strong> <span id="modalEventReason"></span></p>
            <p><strong>Status:</strong> <span id="modalEventStatus"></span></p>
        </div>
    </div>

    <!-- Modal for displaying full TMS questionnaire details (Admin side) -->
    <div id="tmsDetailModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button" id="closeTmsModalBtn">&times;</span>
            <h3 id="tmsModalTitle">TMS Questionnaire from <span id="tmsModalPatientName"></span></h3>
            <p><strong>Email:</strong> <span id="tmsModalPatientEmail"></span></p>
            <p><strong>Phone:</strong> <span id="tmsModalPatientPhone"></span></p>
            <p><strong>Submitted On:</strong> <span id="tmsModalSubmittedAt"></span></p>
            <hr>
            <div id="tmsModalAnswers"></div>
            <hr>
            <button class="btn" id="moveTmsToPatientBtn" style="margin-top: 15px;">Move to Patient Account</button>
            <div id="assignTmsToPatientSection" class="form-group hidden" style="margin-top: 20px;">
                <label for="tmsPatientSelectDropdown">Assign to Patient:</label>
                <select id="tmsPatientSelectDropdown" style="width: 100%; padding: 10px; border-radius: 5px; margin-bottom: 10px;"></select>
                <button class="btn" id="confirmTmsAssignmentBtn" style="width: 100%;">Confirm Assignment</button>
            </div>
        </div>
    </div>

    <!-- NEW: Modal for displaying full Public Test submission details (Admin side) -->
    <div id="publicTestDetailModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button" id="closePublicTestModalBtn">&times;</span>
            <h3 id="publicTestModalTitle">Mental Health Test Submission (<span id="publicTestModalType"></span>)</h3>
            <p><strong>Submitted By:</strong> <span id="publicTestModalSubmitter"></span></p>
            <p><strong>Email:</strong> <span id="publicTestModalSubmitterEmail"></span></p>
            <p><strong>Phone:</strong> <span id="publicTestModalSubmitterPhone"></span></p>
            <p><strong>Score:</strong> <span id="publicTestModalScore"></span></p>
            <p><strong>Breakdown:</strong> <span id="publicTestModalBreakdown"></span></p>
            <p><strong>Submitted On:</strong> <span id="publicTestModalSubmittedAt"></span></p>
            <hr>
            <div id="publicTestModalAnswers"></div>
            <hr>
            <button class="btn" id="movePublicTestToPatientBtn" style="margin-top: 15px;">Move to Patient Account</button>
            <div id="assignPublicTestToPatientSection" class="form-group hidden" style="margin-top: 20px;">
                <label for="publicTestPatientSelectDropdown">Assign to Patient:</label>
                <select id="publicTestPatientSelectDropdown" style="width: 100%; padding: 10px; border-radius: 5px; margin-bottom: 10px;"></select>
                <button class="btn" id="confirmPublicTestAssignmentBtn" style="width: 100%;">Confirm Assignment</button>
            </div>
        </div>
    </div>

    <!-- NEW: Custom Confirmation Modal HTML -->
    <!-- This modal will be dynamically inserted by showConfirmationModal JS function -->


    <!-- FullCalendar JavaScript (Must be loaded AFTER the DOM elements) -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

    <script type="module">
        // --- Firebase Configuration (YOUR ACTUAL KEYS) ---
        const firebaseConfig = {
            apiKey: "AIzaSyD440QOEKOT3oRUORipguPtttraawzPGgs",
            authDomain: "healmed-portal-backend.firebaseapp.com",
            projectId: "healmed-portal-backend",
            storageBucket: "healmed-portal-backend.firebasestorage.app",
            messagingSenderId: "979152928801",
            appId: "1:979152928801:web:2e5dbbd801732a4e44e360",
            measurementId: "G-1MKT9TNCJ5",
            databaseURL: "https://healmed-portal-backend-default-rtdb.firebaseio.com"
        };

        // --- Firebase SDK v9 Modular Imports from CDN ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, deleteUser } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, update, remove, get } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-analytics.js";

        // --- Initialize Firebase Services ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        const analytics = getAnalytics(app);

        // --- Global State Variables ---
        let currentUser = null; // Stores current Firebase authenticated user object
        let isAdmin = false; // Flag for admin status (set after successful Firebase admin login)
        let currentTest = null; // Stores details of the test currently being taken
        let adminCalendarInstance = null; // To hold the FullCalendar object for the admin portal
        let currentPatientIdInAdminView = null; // To track which patient is currently being viewed by admin
        let isPublicTestMode = false; // Flag to indicate if currently taking a public test
        let allPatientsData = []; // To store a list of all patients for dropdowns

        // --- Admin Credentials (Email must exist in Firebase Authentication) ---
        const ADMIN_EMAIL = 'admin@healmed.com'; // Use the email you created in Firebase Auth
        const ADMIN_PASSWORD_REFERENCE = 'healthcare2024'; // For clarity, we refer to it.

        // --- Mental Health Test Questions and Scoring ---
        const testQuestions = {
            depression: {
                title: 'Depression Screening (PHQ-9)',
                questions: [
                    'Little interest or pleasure in doing things',
                    'Feeling down, depressed, or hopeless',
                    'Trouble falling or staying asleep, or sleeping too much',
                    'Feeling tired or having little energy',
                    'Poor appetite or overeating',
                    'Feeling bad about yourself — or that you are a failure or have let yourself or your family down',
                    'Trouble concentrating on things, such as reading the newspaper or watching television',
                    'Moving or speaking so slowly that other people could have noticed. Or the opposite — being so fidgety or restless that you have been moving around a lot more than usual',
                    'Thoughts that you would be better off dead, or of hurting yourself in any way'
                ],
                options: [
                    { text: 'Not at all', value: 0 },
                    { text: 'Several days', value: 1 },
                    { text: 'More than half the days', value: 2 },
                    { text: 'Nearly every day', value: 3 }
                ],
                scoring: {
                    ranges: [
                        { min: 0, max: 4, level: 'Minimal', description: 'Minimal depression symptoms. No treatment is warranted at this time.' },
                        { min: 5, max: 9, level: 'Mild', description: 'Mild depression symptoms. Watchful waiting; repeat PHQ-9 at follow-up.' },
                        { min: 10, max: 14, level: 'Moderate', description: 'Moderate depression symptoms. Treatment plan, considering counseling, follow-up and/or pharmacotherapy.' },
                        { min: 15, max: 19, level: 'Moderately Severe', description: 'Moderately severe depression symptoms. Active treatment with pharmacotherapy and/or psychotherapy.' },
                        { min: 20, max: 27, level: 'Severe', description: 'Severe depression symptoms. Immediate initiation of pharmacotherapy and, if severe impairment or poor response to therapy, expedited referral to a mental health specialist for psychotherapy and/or collaborative management.' }
                    ]
                },
                getBreakdown: (score) => {
                    for (const range of testQuestions.depression.scoring.ranges) {
                        if (score >= range.min && score <= range.max) {
                            return range.description;
                        }
                    }
                    return 'N/A';
                }
            },
            anxiety: {
                title: 'Anxiety Screening (GAD-7)',
                questions: [
                    'Feeling nervous, anxious, or on edge',
                    'Not being able to stop or control worrying',
                    'Worrying too much about different things',
                    'Trouble relaxing',
                    'Being so restless that it is hard to sit still',
                    'Becoming easily annoyed or irritable',
                    'Feeling afraid, as if something awful might happen'
                ],
                options: [
                    { text: 'Not at all', value: 0 },
                    { text: 'Several days', value: 1 },
                    { text: 'More than half the days', value: 2 },
                    { text: 'Nearly every day', value: 3 }
                ],
                scoring: {
                    ranges: [
                        { min: 0, max: 4, level: 'Minimal', description: 'Minimal anxiety symptoms. No follow-up is warranted at this time.' },
                        { min: 5, max: 9, level: 'Mild', description: 'Mild anxiety symptoms. It is recommended to monitor symptoms and follow-up as indicated.' },
                        { min: 10, max: 14, level: 'Moderate', description: 'Moderate anxiety symptoms. Likely to be diagnosed with an anxiety or related disorder. Symptoms are clinically significant and warrant further assessment and/or referral to a mental health professional.' },
                        { min: 15, max: 21, level: 'Severe', description: 'Severe anxiety symptoms. Symptoms likely warrant active treatment. Likely to be diagnosed with an anxiety or related disorder. Further assessment and/or referral to a mental health professional is recommended.' }
                    ]
                },
                getBreakdown: (score) => {
                    for (const range of testQuestions.anxiety.scoring.ranges) {
                        if (score >= range.min && score <= range.max) {
                            return range.description;
                        }
                    }
                    return 'N/A';
                }
            },
            adhd: {
                title: 'ADHD Screening (ASRS-v1.1)',
                questions: [
                    // Part A (Highly predictive, questions 1-6)
                    'How often do you have trouble wrapping up the final details of a project, once the challenging parts have been done?', // 1
                    'How often do you have difficulty getting things in order when you have to do a task that requires organization?', // 2
                    'How often do you have problems remembering appointments or obligations?', // 3
                    'When you have a task that requires a lot of thought, how often do you avoid or delay getting started?', // 4
                    'How often do you fidget or squirm with your hands or feet when you have to sit down for a long time?', // 5
                    'How often do you feel overly active and compelled to do things, like you were driven by a motor?', // 6
                    // Part B (Additional symptoms, questions 7-18)
                    'How often do you make careless mistakes when you have to work on a boring or difficult project?', // 7
                    'How often do you have difficulty keeping your attention when you are doing boring or repetitive work?', // 8
                    'How often do you have difficulty concentrating on what people say to you, even when they are speaking to you directly?', // 9
                    'How often do you misplace or have difficulty finding things at home or at work?', // 10
                    'How often are you distracted by activity or noise around you?', // 11
                    'How often do you leave your seat in meetings or other situations in which you are expected to remain seated?', // 12
                    'How often do you feel restless or fidgety?', // 13
                    'How often do you have difficulty unwinding and relaxing when you have time to yourself?', // 14
                    'How often do you find yourself talking too much when you are in social situations?', // 15
                    'When you\'re in a conversation, how often do you find yourself finishing the sentences of the people you are talking to, before they can finish them themselves?', // 16
                    'How often do you have difficulty waiting your turn in situations when turn taking is required?', // 17
                    'How often do you interrupt others when they are busy?' // 18
                ],
                options: [
                    { text: 'Never', value: 0 },
                    { text: 'Rarely', value: 1 },
                    { text: 'Sometimes', value: 2 },
                    { text: 'Often', value: 3 },
                    { text: 'Very Often', value: 4 }
                ],
                // ASRS specific scoring logic
                scoring: {
                    // This is not a simple total score range, but a specific rule for Part A
                    // And then general total score ranges for severity.
                    partA_questions_indices: [0, 1, 2, 3, 4, 5], // Indices of questions in Part A (first 6)
                    partA_high_risk_threshold_count: 4, // 4 or more answers in 'Often' or 'Very Often' in Part A
                    partA_high_risk_values: [3, 4], // Values for 'Often' and 'Very Often'

                    total_score_ranges: [
                        { min: 0, max: 30, level: 'Low Likelihood', description: 'Your responses suggest a low likelihood of ADHD symptoms. If concerns persist, consider consulting a healthcare professional.' },
                        { min: 31, max: 39, level: 'Mild to Moderate Likelihood', description: 'Your responses suggest a mild to moderate likelihood of ADHD symptoms. Further assessment by a healthcare professional is recommended for a definitive diagnosis.' },
                        { min: 40, max: 49, level: 'High Likelihood', description: 'Your responses suggest a high likelihood of ADHD symptoms. It is strongly recommended to seek further evaluation from a mental health specialist.' },
                        { min: 50, max: 72, level: 'Very High Likelihood', description: 'Your responses suggest a very high likelihood of ADHD symptoms, consistent with a clinical diagnosis. Immediate consultation with a mental health specialist is highly recommended for comprehensive assessment and support.' }
                    ]
                },
                getBreakdown: (score, answersArray) => {
                    let partA_high_risk_count = 0;
                    testQuestions.adhd.scoring.partA_questions_indices.forEach(index => {
                        const answerValue = answersArray[index].score; // Score of the selected option for this question
                        if (testQuestions.adhd.scoring.partA_high_risk_values.includes(answerValue)) {
                            partA_high_risk_count++;
                        }
                    });

                    let initialScreeningResult = '';
                    if (partA_high_risk_count >= testQuestions.adhd.scoring.partA_high_risk_threshold_count) {
                        initialScreeningResult = 'Symptoms highly consistent with ADHD in adults based on Part A. Further investigation is warranted. ';
                    } else {
                        initialScreeningResult = 'Part A results do not strongly indicate ADHD on their own. ';
                    }

                    let totalScoreEvaluation = '';
                    for (const range of testQuestions.adhd.scoring.total_score_ranges) {
                        if (score >= range.min && score <= range.max) {
                            totalScoreEvaluation = range.description;
                            break;
                        }
                    }

                    return `${initialScreeningResult} Overall, based on your total score: ${totalScoreEvaluation}`;
                }
            }
        };

        // --- Helper Functions for UI and Messages ---
        function showMessage(message, isError = false) {
            // Using a custom modal instead of alert for better UX
            const messageType = isError ? 'Error' : 'Info';
            const modalHtml = `
                <div id="messageModal" class="modal">
                    <div class="modal-content">
                        <span class="close-button" id="messageModalCloseBtn">&times;</span>
                        <h3>${messageType}</h3>
                        <p>${message}</p>
                        <button class="btn" id="messageModalOkBtn" style="margin-top: 20px; width: 100%;">OK</button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            const modal = document.getElementById('messageModal');
            const closeBtn = document.getElementById('messageModalCloseBtn');
            const okBtn = document.getElementById('messageModalOkBtn');

            const cleanup = () => {
                modal.remove();
            };

            closeBtn.onclick = cleanup;
            okBtn.onclick = cleanup;
            modal.onclick = (event) => {
                if (event.target === modal) {
                    cleanup();
                }
            };
        }

        // NEW: Custom Confirmation Modal (replaces alert/confirm for better UX)
        function showConfirmationModal(message, onConfirm, onCancel) {
            const modalHtml = `
                <div id="customConfirmModal" class="modal">
                    <div class="modal-content">
                        <span class="close-button" id="customConfirmCloseBtn">&times;</span>
                        <h3>Confirmation</h3>
                        <p>${message}</p>
                        <div style="display: flex; justify-content: space-around; margin-top: 20px;">
                            <button class="btn" id="customConfirmYesBtn" style="width: 45%; background: #27ae60;">Yes</button>
                            <button class="btn btn-secondary" id="customConfirmNoBtn" style="width: 45%;">No</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            const modal = document.getElementById('customConfirmModal');
            const closeBtn = document.getElementById('customConfirmCloseBtn');
            const yesBtn = document.getElementById('customConfirmYesBtn');
            const noBtn = document.getElementById('customConfirmNoBtn');

            const cleanup = () => {
                modal.remove();
            };

            closeBtn.onclick = () => {
                cleanup();
                if (onCancel) onCancel();
            };
            yesBtn.onclick = () => {
                cleanup();
                if (onConfirm) onConfirm();
            };
            noBtn.onclick = () => {
                cleanup();
                if (onCancel) onCancel();
            };

            // Close if clicked outside
            modal.onclick = (event) => {
                if (event.target === modal) {
                    cleanup();
                    if (onCancel) onCancel();
                }
            };
        }

        // Modified to hide the new wrapper AND public test section
        function hideAllScreens() {
            document.getElementById('welcomeScreenWrapper').classList.add('hidden');
            document.getElementById('patientDashboard').classList.add('hidden');
            document.getElementById('adminDashboard').classList.add('hidden');
            document.getElementById('publicMentalHealthTestsSection').classList.add('hidden'); // NEW: Hide public test selection
            document.getElementById('tmsQuestionnaireSection').classList.add('hidden'); // Ensure TMS questionnaire is hidden
            document.getElementById('testInterface').classList.add('hidden'); // Ensure test interface is hidden
        }

        // --- Authentication Functions (Firebase Integrated) ---

        // Patient Login
        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showMessage('Please enter both email and password', true);
                return;
            }

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                currentUser = userCredential.user;
                isAdmin = false; // Ensure admin flag is false for patient login
                console.log("Patient login successful for UID:", currentUser.uid);
                showMessage('Patient login successful!');
                showPatientDashboard();
            }
            catch (error) {
                console.error("Login failed:", error);
                showMessage(`Login failed: ${error.message}`, true);
            }
        }

        // Admin Login (NOW using Firebase Auth)
        async function adminLogin() {
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;

            if (!email || !password) {
                showMessage('Please enter both email and password for admin login', true);
                return;
            }

            try {
                // IMPORTANT: Sign in the admin with Firebase Authentication
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                currentUser = userCredential.user;
                
                // Confirm it's the expected admin user
                if (email === ADMIN_EMAIL) {
                    sessionStorage.setItem('isAdminLoggedIn', 'true'); // Keep this for session tracking
                    isAdmin = true;
                    console.log("Admin login successful via Firebase Auth. UID:", currentUser.uid);
                    showMessage('Admin login successful!');
                    showAdminDashboard();
                } else {
                    console.error("Admin: A Firebase user logged in, but not the designated admin email.");
                    showMessage('Admin login failed: Invalid admin credentials.', true);
                    await signOut(auth); // Sign out the unexpected user
                    sessionStorage.removeItem('isAdminLoggedIn');
                    isAdmin = false;
                }

            } catch (error) {
                console.error("Admin login failed:", error);
                showMessage(`Admin login failed: ${error.message}`, true);
                sessionStorage.removeItem('isAdminLoggedIn');
                isAdmin = false;
            }
        }

        // Patient Signup
        async function signup() {
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const dob = document.getElementById('signupDob').value; // Get Date of Birth
            const phone = document.getElementById('signupPhone').value;
            const gender = document.getElementById('signupGender').value;

            if (!name || !email || !password || !dob || !phone || !gender) {
                showMessage('Please fill in all fields', true);
                return;
            }
            if (password.length < 6) {
                showMessage('Password must be at least 6 characters long.', true);
                return;
            }

            try {
                console.log("Attempting to create user with email:", email);
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const userId = userCredential.user.uid;
                console.log("User created in Firebase Auth with UID:", userId);

                await set(ref(database, 'patients/' + userId), {
                    fullName: name,
                    email: email,
                    phoneNumber: phone,
                    dob: dob, // Save Date of Birth
                    gender: gender,
                    createdAt: new Date().toISOString()
                });
                console.log("Patient data saved to Realtime Database for UID:", userId);

                showMessage('Account created successfully! Please login.');
                showLoginScreenLayout(); // Show the full login layout
                showLogin(); // Then ensure the login form itself is visible
            } catch (error) {
                console.error("Firebase Auth Error during signup:", error);
                showMessage(`Error creating account: ${error.message}`, true);
            }
        }

        // Logout
        async function logout() {
            try {
                await signOut(auth);
                console.log("Firebase Auth user signed out.");
            } catch (error) {
                console.error("Firebase Auth signOut failed:", error);
            }
            sessionStorage.removeItem('isAdminLoggedIn');
            isAdmin = false;
            currentUser = null;
            console.log("Local state cleared. User logged out.");
            showMessage('Logged out successfully.');
            showLoginScreenLayout(); // Show the full login layout
            showLogin(); // Then ensure the login form itself is visible
        }

        // --- UI Navigation Functions ---

        // NEW: Function to show the entire two-column login screen layout
        function showLoginScreenLayout() {
            document.getElementById('welcomeScreenWrapper').classList.remove('hidden');
            document.getElementById('patientDashboard').classList.add('hidden');
            document.getElementById('adminDashboard').classList.add('hidden');
            document.getElementById('publicMentalHealthTestsSection').classList.add('hidden'); // Ensure public test selection is hidden
            document.getElementById('tmsQuestionnaireSection').classList.add('hidden'); // Ensure TMS questionnaire is hidden
            document.getElementById('testInterface').classList.add('hidden'); // Ensure test interface is hidden
        }

        function showLogin() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('signupScreen').classList.add('hidden');
            document.getElementById('adminLoginScreen').classList.add('hidden');
        }

        function showSignup() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('signupScreen').classList.remove('hidden');
            document.getElementById('adminLoginScreen').classList.add('hidden');
        }

        function showAdminLogin() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('signupScreen').classList.add('hidden');
            document.getElementById('adminLoginScreen').classList.remove('hidden');
            document.getElementById('adminEmail').value = '';
            document.getElementById('adminPassword').value = '';
        }

        function showPatientDashboard() {
            hideAllScreens();
            document.getElementById('patientDashboard').classList.remove('hidden');
            showPatientSection('appointments');
            loadAppointments();
            loadTestResults();
            loadProfile();
        }

        function showAdminDashboard() {
            hideAllScreens();
            document.getElementById('adminDashboard').classList.remove('hidden');
            showAdminSection('appointments'); // Default to pending appointments
            loadPatientsList(); // Load patient buttons initially
        }

        function showPatientSection(sectionId) {
            document.querySelectorAll('#patientDashboard .section').forEach(s => s.classList.add('hidden'));
            // Keep testInterface and tmsQuestionnaireSection hidden when navigating within patient dashboard
            document.getElementById('testInterface').classList.add('hidden');
            document.getElementById('tmsQuestionnaireSection').classList.add('hidden');

            document.querySelectorAll('#patientSidebarNav li').forEach(li => li.classList.remove('active'));
            const targetListItem = document.querySelector(`#patientSidebarNav li[data-section="${sectionId}"]`);
            if (targetListItem) {
                targetListItem.classList.add('active');
            }

            document.getElementById(`${sectionId}Section`).classList.remove('hidden');
        }

        function showAdminSection(sectionId) {
            document.querySelectorAll('#adminDashboard .section').forEach(s => s.classList.add('hidden'));
            document.getElementById('patientDetailView').classList.add('hidden');
            document.getElementById('addPatientForm').classList.add('hidden');

            document.querySelectorAll('#adminSidebarNav li').forEach(li => li.classList.remove('active'));
            const targetListItem = document.querySelector(`#adminSidebarNav li[data-section="${sectionId}"]`);
            if (targetListItem) {
                targetListItem.classList.add('active');
            }

            const targetSectionId = `admin${sectionId.charAt(0).toUpperCase() + sectionId.slice(1)}Section`;
            const targetSectionElement = document.getElementById(targetSectionId);
            
            if (targetSectionElement) {
                targetSectionElement.classList.remove('hidden');
            } else {
                console.error(`Admin: Could not find section with ID: ${targetSectionId}`);
            }

            if (sectionId === 'calendar') {
                loadAdminCalendar();
            } else if (sectionId === 'appointments') {
                loadAdminAppointments();
                document.getElementById('adminAppointmentsTitle').textContent = "Appointment Requests";
            } else if (sectionId === 'patients') {
                loadPatientsList();
            } else if (sectionId === 'tmsSubmissions') { // NEW: Load all TMS submissions for admin
                loadAdminTmsSubmissions();
            } else if (sectionId === 'publicTestResults') { // NEW: Load all public test results for admin
                loadAdminPublicTestResults();
            }
        }

        // --- Patient-Specific Functionality ---

        // Load Patient Profile
        function loadProfile() {
            if (!currentUser) return;
            const profileInfoDiv = document.getElementById('profileInfo');
            console.log("Patient: Loading profile for UID:", currentUser.uid);
            onValue(ref(database, 'patients/' + currentUser.uid), (snapshot) => {
                const patientData = snapshot.val();
                if (patientData) {
                    profileInfoDiv.innerHTML = `
                        <p><strong>Name:</strong> ${patientData.fullName}</p>
                        <p><strong>Email:</strong> ${patientData.email}</p>
                        <p><strong>Phone:</strong> ${patientData.phoneNumber}</p>
                        <p><strong>Date of Birth:</strong> ${patientData.dob || 'N/A'}</p>
                        <p><strong>Gender:</strong> ${patientData.gender}</p>
                        <p><strong>Account Created:</strong> ${new Date(patientData.createdAt).toLocaleString()}</p>
                    `;
                    console.log("Patient: Profile data loaded:", patientData.fullName);
                } else {
                    profileInfoDiv.innerHTML = '<p>No profile data found.</p>';
                    console.log("Patient: No profile data found for UID:", currentUser.uid);
                }
            }, {
                onlyOnce: false
            });
        }

        // Show/Hide Appointment Booking Form
        function showBookingForm() {
            document.getElementById('bookingForm').classList.remove('hidden');
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('appointmentDate').min = today;
            // Pre-fill DOB if available from patient profile
            if (currentUser) {
                get(ref(database, 'patients/' + currentUser.uid)).then(snapshot => {
                    const patientData = snapshot.val();
                    if (patientData && patientData.dob) {
                        document.getElementById('bookApptDob').value = patientData.dob;
                    }
                }).catch(error => console.error("Error fetching patient DOB for pre-fill:", error));
            }
            console.log("Patient: Showing booking form.");
        }

        function hideBookingForm() {
            document.getElementById('bookingForm').classList.add('hidden');
            document.getElementById('bookApptDob').value = '';
            document.getElementById('appointmentDate').value = '';
            document.getElementById('appointmentTime').value = '';
            document.getElementById('appointmentReason').value = '';
            console.log("Patient: Hiding booking form.");
        }

        // Book New Appointment (Updated to save date and DOB, with duplicate check)
        async function bookAppointment() {
            const dob = document.getElementById('bookApptDob').value;
            const date = document.getElementById('appointmentDate').value;
            const time = document.getElementById('appointmentTime').value;
            const reason = document.getElementById('appointmentReason').value;

            if (!dob || !date || !time || !reason) {
                showMessage('Please fill in all appointment details including your Date of Birth, preferred date, time, and reason for visit.', true);
                return;
            }
            if (!currentUser) {
                showMessage('You must be logged in to book an appointment. Please create an account or login.', true);
                return;
            }

            try {
                console.log("Patient: Attempting to book appointment for user UID:", currentUser.uid);
                const patientSnapshot = await get(ref(database, 'patients/' + currentUser.uid));
                const patientData = patientSnapshot.val();

                if (!patientData) {
                    showMessage('Could not retrieve patient data. Please try logging in again.', true);
                    console.error("Patient: Data not found for UID:", currentUser.uid);
                    return;
                }

                // --- DUPLICATE APPOINTMENT CHECK (based on fullName, DOB, date, time) ---
                const appointmentsRef = ref(database, 'appointments');
                const existingAppointmentsSnapshot = await get(appointmentsRef);
                const existingAppointments = existingAppointmentsSnapshot.val();
                
                if (existingAppointments) {
                    const apptArray = Object.values(existingAppointments);

                    // Check for existing pending or approved appointments for THIS user's full name AND DOB for the same date/time
                    const duplicateCheck = apptArray.some(appt =>
                        appt.fullName === patientData.fullName && // Match full name
                        appt.dob === dob && // Match DOB
                        appt.appointmentDate === date &&
                        appt.appointmentTime === time &&
                        (appt.status === 'pending' || appt.status.trim() === 'approved') // Use trim for approved status
                    );

                    if (duplicateCheck) {
                        showMessage('An appointment request with this name and date of birth already exists for this exact date and time. Please check your existing appointments.', true);
                        return; // Prevent booking
                    }
                }
                // --- END DUPLICATE APPOINTMENT CHECK ---

                const newAppointmentRef = push(ref(database, 'appointments'));
                await set(newAppointmentRef, {
                    userId: currentUser.uid,
                    fullName: patientData.fullName,
                    email: patientData.email,
                    phoneNumber: patientData.phoneNumber,
                    dob: dob,
                    appointmentDate: date,
                    appointmentTime: time,
                    reason: reason,
                    status: 'pending', // Default status
                    createdAt: new Date().toISOString()
                });
                console.log("Patient: Appointment request submitted for UID:", currentUser.uid, "Appointment ID:", newAppointmentRef.key);
                showMessage('Appointment request submitted successfully! We will review and get back to you shortly.');
                hideBookingForm();
            } catch (error) {
                console.error("Patient: Error booking appointment:", error);
                showMessage(`Error booking appointment: ${error.message}`, true);
            }
        }

        // Start a Mental Health Test (for logged-in users)
        function startTest(testType) {
            console.log("Patient: Starting logged-in test:", testType);
            isPublicTestMode = false; // Ensure public mode flag is false
            currentTest = testQuestions[testType];
            if (!currentTest) {
                showMessage("Selected test not found. Please try again.", true);
                return;
            }
            document.getElementById('testTitle').textContent = currentTest.title;
            document.getElementById('testQuestions').innerHTML = ''; // Clear previous questions
            document.getElementById('publicTestResultDisplay').classList.add('hidden'); // Hide any previous public results
            document.getElementById('publicTestNameField').classList.add('hidden'); // Hide name field for logged-in users
            document.getElementById('publicTestFullName').value = ''; // Clear name field

            let questionsHtml = '';
            currentTest.questions.forEach((questionText, index) => {
                let questionPrefix = '';
                if (testType === 'depression' || testType === 'anxiety') {
                    questionPrefix = 'Over the last 2 weeks, how often have you been bothered by: ';
                } else if (testType === 'adhd') {
                    questionPrefix = ''; // No additional prefix needed for ASRS
                }
                questionsHtml += `
                    <div class="question">
                        <h4>${index + 1}. ${questionPrefix}${questionText}?</h4>
                        <div class="radio-group">
                            ${currentTest.options.map((option, optIndex) => `
                                <label class="radio-option">
                                    <input type="radio" name="q${index}" value="${option.value}" id="q${index}_${optIndex}" required>
                                    ${option.text}
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            document.getElementById('testQuestions').innerHTML = questionsHtml;
            document.getElementById('testInterface').classList.remove('hidden'); // Show test interface
            document.getElementById('testInterface').classList.remove('public-test-interface'); // Remove public-specific styling
            // Ensure submit/cancel buttons are visible
            document.getElementById('submitTestBtn').classList.remove('hidden');
            document.getElementById('cancelTestBtn').classList.remove('hidden');
            // Re-assign logged-in specific handlers
            document.getElementById('submitTestBtn').onclick = submitTest;
            document.getElementById('cancelTestBtn').onclick = cancelTest;
        }

        // Submit Mental Health Test (for logged-in users)
        async function submitTest() {
            let score = 0;
            const totalQuestions = currentTest.questions.length;
            const answers = [];

            for (let i = 0; i < totalQuestions; i++) {
                const selectedOption = document.querySelector(`input[name="q${i}"]:checked`);
                if (!selectedOption) {
                    showMessage(`Please answer question ${i + 1} before submitting.`, true);
                    return;
                }
                const value = parseInt(selectedOption.value);
                score += value;
                answers.push({ question: currentTest.questions[i], answer: currentTest.options.find(opt => opt.value === value).text, score: value });
            }

            const breakdown = currentTest.getBreakdown(score, answers);
            console.log("Patient: Logged-in test submitted. Score:", score, "Breakdown:", breakdown);

            if (!currentUser) {
                showMessage('You must be logged in to submit a test.', true);
                return;
            }

            try {
                // Save to patient's own test results
                const newTestResultRef = push(ref(database, 'testResults'));
                await set(newTestResultRef, {
                    userId: currentUser.uid,
                    testType: currentTest.title,
                    score: score,
                    breakdown: breakdown,
                    answers: answers,
                    createdAt: new Date().toISOString()
                });
                console.log("Patient: Test results saved to patient's record. Path:", newTestResultRef.toString());

                // Also save a copy to publicMentalHealthTestSubmissions for admin review
                // This copy will include patient's full name, email, phone for admin's convenience
                const patientSnapshot = await get(ref(database, 'patients/' + currentUser.uid));
                const patientData = patientSnapshot.val();

                const newPublicSubmissionRef = push(ref(database, 'publicMentalHealthTestSubmissions'));
                await set(newPublicSubmissionRef, {
                    userId: currentUser.uid, // Include userId for logged-in submissions
                    fullName: patientData ? patientData.fullName : 'Logged-in User', // Get full name
                    email: patientData ? patientData.email : 'N/A', // Get email
                    phoneNumber: patientData ? patientData.phoneNumber : 'N/A', // Get phone number
                    testType: currentTest.title,
                    score: score,
                    breakdown: breakdown,
                    answers: answers,
                    submittedAt: new Date().toISOString()
                });
                console.log("Patient: Test results also saved to public submissions for admin. Path:", newPublicSubmissionRef.toString());

                showMessage('Test submitted successfully! Your results have been saved and forwarded for review.');
                cancelTest(); // Return to logged-in mental health section
                loadTestResults();
            } catch (error) {
                console.error("Patient: Error submitting logged-in test:", error);
                showMessage(`Error submitting test: ${error.message}`, true);
            }
        }

        // Cancel Test (for logged-in users)
        function cancelTest() {
            console.log("Patient: Logged-in test cancelled.");
            currentTest = null;
            document.getElementById('testInterface').classList.add('hidden');
            document.getElementById('mentalHealthSection').classList.remove('hidden');
            document.getElementById('testQuestions').innerHTML = '';
            document.getElementById('publicTestResultDisplay').classList.add('hidden'); // Ensure hidden
        }

        // Load Patient's Past Test Results
        function loadTestResults() {
            const testResultsListDiv = document.getElementById('testResultsList');
            if (!currentUser) {
                testResultsListDiv.innerHTML = '<p>Please log in to view your test results.</p>';
                return;
            }
            console.log("Patient: Loading past test results for patient UID:", currentUser.uid);
            onValue(ref(database, 'testResults'), (snapshot) => {
                testResultsListDiv.innerHTML = '';
                let hasResults = false;
                snapshot.forEach((childSnapshot) => {
                    const result = childSnapshot.val();
                    if (result.userId === currentUser.uid) {
                        hasResults = true;
                        testResultsListDiv.innerHTML += `
                            <div class="test-result-item">
                                <h4>${result.testType}</h4>
                                <p><strong>Score:</strong> ${result.score}</p>
                                <p><strong>Breakdown:</strong> ${result.breakdown}</p>
                                <p style="font-size: 0.8em; opacity: 0.8;">Taken on: ${new Date(result.createdAt).toLocaleString()}</p>
                            </div>
                        `;
                    }
                });
                if (!hasResults) {
                    testResultsListDiv.innerHTML = '<p>No test results found. Take a test to see your results here.</p>';
                }
                console.log("Patient: Test results loaded. Total displayed:", testResultsListDiv.children.length);
            }, {
                onlyOnce: false
            });
        }


        // --- Public Mental Health Test Functions ---

        // Show the selection screen for public mental health tests
        function showPublicMentalHealthTestSelection() {
            hideAllScreens(); // Hide login/main dashboard
            document.getElementById('publicMentalHealthTestsSection').classList.remove('hidden');
            console.log("Public: Showing mental health test selection.");
        }

        // Start a Public Mental Health Test (does not save results for patient's personal record, only for admin)
        function startPublicTest(testType) {
            console.log("DEBUG: Entered startPublicTest for type:", testType);
            hideAllScreens(); // Ensure everything else is hidden for a clean state
            
            isPublicTestMode = true; // Set flag for public mode
            currentTest = testQuestions[testType];
            if (!currentTest) {
                console.error("Public: Test type not found in testQuestions object:", testType);
                showMessage("Selected test not found. Please try again.", true);
                return;
            }
            console.log("DEBUG: currentTest found:", currentTest.title);

            const testQuestionsDiv = document.getElementById('testQuestions');
            testQuestionsDiv.innerHTML = ''; // Clear existing questions
            document.getElementById('publicTestResultDisplay').classList.add('hidden'); // Hide previous results

            document.getElementById('testTitle').textContent = currentTest.title;
            console.log("DEBUG: testTitle set to:", currentTest.title);

            // NEW: Show and clear the public name field
            document.getElementById('publicTestNameField').classList.remove('hidden');
            document.getElementById('publicTestFullName').value = '';
            console.log("DEBUG: Public name field shown and cleared.");

            // Ensure submit/cancel buttons are visible when starting a new test
            document.getElementById('submitTestBtn').classList.remove('hidden');
            document.getElementById('cancelTestBtn').classList.remove('hidden');
            console.log("DEBUG: Submit and Cancel buttons should be visible.");

            let questionsHtml = '';
            currentTest.questions.forEach((questionText, index) => {
                let questionPrefix = '';
                if (testType === 'depression' || testType === 'anxiety') {
                    questionPrefix = 'Over the last 2 weeks, how often have you been bothered by: ';
                } else if (testType === 'adhd') {
                    questionPrefix = ''; // No additional prefix needed for ASRS
                }

                const questionHtml = `
                    <div class="question">
                        <h4>${index + 1}. ${questionPrefix}${questionText}?</h4>
                        <div class="radio-group">
                            ${currentTest.options.map((option, optIndex) => `
                                <label class="radio-option">
                                    <input type="radio" name="q${index}" value="${option.value}" id="q${index}_${optIndex}" required>
                                    ${option.text}
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;
                questionsHtml += questionHtml; // Append to a temporary string
            });
            document.getElementById('testQuestions').innerHTML = questionsHtml; // Set innerHTML once
            console.log("DEBUG: testQuestionsDiv innerHTML set. Number of questions:", currentTest.questions.length);

            // Make sure the test interface is shown
            document.getElementById('testInterface').classList.remove('hidden'); // Show test interface
            document.getElementById('testInterface').classList.add('public-test-interface'); // Add public-specific styling
            
            // Assign public submit and cancel handlers
            document.getElementById('submitTestBtn').onclick = submitPublicTest;
            document.getElementById('cancelTestBtn').onclick = cancelPublicTest;

            console.log("DEBUG: Test interface displayed for:", testType);
        }

        // Submit Public Mental Health Test (displays results, DOES save to Firebase for Admin)
        async function submitPublicTest() {
            const publicFullName = document.getElementById('publicTestFullName').value.trim(); // NEW: Get full name
            if (!publicFullName) {
                showMessage('Please enter your full name before submitting the test.', true);
                return;
            }

            let score = 0;
            const totalQuestions = currentTest.questions.length;
            const answers = [];

            for (let i = 0; i < totalQuestions; i++) {
                const selectedOption = document.querySelector(`input[name="q${i}"]:checked`);
                if (!selectedOption) {
                    showMessage(`Please answer question ${i + 1} before submitting.`, true);
                    return;
                }
                const value = parseInt(selectedOption.value);
                score += value;
                answers.push({ question: currentTest.questions[i], answer: currentTest.options.find(opt => opt.value === value).text, score: value });
            }

            const breakdown = currentTest.getBreakdown(score, answers);
            console.log("Public: Test submitted. Calculated Score:", score, "Breakdown:", breakdown);

            try {
                // Save public test results to Firebase (for Admin)
                const newPublicTestResultRef = push(ref(database, 'publicMentalHealthTestSubmissions'));
                await set(newPublicTestResultRef, {
                    fullName: publicFullName, // NEW: Save full name
                    testType: currentTest.title,
                    score: score,
                    breakdown: breakdown,
                    answers: answers,
                    submittedAt: new Date().toISOString()
                });
                console.log("Public: Test results saved to Firebase for admin review. Path:", newPublicTestResultRef.toString());
                showMessage('Test submitted successfully! Your results are available for review by our staff.');
            } catch (error) {
                console.error("Public: Error submitting and saving public test:", error);
                showMessage(`Error submitting test: ${error.message}`, true);
            }

            const resultDisplayDiv = document.getElementById('publicTestResultDisplay');
            resultDisplayDiv.innerHTML = `
                <h3>Your Test Results for ${currentTest.title}</h3>
                <p><strong>Score:</strong> ${score}</p>
                <p><strong>Result:</strong> ${breakdown}</p>
                <p style="margin-top: 15px; font-size: 0.9em;">These results have been recorded for staff review. For a professional evaluation or to track your progress, please create an account.</p>
                <button class="btn" id="publicTestBackToSelectionBtn">Back to Test Selection</button>
                <button class="btn btn-secondary" id="publicTestGoToMainBtn">Go to Main Screen</button>
            `;
            resultDisplayDiv.classList.remove('hidden');
            document.getElementById('testQuestions').innerHTML = ''; // Clear questions
            document.getElementById('publicTestNameField').classList.add('hidden'); // NEW: Hide name field after submission
            document.getElementById('submitTestBtn').classList.add('hidden'); // Hide submit
            document.getElementById('cancelTestBtn').classList.add('hidden'); // Hide cancel

            document.getElementById('publicTestBackToSelectionBtn').onclick = () => {
                resultDisplayDiv.classList.add('hidden');
                document.getElementById('testInterface').classList.add('hidden');
                document.getElementById('submitTestBtn').classList.remove('hidden'); // Re-show for next test
                document.getElementById('cancelTestBtn').classList.remove('hidden');
                showPublicMentalHealthTestSelection(); // Go back to public test selection
            };

            document.getElementById('publicTestGoToMainBtn').onclick = () => {
                resultDisplayDiv.classList.add('hidden');
                document.getElementById('testInterface').classList.add('hidden');
                document.getElementById('submitTestBtn').classList.remove('hidden'); // Re-show for next test
                document.getElementById('cancelTestBtn').classList.remove('hidden');
                showLoginScreenLayout(); // Go back to main login/public access screen
                showLogin();
            };
            console.log("Public: Test results displayed on screen.");
        }

        // Cancel Public Mental Health Test
        function cancelPublicTest() {
            console.log("Public: Test cancelled.");
            currentTest = null;
            document.getElementById('testInterface').classList.add('hidden');
            document.getElementById('testInterface').classList.remove('public-test-interface');
            document.getElementById('testQuestions').innerHTML = '';
            document.getElementById('publicTestNameField').classList.add('hidden'); // NEW: Hide name field on cancel
            document.getElementById('publicTestFullName').value = ''; // NEW: Clear name field on cancel
            document.getElementById('publicTestResultDisplay').classList.add('hidden'); // Ensure hidden
            showPublicMentalHealthTestSelection(); // Return to public test selection
        }


        // --- TMS Daily Questionnaire Functions (Patient Side / Public Access) ---

        // Called from public button OR logged-in button
        function showTmsQuestionnaire(isLoggedInCall = false) {
            // Reset contact info fields for fresh start
            document.getElementById('tmsFullName').value = '';
            document.getElementById('tmsEmail').value = '';
            document.getElementById('tmsPhone').value = '';

            // Pre-fill if logged in
            if (isLoggedInCall && currentUser) {
                get(ref(database, 'patients/' + currentUser.uid)).then(snapshot => {
                    const patientData = snapshot.val();
                    if (patientData) {
                        document.getElementById('tmsFullName').value = patientData.fullName || '';
                        document.getElementById('tmsEmail').value = patientData.email || '';
                        document.getElementById('tmsPhone').value = patientData.phoneNumber || '';
                    }
                }).catch(error => console.error("Error pre-filling TMS form:", error));
            }

            hideAllScreens(); // Hide login/main dashboard
            document.getElementById('tmsQuestionnaireSection').classList.remove('hidden');
            resetTmsForm(); // Clear any previous inputs for questions (but keep contact info from above pre-fill)
            console.log("Patient: Showing TMS Daily Questionnaire. Logged-in call:", isLoggedInCall);
        }

        // Called from public button OR logged-in button
        function cancelTmsQuestionnaire() {
            document.getElementById('tmsQuestionnaireSection').classList.add('hidden');
            
            // Depending on where it was launched from, show the correct previous screen
            if (currentUser) { // If a user is logged in, they came from the patient dashboard
                showPatientSection('forms'); // Back to patient dashboard forms
            } else { // Otherwise, they came from the public access screen
                showLoginScreenLayout(); // Back to the login/public access page
                showLogin(); // Ensure login form is visible
            }
            resetTmsForm(); // Clear all fields
            console.log("Patient: TMS Daily Questionnaire cancelled.");
        }

        function resetTmsForm() {
            // Reset contact info fields (if not pre-filled by logged-in user logic)
            // No need to clear tmsFullName, tmsEmail, tmsPhone here, as showTmsQuestionnaire does it.

            // Reset questionnaire fields
            document.getElementById('tmsQuestionnaireSection').querySelectorAll('input[type="radio"]').forEach(radio => radio.checked = false);
            document.getElementById('tmsQuestionnaireSection').querySelectorAll('textarea').forEach(textarea => textarea.value = '');
            document.getElementById('tmsQuestionnaireSection').querySelectorAll('input[type="number"]').forEach(input => input.value = '');
            document.getElementById('tmsQuestionnaireSection').querySelectorAll('.follow-up-question').forEach(div => div.classList.add('hidden'));
            console.log("Patient: TMS Daily Questionnaire form reset.");
        }

        function setupTmsFormListeners() {
            // Q1: Eat/Drink
            document.querySelectorAll('input[name="q1_eat_drink"]').forEach(radio => {
                radio.addEventListener('change', (event) => {
                    if (event.target.value === 'yes') {
                        document.getElementById('q1_followup').classList.remove('hidden');
                    } else {
                        document.getElementById('q1_followup').classList.add('hidden');
                        document.getElementById('q1_eat_drink_details').value = '';
                    }
                });
            });

            // Q2: Medication prescribed
            document.querySelectorAll('input[name="q2_med_prescribed"]').forEach(radio => {
                radio.addEventListener('change', (event) => {
                    if (event.target.value === 'no') { // Q2a appears if not taking as prescribed
                        document.getElementById('q2_followup').classList.remove('hidden');
                    } else {
                        document.getElementById('q2_followup').classList.add('hidden');
                        document.querySelectorAll('input[name="q2a_med_changes"]').forEach(r => r.checked = false); // Clear Q2a radios
                        document.getElementById('q2a_followup').classList.add('hidden'); // Hide Q2a follow-up
                        document.getElementById('q2a_med_changes_details').value = ''; // Clear Q2a text
                    }
                });
            });

            // Q2a: Medication changes
            document.querySelectorAll('input[name="q2a_med_changes"]').forEach(radio => {
                radio.addEventListener('change', (event) => {
                    if (event.target.value === 'yes') {
                        document.getElementById('q2a_followup').classList.remove('hidden');
                    } else {
                        document.getElementById('q2a_followup').classList.add('hidden');
                        document.getElementById('q2a_med_changes_details').value = '';
                    }
                });
            });

            // Q4: Caffeine
            document.querySelectorAll('input[name="q4_caffeine"]').forEach(radio => {
                radio.addEventListener('change', (event) => {
                    if (event.target.value === 'yes') {
                        document.getElementById('q4_followup').classList.remove('hidden');
                    } else {
                        document.getElementById('q4_followup').classList.add('hidden');
                        document.getElementById('q4_caffeine_details').value = '';
                    }
                });
            });

            // Q5: Alcohol
            document.querySelectorAll('input[name="q5_alcohol"]').forEach(radio => {
                radio.addEventListener('change', (event) => {
                    if (event.target.value === 'yes') {
                        document.getElementById('q5_followup').classList.remove('hidden');
                    } else {
                        document.getElementById('q5_followup').classList.add('hidden');
                        document.getElementById('q5_alcohol_details').value = '';
                    }
                });
            });

            // Q6: Metal in Head
            document.querySelectorAll('input[name="q6_metal_head"]').forEach(radio => {
                radio.addEventListener('change', (event) => {
                    if (event.target.value === 'yes') {
                        document.getElementById('q6_followup').classList.remove('hidden');
                    } else {
                        document.getElementById('q6_followup').classList.add('hidden');
                        document.getElementById('q6_metal_head_details').value = '';
                    }
                });
            });
        }

        async function submitTmsQuestionnaire() {
            const tmsFullName = document.getElementById('tmsFullName').value.trim();
            const tmsEmail = document.getElementById('tmsEmail').value.trim();
            const tmsPhone = document.getElementById('tmsPhone').value.trim();

            if (!tmsFullName || !tmsEmail || !tmsPhone) {
                showMessage('Please provide your Full Name, Email, and Phone Number at the top of the questionnaire.', true);
                return;
            }

            const answers = {};
            let allRequiredAnswered = true;

            // Q1: Have you had anything to eat or drink today?
            const q1Answer = document.querySelector('input[name="q1_eat_drink"]:checked');
            if (!q1Answer) { allRequiredAnswered = false; } else {
                answers.q1_eat_drink = q1Answer.value;
                if (q1Answer.value === 'yes') {
                    const details = document.getElementById('q1_eat_drink_details').value.trim();
                    if (!details) { showMessage("Please provide details for Q1.", true); return; }
                    answers.q1_eat_drink_details = details;
                }
            }

            // Q2: Have you been taking your medication as prescribed and at the same time?
            const q2Answer = document.querySelector('input[name="q2_med_prescribed"]:checked');
            if (!q2Answer) { allRequiredAnswered = false; } else {
                answers.q2_med_prescribed = q2Answer.value;
                if (q2Answer.value === 'no') {
                    // Q2a: Any changes to your medication?
                    const q2aAnswer = document.querySelector('input[name="q2a_med_changes"]:checked');
                    if (!q2aAnswer) { showMessage("Please answer Q2a.", true); return; }
                    answers.q2a_med_changes = q2aAnswer.value;
                    if (q2aAnswer.value === 'yes') {
                        const details = document.getElementById('q2a_med_changes_details').value.trim();
                        if (!details) { showMessage("Please provide details for Q2a.", true); return; }
                        answers.q2a_med_changes_details = details;
                    }
                }
            }

            // Q3: How did you sleep last night? Number of hours?
            const q3Answer = document.getElementById('q3_sleep_hours').value;
            if (q3Answer === '' || isNaN(q3Answer)) { showMessage("Please enter sleep hours for Q3.", true); return; }
            answers.q3_sleep_hours = parseFloat(q3Answer);

            // Q4: Any caffeine intake today?
            const q4Answer = document.querySelector('input[name="q4_caffeine"]:checked');
            if (!q4Answer) { allRequiredAnswered = false; } else {
                answers.q4_caffeine = q4Answer.value;
                if (q4Answer.value === 'yes') {
                    const details = document.getElementById('q4_caffeine_details').value.trim();
                    if (!details) { showMessage("Please provide details for Q4.", true); return; }
                    answers.q4_caffeine_details = details;
                }
            }

            // Q5: Any alcohol intake today?
            const q5Answer = document.querySelector('input[name="q5_alcohol"]:checked');
            if (!q5Answer) { allRequiredAnswered = false; } else {
                answers.q5_alcohol = q5Answer.value;
                if (q5Answer.value === 'yes') {
                    const details = document.getElementById('q5_alcohol_details').value.trim();
                    if (!details) { showMessage("Please provide details for Q5.", true); return; }
                    answers.q5_alcohol_details = details;
                }
            }

            // Q_unprescribed_substance: Have you consumed any substances that were NOT prescribed by any physicians today?
            const qUnprescribedSubstanceAnswer = document.querySelector('input[name="q_unprescribed_substance"]:checked');
            if (!qUnprescribedSubstanceAnswer) { allRequiredAnswered = false; } else {
                answers.q_unprescribed_substance = qUnprescribedSubstanceAnswer.value;
            }

            // Q6: Do you have any metal in or around your head (above the collar)?
            const q6Answer = document.querySelector('input[name="q6_metal_head"]:checked');
            if (!q6Answer) { allRequiredAnswered = false; } else {
                answers.q6_metal_head = q6Answer.value;
                if (q6Answer.value === 'yes') {
                    const details = document.getElementById('q6_metal_head_details').value.trim();
                    if (!details) { showMessage("Please provide details for Q6.", true); return; }
                    answers.q6_metal_head_details = details;
                }
            }
            
            if (!allRequiredAnswered) {
                showMessage("Please answer all required questions before submitting.", true);
                return;
            }

            try {
                let tmsRefPath;
                let tmsData = {
                    fullName: tmsFullName,
                    email: tmsEmail,
                    phoneNumber: tmsPhone,
                    answers: answers,
                    submittedAt: new Date().toISOString()
                };

                if (currentUser) {
                    // If logged in, save under user's specific path
                    tmsRefPath = `tmsQuestionnaires/${currentUser.uid}`;
                    tmsData.userId = currentUser.uid; // Add userId to data
                    // If currentUser exists, their name/email/phone from profile is more authoritative
                    // But for the form, we'll use what they typed if it differs.
                } else {
                    // If not logged in, save to a public path
                    tmsRefPath = `publicTmsQuestionnaires`;
                }

                const newTmsRef = push(ref(database, tmsRefPath));
                await set(newTmsRef, tmsData);
                
                console.log("Patient: TMS Questionnaire submitted successfully. Path:", newTmsRef.toString());
                showMessage('TMS Daily Questionnaire submitted successfully!');
                cancelTmsQuestionnaire();
            } catch (error) {
                console.error("Patient: Error submitting TMS Questionnaire:", error);
                showMessage(`Error submitting TMS Questionnaire: ${error.message}`, true);
            }
        }


        // --- Admin-Specific Functionality ---

        // Load Pending Appointment Requests for Admin (This will be the main view for Admin Appointments section)
        function loadAdminAppointments() {
            const adminPendingAppointmentsListDiv = document.getElementById('adminPendingAppointmentsList');
            if (!currentUser || !isAdmin) {
                adminPendingAppointmentsListDiv.innerHTML = '<p>Unauthorized access. Please log in as Admin.</p>';
                return;
            }
            console.log("Admin: Loading pending appointment requests.");
            onValue(ref(database, 'appointments'), (snapshot) => {
                adminPendingAppointmentsListDiv.innerHTML = ''; // Clear previous content
                let hasPendingAppointments = false;
                const rawSnapshotData = snapshot.val();

                if (rawSnapshotData) {
                    const appointmentsArray = Object.keys(rawSnapshotData).map(key => ({ id: key, ...rawSnapshotData[key] }));
                    // CRITICAL FIX: Ensure status is trimmed and explicitly 'pending'
                    const pendingAppointments = appointmentsArray.filter(appt => appt.status && appt.status.trim() === 'pending');
                    pendingAppointments.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                    pendingAppointments.forEach((appt) => {
                        hasPendingAppointments = true;
                        const statusClass = `status-${appt.status}`;
                        const displayDateTime = appt.appointmentDate && appt.appointmentTime
                            ? `${new Date(appt.appointmentDate).toLocaleDateString()} at ${appt.appointmentTime}`
                            : appt.time || 'N/A'; // Fallback for old data without specific date/time
                        adminPendingAppointmentsListDiv.innerHTML += `
                            <div class="appointment-card admin-card">
                                <h4>Appointment Request from ${appt.fullName}</h4>
                                <p><strong>Email:</strong> ${appt.email}</p>
                                <p><strong>Phone:</strong> ${appt.phoneNumber}</p>
                                <p><strong>Date of Birth:</strong> ${appt.dob || 'N/A'}</p>
                                <p><strong>Requested Date & Time:</strong> ${displayDateTime}</p>
                                <p><strong>Reason:</strong> ${appt.reason}</p>
                                <p><strong>Status:</strong> <span class="appointment-status ${statusClass}">${appt.status.toUpperCase()}</span></p>
                                <p style="font-size: 0.8em; opacity: 0.8;">Requested on: ${new Date(appt.createdAt).toLocaleString()}</p>
                                <p style="font-size: 0.8em; opacity: 0.8;">Appointment ID: ${appt.id}</p>
                                <div class="action-buttons">
                                    <button class="btn-approve" data-id="${appt.id}">Approve</button>
                                    <button class="btn-deny" data-id="${appt.id}">Deny</button>
                                </div>
                            </div>
                        `;
                    });
                }
                if (!hasPendingAppointments) {
                    adminPendingAppointmentsListDiv.innerHTML = '<p>No pending appointment requests found.</p>';
                }
                console.log("Admin: Pending appointments loaded. Total displayed elements:", adminPendingAppointmentsListDiv.children.length);
                // Re-attach event listeners after content is updated
                document.querySelectorAll('#adminPendingAppointmentsList .btn-approve').forEach(button => {
                    button.onclick = (e) => approveAppointment(e.target.dataset.id);
                });
                document.querySelectorAll('#adminPendingAppointmentsList .btn-deny').forEach(button => {
                    button.onclick = (e) => denyAppointment(e.target.dataset.id);
                });
            }, {
                onlyOnce: false
            });
        }

        // Approve Appointment
        async function approveAppointment(apptId) {
            if (!currentUser || !isAdmin) {
                showMessage('Unauthorized action.', true);
                return;
            }
            console.log("Admin: Attempting to approve appointment ID:", apptId);
            try {
                await update(ref(database, 'appointments/' + apptId), { status: 'approved' });
                console.log("Admin: Appointment approved:", apptId);
                showMessage('Appointment approved successfully!');
                if (adminCalendarInstance) {
                    adminCalendarInstance.refetchEvents();
                    console.log("Admin: Calendar events refetched after approval.");
                }
            } catch (error) {
                console.error("Admin: Error approving appointment:", error);
                showMessage(`Error approving appointment: ${error.message}`, true);
            }
        }

        // Deny Appointment
        async function denyAppointment(apptId) {
            if (!currentUser || !isAdmin) {
                showMessage('Unauthorized action.', true);
                return;
            }
            console.log("Admin: Attempting to deny appointment ID:", apptId);
            try {
                await update(ref(database, 'appointments/' + apptId), { status: 'denied' });
                console.log("Admin: Appointment denied:", apptId);
                showMessage('Appointment denied.');
                if (adminCalendarInstance) {
                    adminCalendarInstance.refetchEvents();
                    console.log("Admin: Calendar events refetched after denial.");
                }
            } catch (error) {
                console.error("Admin: Error denying appointment:", error);
                showMessage(`Error denying appointment: ${error.message}`, true);
            }
        }

        // Show Add Patient Form
        function showAddPatientForm() {
            if (!currentUser || !isAdmin) {
                showMessage('Unauthorized access.', true);
                return;
            }
            document.getElementById('addPatientForm').classList.remove('hidden');
            document.getElementById('patientsList').classList.add('hidden');
            document.getElementById('patientDetailView').classList.add('hidden');
            // Clear the form fields
            document.getElementById('newPatientName').value = '';
            document.getElementById('newPatientEmail').value = '';
            document.getElementById('newPatientPassword').value = '';
            document.getElementById('newPatientDob').value = '';
            document.getElementById('newPatientPhone').value = '';
            document.getElementById('newPatientGender').value = '';
            console.log("Admin: Showing add patient form.");
        }

        function hideAddPatientForm() {
            document.getElementById('addPatientForm').classList.add('hidden');
            document.getElementById('patientsList').classList.remove('hidden');
            console.log("Admin: Hiding add patient form.");
        }

        // Add New Patient via Admin Portal
        async function addPatient() {
            if (!currentUser || !isAdmin) {
                showMessage('Unauthorized action.', true);
                return;
            }
            const name = document.getElementById('newPatientName').value;
            const email = document.getElementById('newPatientEmail').value;
            const password = document.getElementById('newPatientPassword').value;
            const dob = document.getElementById('newPatientDob').value; // Get DOB
            const phone = document.getElementById('newPatientPhone').value;
            const gender = document.getElementById('newPatientGender').value;

            if (!name || !email || !password || !dob || !phone || !gender) { // Include dob in validation
                showMessage('Please fill in all fields for the new patient', true);
                return;
            }
            if (password.length < 6) {
                showMessage('Password for the new patient must be at least 6 characters long.', true);
                return;
            }

            try {
                console.log("Admin: Attempting to add new patient with email:", email);
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const userId = userCredential.user.uid;
                console.log("Admin: Created new user in Auth with UID:", userId);

                await set(ref(database, 'patients/' + userId), {
                    fullName: name,
                    email: email,
                    phoneNumber: phone,
                    dob: dob, // Save DOB
                    gender: gender,
                    createdAt: new Date().toISOString()
                });
                console.log("Admin: Saved patient data to Realtime Database for UID:", userId);
                showMessage(`Patient ${name} added successfully! Temporary password: ${password}`);
                hideAddPatientForm();
                loadPatientsList(); // Reload patient list to show the new patient
            } catch (error) {
                console.error("Admin: Error adding patient via admin portal:", error);
                showMessage(`Error adding patient: ${error.message}`, true);
            }
        }

        // NEW: Delete Patient Function
        async function deletePatient(patientId) {
            if (!currentUser || !isAdmin) {
                showMessage('Unauthorized action.', true);
                return;
            }

            showConfirmationModal(
                `Are you sure you want to permanently delete this patient (UID: ${patientId}) and ALL their associated data (profile, tests, TMS, appointments)? This action cannot be undone.`,
                async () => { // On Confirm
                    try {
                        // 1. Delete patient data from Realtime Database
                        await remove(ref(database, 'patients/' + patientId));
                        console.log(`Admin: Patient data deleted from /patients/${patientId}`);

                        // 2. Delete associated test results
                        const testResultsSnapshot = await get(ref(database, 'testResults'));
                        if (testResultsSnapshot.exists()) {
                            testResultsSnapshot.forEach(child => {
                                if (child.val().userId === patientId) {
                                    remove(ref(database, `testResults/${child.key}`));
                                }
                            });
                        }
                        console.log(`Admin: Associated test results deleted for patient ${patientId}`);

                        // 3. Delete associated TMS questionnaires
                        await remove(ref(database, `tmsQuestionnaires/${patientId}`));
                        console.log(`Admin: Associated TMS questionnaires deleted for patient ${patientId}`);

                        // 4. Delete associated appointments
                        const appointmentsSnapshot = await get(ref(database, 'appointments'));
                        if (appointmentsSnapshot.exists()) {
                            appointmentsSnapshot.forEach(child => {
                                if (child.val().userId === patientId) {
                                    remove(ref(database, `appointments/${child.key}`));
                                }
                            });
                        }
                        console.log(`Admin: Associated appointments deleted for patient ${patientId}`);

                        // 5. Delete the user from Firebase Authentication
                        // NOTE: This requires admin SDK or a callable cloud function for security.
                        // For a client-side app, you cannot directly delete another user's Auth record.
                        // This part would typically be handled on a secure backend.
                        // For demonstration purposes *only*, if you were to simulate it, you might do:
                        // const userToDelete = auth.currentUser; // This is the *admin* user, not the patient!
                        // await deleteUser(userToDelete); // This would delete the admin!
                        // Instead, you'd need a Cloud Function or Admin SDK.
                        showMessage(`Patient ${patientId} data deleted from database. NOTE: Deleting the Firebase Authentication user for this patient requires server-side access (Admin SDK).`, false);
                        console.warn(`Admin: Firebase Auth user deletion for ${patientId} skipped (requires Admin SDK).`);

                        loadPatientsList(); // Refresh the list
                    } catch (error) {
                        console.error("Admin: Error deleting patient and associated data:", error);
                        showMessage(`Error deleting patient: ${error.message}`, true);
                    }
                },
                () => { // On Cancel
                    showMessage('Patient deletion cancelled.');
                }
            );
        }


        // Load All Patients for Admin (Now displays buttons)
        function loadPatientsList() {
            const patientsListDiv = document.getElementById('patientsList');
            if (!currentUser || !isAdmin) {
                patientsListDiv.innerHTML = '<p>Unauthorized access. Please log in as Admin.</p>';
                return;
            }
            console.log("Admin: Loading list of patient buttons.");
            
            document.getElementById('patientsList').classList.remove('hidden');
            document.getElementById('patientDetailView').classList.add('hidden');
            document.getElementById('addPatientForm').classList.add('hidden');

            onValue(ref(database, 'patients'), (snapshot) => {
                patientsListDiv.innerHTML = '';
                let hasPatients = false;
                const rawSnapshotData = snapshot.val();
                console.log("Admin: Raw patients snapshot data (from Firebase):", JSON.stringify(rawSnapshotData, null, 2));

                if (rawSnapshotData) {
                    const patientsArray = Object.keys(rawSnapshotData).map(key => ({ id: key, ...rawSnapshotData[key] }));
                    
                    // Filter out "Jane Doe" and "user testing"
                    const filteredPatients = patientsArray.filter(patient =>
                        patient.fullName !== "Jane Doe" && patient.fullName !== "user testing"
                    );
                    allPatientsData = filteredPatients; // Store for dropdowns

                    filteredPatients.sort((a, b) => a.fullName.localeCompare(b.fullName)); // Sort alphabetically by name

                    if (filteredPatients.length > 0) {
                        hasPatients = true;
                        filteredPatients.forEach((patient) => {
                            patientsListDiv.innerHTML += `
                                <button class="btn patient-card-btn" data-patient-id="${patient.id}">
                                    <span>${patient.fullName} (${patient.email})</span>
                                    <i class="fas fa-trash-alt btn-delete" data-id="${patient.id}" data-type="patient"></i>
                                </button>
                            `;
                        });
                    }
                }
                if (!hasPatients) {
                    patientsListDiv.innerHTML = '<p>No patients registered (excluding demo users).</p>';
                }
                console.log("Admin: Patient buttons loaded. Total displayed elements:", patientsListDiv.children.length);

                // Attach event listeners to the new patient buttons
                document.querySelectorAll('#patientsList .patient-card-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        // Check if the click was on the trash icon
                        if (event.target.classList.contains('btn-delete')) {
                            event.stopPropagation(); // Prevent the parent button's click from firing
                            const patientId = event.target.dataset.id;
                            deletePatient(patientId);
                        } else {
                            // If not the trash icon, proceed with showing patient details
                            const patientId = button.dataset.patientId;
                            showPatientDetails(patientId);
                        }
                    });
                });

            }, {
                onlyOnce: false
            });
        }

        // Show details for a specific patient
        async function showPatientDetails(patientId) {
            if (!currentUser || !isAdmin) {
                showMessage('Unauthorized action.', true);
                return;
            }
            currentPatientIdInAdminView = patientId; // Store the patientId being viewed
            console.log("Admin: Showing details for patient ID:", patientId);

            document.getElementById('patientsList').classList.add('hidden');
            document.getElementById('addPatientForm').classList.add('hidden');
            document.getElementById('patientDetailView').classList.remove('hidden');
            document.getElementById('patientSpecificDataResults').innerHTML = ''; // Clear previous results here

            try {
                const patientSnapshot = await get(ref(database, 'patients/' + patientId));
                const patientData = patientSnapshot.val();

                if (patientData) {
                    document.getElementById('patientDetailName').textContent = patientData.fullName;
                    document.getElementById('patientBasicInfo').innerHTML = `
                        <p><strong>Name:</strong> ${patientData.fullName}</p>
                        <p><strong>Email:</strong> ${patientData.email}</p>
                        <p><strong>Phone:</strong> ${patientData.phoneNumber}</p>
                        <p><strong>Date of Birth:</strong> ${patientData.dob || 'N/A'}</p>
                        <p><strong>Gender:</strong> ${patientData.gender}</p>
                        <p><strong>Account Created:</strong> ${new Date(patientData.createdAt).toLocaleString()}</p>
                        <p><strong>Firebase UID:</strong> ${patientId}</p>
                    `;
                    console.log("Admin: Patient details loaded for:", patientData.fullName);

                    // Add event listeners for the new buttons for this specific patient
                    document.getElementById('viewPatientMentalHealthResultsBtn').onclick = () => loadPatientDataSection(patientId, 'mentalHealthTests');
                    document.getElementById('viewPatientTmsQuestionnairesBtn').onclick = () => loadPatientDataSection(patientId, 'tmsQuestionnaires');
                    document.getElementById('viewPatientBookedAppointmentsBtn').onclick = () => loadPatientDataSection(patientId, 'bookedAppointments');

                } else {
                    document.getElementById('patientDetailView').innerHTML = '<p>Patient not found.</p>';
                    console.error("Admin: Patient data not found for ID:", patientId);
                }
            } catch (error) {
                console.error("Admin: Error fetching patient details:", error);
                showMessage(`Error fetching patient details: ${error.message}`, true);
            }
        }

        // Load specific patient data section (Mental Health Tests or TMS Questionnaires or Booked Appointments)
        async function loadPatientDataSection(patientId, dataType) {
            if (!currentUser || !isAdmin || !patientId) {
                showMessage('Unauthorized action or no patient selected.', true);
                return;
            }
            console.log(`Admin: Loading ${dataType} for specific patient ID:`, patientId);
            const resultsContainer = document.getElementById('patientSpecificDataResults');
            resultsContainer.innerHTML = '<h4>Loading Results...</h4>'; // Clear and show loading

            let contentHtml = '';
            let hasResults = false;

            if (dataType === 'mentalHealthTests') {
                const testResultsSnapshot = await get(ref(database, 'testResults'));
                const testResults = [];
                if (testResultsSnapshot.exists()) {
                    testResultsSnapshot.forEach(child => {
                        const result = child.val();
                        if (result.userId === patientId) {
                            testResults.push(result);
                        }
                    });
                }
                
                testResults.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                if (testResults.length > 0) {
                    hasResults = true;
                    contentHtml += '<h3 style="margin-bottom: 15px;">Mental Health Test Results:</h3>';
                    testResults.forEach(result => {
                        contentHtml += `
                            <div class="test-result-item" style="background: linear-gradient(135deg, #00b894 0%, #00a085 100%); margin-bottom: 15px;">
                                <h4>${result.testType}</h4>
                                <p><strong>Score:</strong> ${result.score}</p>
                                <p><strong>Breakdown:</strong> ${result.breakdown}</p>
                                <p style="font-size: 0.8em; opacity: 0.8;">Taken on: ${new Date(result.createdAt).toLocaleString()}</p>
                            </div>
                        `;
                    });
                } else {
                    contentHtml = '<p>No mental health test results found for this patient.</p>';
                }
            } else if (dataType === 'tmsQuestionnaires') {
                // For a specific patient, fetch only their logged-in TMS questionnaires
                const tmsQuestionnairesSnapshot = await get(ref(database, `tmsQuestionnaires/${patientId}`));
                const tmsQuestionnaires = [];
                if (tmsQuestionnairesSnapshot.exists()) {
                    tmsQuestionnairesSnapshot.forEach(child => {
                        tmsQuestionnaires.push(child.val());
                    });
                }

                tmsQuestionnaires.sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt));
                if (tmsQuestionnaires.length > 0) {
                    hasResults = true;
                    contentHtml += '<h3 style="margin-bottom: 15px;">TMS Daily Questionnaires (Logged In):</h3>';
                    tmsQuestionnaires.forEach((q, index) => {
                        contentHtml += `
                            <div class="tms-questionnaire-item" style="margin-bottom: 15px;">
                                <h4>Questionnaire Submitted on: ${new Date(q.submittedAt).toLocaleString()}</h4>
                                <ul>
                                    <li><strong>Full Name:</strong> ${q.fullName || 'N/A'}</li>
                                    <li><strong>Email:</strong> ${q.email || 'N/A'}</li>
                                    <li><strong>Phone:</strong> ${q.phoneNumber || 'N/A'}</li>
                                    <li><strong>Q1. Eat/Drink:</strong> ${q.answers.q1_eat_drink} ${q.answers.q1_eat_drink === 'yes' ? `(Details: ${q.answers.q1_eat_drink_details})` : ''}</li>
                                    <li><strong>Q2. Meds Prescribed:</strong> ${q.answers.q2_med_prescribed}</li>
                                    ${q.answers.q2_med_prescribed === 'no' ? `<li><strong>Q2a. Med Changes:</strong> ${q.answers.q2a_med_changes} ${q.answers.q2a_med_changes === 'yes' ? `(Details: ${q.answers.q2a_med_changes_details})` : ''}</li>` : ''}
                                    <li><strong>Q3. Sleep Hours:</strong> ${q.answers.q3_sleep_hours} hours</li>
                                    <li><strong>Q4. Caffeine:</strong> ${q.answers.q4_caffeine} ${q.answers.q4_caffeine === 'yes' ? `(Details: ${q.answers.q4_caffeine_details})` : ''}</li>
                                    <li><strong>Q5. Alcohol:</strong> ${q.answers.q5_alcohol} ${q.answers.q5_alcohol === 'yes' ? `(Details: ${q.answers.q5_alcohol_details})` : ''}</li>
                                    <li><strong>Q6. Metal in Head:</strong> ${q.answers.q6_metal_head} ${q.answers.q6_metal_head === 'yes' ? `(Details: ${q.answers.q6_metal_head_details})` : ''}</li>
                                </ul>
                            </div>
                        `;
                    });
                } else {
                    contentHtml = '<p>No TMS daily questionnaires found for this specific logged-in patient.</p>';
                }
            } else if (dataType === 'bookedAppointments') {
                const appointmentsSnapshot = await get(ref(database, 'appointments'));
                const bookedAppointments = [];
                if (appointmentsSnapshot.exists()) {
                    appointmentsSnapshot.forEach(child => {
                        const appt = child.val();
                        if (appt.userId === patientId && appt.status && appt.status.trim() === 'approved') {
                            bookedAppointments.push(appt);
                        }
                    });
                }
                
                bookedAppointments.sort((a, b) => {
                    const dateA = new Date(`${a.appointmentDate}T${a.appointmentTime}`);
                    const dateB = new Date(`${b.appointmentDate}T${b.appointmentTime}`);
                    return dateB - dateA;
                });

                if (bookedAppointments.length > 0) {
                    hasResults = true;
                    contentHtml += '<h3 style="margin-bottom: 15px;">Booked Appointments:</h3>';
                    bookedAppointments.forEach(appt => {
                        const displayDateTime = appt.appointmentDate && appt.appointmentTime
                            ? `${new Date(appt.appointmentDate).toLocaleDateString()} at ${appt.appointmentTime}`
                            : appt.time || 'N/A';
                        contentHtml += `
                            <div class="appointment-card booked-appt-card" style="margin-bottom: 15px;">
                                <h4>Appointment on ${displayDateTime}</h4>
                                <p><strong>Date of Birth:</strong> ${appt.dob || 'N/A'}</p>
                                <p><strong>Reason:</strong> ${appt.reason}</p>
                                <p style="font-size: 0.8em; opacity: 0.8;">Approved on: ${new Date(appt.createdAt).toLocaleString()}</p>
                            </div>
                        `;
                    });
                } else {
                    contentHtml = '<p>No booked appointments found for this patient.</p>';
                }

            } else {
                contentHtml = '<p>Invalid data type requested.</p>';
                console.error("Admin: Invalid dataType provided to loadPatientDataSection:", dataType);
            }

            resultsContainer.innerHTML = contentHtml;
            console.log(`Admin: ${dataType} loaded for patient ID:`, patientId);
        }

        // NEW: Delete TMS Submission Function
        async function deleteTmsSubmission(submissionId, submissionPath, userIdForUserSubmission = null) {
            if (!currentUser || !isAdmin) {
                showMessage('Unauthorized action.', true);
                return;
            }

            const pathToDelete = userIdForUserSubmission ? `${submissionPath}/${userIdForUserSubmission}/${submissionId}` : `${submissionPath}/${submissionId}`;

            showConfirmationModal(
                `Are you sure you want to permanently delete this TMS questionnaire submission (ID: ${submissionId})? This action cannot be undone.`,
                async () => { // On Confirm
                    try {
                        await remove(ref(database, pathToDelete));
                        showMessage('TMS submission deleted successfully!');
                        console.log(`Admin: TMS submission deleted from ${pathToDelete}`);
                        loadAdminTmsSubmissions(); // Refresh the list
                    } catch (error) {
                        console.error("Admin: Error deleting TMS submission:", error);
                        showMessage(`Error deleting TMS submission: ${error.message}`, true);
                    }
                },
                () => { // On Cancel
                    showMessage('TMS submission deletion cancelled.');
                }
            );
        }

        // NEW: Load all TMS Submissions for Admin Portal
        async function loadAdminTmsSubmissions() {
            const tmsSubmissionsListDiv = document.getElementById('tmsSubmissionsList');
            if (!currentUser || !isAdmin) {
                tmsSubmissionsListDiv.innerHTML = '<p>Unauthorized access. Please log in as Admin.</p>';
                return;
            }
            console.log("Admin: Loading all TMS submissions.");
            tmsSubmissionsListDiv.innerHTML = '<p>Loading TMS submissions...</p>'; // Show loading

            let allTmsSubmissions = [];

            // 1. Fetch from logged-in users' paths
            try {
                const patientsSnapshot = await get(ref(database, 'patients'));
                if (patientsSnapshot.exists()) {
                    for (const userId in patientsSnapshot.val()) {
                        const userTmsSnapshot = await get(ref(database, `tmsQuestionnaires/${userId}`));
                        if (userTmsSnapshot.exists()) {
                            userTmsSnapshot.forEach(childSnapshot => {
                                const submission = childSnapshot.val();
                                allTmsSubmissions.push({ id: childSnapshot.key, fromUser: userId, ...submission });
                            });
                        }
                    }
                }
            } catch (error) {
                console.error("Admin: Error fetching logged-in TMS submissions:", error);
            }

            // 2. Fetch from public submissions path
            try {
                const publicTmsSnapshot = await get(ref(database, 'publicTmsQuestionnaires'));
                if (publicTmsSnapshot.exists()) {
                    publicTmsSnapshot.forEach(childSnapshot => {
                        const submission = childSnapshot.val();
                        allTmsSubmissions.push({ id: childSnapshot.key, fromUser: 'public', ...submission });
                    });
                }
            } catch (error) {
                console.error("Admin: Error fetching public TMS submissions:", error);
            }

            allTmsSubmissions.sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt)); // Sort by most recent

            tmsSubmissionsListDiv.innerHTML = ''; // Clear loading message

            if (allTmsSubmissions.length > 0) {
                allTmsSubmissions.forEach(submission => {
                    const submittedByInfo = submission.fromUser === 'public'
                        ? `<strong>Public Submission</strong>`
                        : `<strong>Logged-in User</strong>`; // User ID already in button data-user-id

                    tmsSubmissionsListDiv.innerHTML += `
                        <div class="tms-submission-card">
                            <div>
                                <h4>TMS Questionnaire from ${submission.fullName || 'Anonymous'} (${submittedByInfo})</h4>
                                <p><strong>Email:</strong> ${submission.email || 'N/A'}</p>
                                <p><strong>Phone:</strong> ${submission.phoneNumber || 'N/A'}</p>
                                <p><strong>Submitted On:</strong> ${new Date(submission.submittedAt).toLocaleString()}</p>
                            </div>
                            <div class="card-actions">
                                <button class="btn btn-view-details" data-submission-id="${submission.id}" data-submission-path="${submission.fromUser === 'public' ? 'publicTmsQuestionnaires' : `tmsQuestionnaires`}" data-user-id="${submission.fromUser === 'public' ? '' : submission.fromUser}">View Details</button>
                                <i class="fas fa-trash-alt btn-delete" data-id="${submission.id}" data-type="${submission.fromUser === 'public' ? 'publicTms' : 'userTms'}" data-user-id="${submission.fromUser === 'public' ? '' : submission.fromUser}"></i>
                            </div>
                        </div>
                    `;
                });

                // Attach event listeners for "View Details" buttons
                document.querySelectorAll('.tms-submission-card .btn-view-details').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const submissionId = event.target.dataset.submissionId;
                        const submissionPath = event.target.dataset.submissionPath;
                        const userId = event.target.dataset.userId || null;
                        viewTmsSubmissionDetails(submissionId, submissionPath, userId);
                    });
                });

                // Attach event listeners for "Delete" buttons
                document.querySelectorAll('.tms-submission-card .btn-delete').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const submissionId = event.target.dataset.id;
                        const submissionType = event.target.dataset.type; // 'publicTms' or 'userTms'
                        const userId = event.target.dataset.userId || null;
                        deleteTmsSubmission(submissionId, submissionType === 'publicTms' ? 'publicTmsQuestionnaires' : 'tmsQuestionnaires', userId);
                    });
                });

            } else {
                tmsSubmissionsListDiv.innerHTML = '<p>No TMS Daily Questionnaires found.</p>';
            }
            console.log("Admin: TMS submissions loaded. Total:", allTmsSubmissions.length);
        }

        // NEW: Function to display full TMS submission details in a modal
        async function viewTmsSubmissionDetails(submissionId, submissionPath, userId) {
            console.log("Admin: Viewing TMS submission details for ID:", submissionId, "Path:", submissionPath, "User ID:", userId);
            try {
                const path = userId ? `${submissionPath}/${userId}/${submissionId}` : `${submissionPath}/${submissionId}`;
                const submissionSnapshot = await get(ref(database, path));
                const submission = submissionSnapshot.val();

                if (submission) {
                    document.getElementById('tmsModalPatientName').textContent = submission.fullName || 'Anonymous';
                    document.getElementById('tmsModalPatientEmail').textContent = submission.email || 'N/A';
                    document.getElementById('tmsModalPatientPhone').textContent = submission.phoneNumber || 'N/A';
                    document.getElementById('tmsModalSubmittedAt').textContent = new Date(submission.submittedAt).toLocaleString();
                    
                    const answersDiv = document.getElementById('tmsModalAnswers');
                    answersDiv.innerHTML = '<h4>Questionnaire Answers:</h4>';
                    // Reconstruct answers in desired order
                    const orderedAnswerKeys = [
                        'q1_eat_drink', 'q1_eat_drink_details',
                        'q2_med_prescribed', 'q2a_med_changes', 'q2a_med_changes_details',
                        'q3_sleep_hours',
                        'q4_caffeine', 'q4_caffeine_details',
                        'q5_alcohol', 'q5_alcohol_details',
                        'q_unprescribed_substance', // Added the new question
                        'q6_metal_head', 'q6_metal_head_details'
                    ];

                    orderedAnswerKeys.forEach(key => {
                        if (submission.answers.hasOwnProperty(key) && submission.answers[key] !== undefined && submission.answers[key] !== null && submission.answers[key] !== '') {
                            let readableQuestion = '';
                            let answerValue = submission.answers[key];

                            switch(key) {
                                case 'q1_eat_drink': readableQuestion = '1. Had anything to eat/drink:'; break;
                                case 'q1_eat_drink_details': readableQuestion = 'Details (Q1):'; break;
                                case 'q2_med_prescribed': readableQuestion = '3. Meds as prescribed:'; break;
                                case 'q2a_med_changes': readableQuestion = '3a. Med Changes:'; break;
                                case 'q2a_med_changes_details': readableQuestion = 'Details (Q3a):'; break;
                                case 'q3_sleep_hours': readableQuestion = '4. Sleep hours:'; break;
                                case 'q4_caffeine': readableQuestion = '5. Caffeine intake:'; break;
                                case 'q4_caffeine_details': readableQuestion = 'Details (Q5):'; break;
                                case 'q5_alcohol': readableQuestion = '6. Alcohol intake:'; break;
                                case 'q5_alcohol_details': readableQuestion = 'Details (Q6):'; break;
                                case 'q_unprescribed_substance': readableQuestion = '2. Unprescribed substances consumed:'; break; // Added new question text
                                case 'q6_metal_head': readableQuestion = '7. Metal in head:'; break;
                                case 'q6_metal_head_details': readableQuestion = 'Details (Q7):'; break;
                                default: readableQuestion = key.replace(/([A-Z])/g, ' $1').replace(/_/g, ' ').replace(/^q\d+\s*/, '').trim() + ':';
                            }
                            answersDiv.innerHTML += `<p><strong>${readableQuestion}</strong> ${answerValue}</p>`;
                        }
                    });

                    // Set up "Move to Patient" button and dropdown
                    const moveBtn = document.getElementById('moveTmsToPatientBtn');
                    const assignSection = document.getElementById('assignTmsToPatientSection');
                    const patientDropdown = document.getElementById('tmsPatientSelectDropdown');
                    const confirmAssignBtn = document.getElementById('confirmTmsAssignmentBtn');

                    moveBtn.onclick = () => {
                        assignSection.classList.toggle('hidden');
                        if (!assignSection.classList.contains('hidden')) {
                            populatePatientDropdown(patientDropdown);
                        }
                    };

                    confirmAssignBtn.onclick = () => {
                        const newPatientId = patientDropdown.value;
                        if (newPatientId) {
                            assignSubmissionToPatient(submissionId, 'tms', userId, newPatientId);
                            document.getElementById('tmsDetailModal').classList.add('hidden'); // Close modal after action
                        } else {
                            showMessage('Please select a patient to assign to.', true);
                        }
                    };


                    document.getElementById('tmsDetailModal').classList.remove('hidden');
                    console.log("Admin: TMS submission details modal displayed for:", submission.fullName);
                } else {
                    showMessage('TMS submission details not found.', true);
                    console.error("Admin: TMS submission not found for ID:", submissionId, "Path:", path);
                }
            } catch (error) {
                console.error("Admin: Error fetching TMS submission details:", error);
                showMessage(`Error fetching TMS submission details: ${error.message}`, true);
            }
        }

        // NEW: Delete Mental Health Test Submission Function
        async function deleteMentalHealthTestSubmission(submissionId, submissionType, userIdForUserSubmission = null) {
            if (!currentUser || !isAdmin) {
                showMessage('Unauthorized action.', true);
                return;
            }

            let pathToDelete;
            if (submissionType === 'public-anonymous' || submissionType === 'logged-in-copy') {
                pathToDelete = `publicMentalHealthTestSubmissions/${submissionId}`;
            } else if (submissionType === 'logged-in-original' && userIdForUserSubmission) {
                pathToDelete = `testResults/${submissionId}`;
            } else {
                showMessage('Invalid submission type or user ID for deletion.', true);
                return;
            }

            showConfirmationModal(
                `Are you sure you want to permanently delete this Mental Health Test submission (ID: ${submissionId})? This action cannot be undone.`,
                async () => { // On Confirm
                    try {
                        await remove(ref(database, pathToDelete));
                        showMessage('Mental Health Test submission deleted successfully!');
                        console.log(`Admin: Mental Health Test submission deleted from ${pathToDelete}`);
                        loadAdminPublicTestResults(); // Refresh the list
                    } catch (error) {
                        console.error("Admin: Error deleting Mental Health Test submission:", error);
                        showMessage(`Error deleting Mental Health Test submission: ${error.message}`, true);
                    }
                },
                () => { // On Cancel
                    showMessage('Mental Health Test submission deletion cancelled.');
                }
            );
        }


        // NEW: Load all Mental Health Test Submissions for Admin Portal (Combined view)
        async function loadAdminPublicTestResults() {
            const publicTestResultsListDiv = document.getElementById('publicTestResultsList');
            if (!currentUser || !isAdmin) {
                publicTestResultsListDiv.innerHTML = '<p>Unauthorized access. Please log in as Admin.</p>';
                return;
            }
            console.log("Admin: Loading all mental health test submissions (public and logged-in).");
            publicTestResultsListDiv.innerHTML = '<p>Loading mental health test results...</p>'; // Show loading

            let allTestSubmissions = [];

            // 1. Fetch from public submissions path (anonymous and logged-in copies)
            try {
                const publicTestsSnapshot = await get(ref(database, 'publicMentalHealthTestSubmissions'));
                if (publicTestsSnapshot.exists()) {
                    publicTestsSnapshot.forEach(childSnapshot => {
                        const submission = childSnapshot.val();
                        allTestSubmissions.push({
                            id: childSnapshot.key,
                            type: submission.userId ? 'logged-in-copy' : 'public-anonymous', // Differentiate copied logged-in from truly anonymous
                            testType: submission.testType,
                            score: submission.score,
                            breakdown: submission.breakdown,
                            answers: submission.answers,
                            submittedAt: submission.submittedAt,
                            userId: submission.userId || null,
                            fullName: submission.fullName || 'Anonymous User', // Use the name from the public submission
                            email: submission.email || 'N/A',
                            phoneNumber: submission.phoneNumber || 'N/A'
                        });
                    });
                }
            } catch (error) {
                console.error("Admin: Error fetching public mental health test submissions:", error);
            }

            // 2. Fetch from logged-in users' testResults path (original source)
            try {
                const loggedInTestsSnapshot = await get(ref(database, 'testResults'));
                if (loggedInTestsSnapshot.exists()) {
                    const patientPromises = [];
                    const tempLoggedInSubmissions = [];

                    loggedInTestsSnapshot.forEach(childSnapshot => {
                        const submission = childSnapshot.val();
                        if (submission.userId) {
                            tempLoggedInSubmissions.push({ id: childSnapshot.key, ...submission });
                            patientPromises.push(get(ref(database, 'patients/' + submission.userId)));
                        }
                    });

                    const patientSnapshots = await Promise.all(patientPromises);
                    const patientMap = {};
                    patientSnapshots.forEach(snap => {
                        if (snap.exists()) {
                            patientMap[snap.key] = snap.val(); // Store full patient data
                        }
                    });

                    tempLoggedInSubmissions.forEach(submission => {
                        const patientData = patientMap[submission.userId];
                        // Add original logged-in submission for comprehensive view
                        allTestSubmissions.push({
                            id: submission.id,
                            type: 'logged-in-original',
                            testType: submission.testType,
                            score: submission.score,
                            breakdown: submission.breakdown,
                            answers: submission.answers,
                            submittedAt: submission.createdAt,
                            userId: submission.userId,
                            fullName: patientData ? patientData.fullName : 'Unknown Logged-in User',
                            email: patientData ? patientData.email : 'N/A',
                            phoneNumber: patientData ? patientData.phoneNumber : 'N/A'
                        });
                    });
                }
            } catch (error) {
                console.error("Admin: Error fetching logged-in mental health test submissions:", error);
            }

            // Sort all submissions by date (most recent first)
            allTestSubmissions.sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt));

            publicTestResultsListDiv.innerHTML = ''; // Clear loading message

            if (allTestSubmissions.length > 0) {
                // Deduplicate: Prefer 'logged-in-original' over 'logged-in-copy' if they represent the same test.
                // For simplicity, we'll just check for similarity in content and date.
                const uniqueSubmissions = [];
                const seenKeys = new Set(); // Stores a key like "testType-score-submittedAt-userId"

                for (const submission of allTestSubmissions) {
                    const key = `${submission.testType}-${submission.score}-${submission.submittedAt}-${submission.userId || 'anonymous'}`;
                    
                    // If we haven't seen this exact key, or if this is an 'original' and the seen one is just a 'copy'
                    if (!seenKeys.has(key)) {
                        uniqueSubmissions.push(submission);
                        seenKeys.add(key);
                    }
                }
                uniqueSubmissions.sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt)); // Re-sort after deduplication

                uniqueSubmissions.forEach(submission => {
                    const submitterName = submission.fullName || (submission.userId ? `Logged-in User (${submission.userId})` : 'Anonymous User');
                    const submissionOrigin = submission.type === 'public-anonymous' ? 'Quick Access' : 'Patient Portal';

                    publicTestResultsListDiv.innerHTML += `
                        <div class="public-test-submission-card">
                            <div>
                                <h4>${submission.testType} - Submitted from ${submissionOrigin} on: ${new Date(submission.submittedAt).toLocaleString()}</h4>
                                <p><strong>Submitted By:</strong> ${submitterName}</p>
                                <p><strong>Email:</strong> ${submission.email}</p>
                                <p><strong>Phone:</strong> ${submission.phoneNumber}</p>
                                <p><strong>Score:</strong> ${submission.score}</p>
                                <p><strong>Breakdown:</strong> ${submission.breakdown}</p>
                            </div>
                            <div class="card-actions">
                                <button class="btn btn-view-details"
                                    data-submission-id="${submission.id}"
                                    data-submission-type="${submission.type}"
                                    data-user-id="${submission.userId || ''}">View Details</button>
                                <i class="fas fa-trash-alt btn-delete"
                                    data-id="${submission.id}"
                                    data-type="${submission.type}"
                                    data-user-id="${submission.userId || ''}"></i>
                            </div>
                        </div>
                    `;
                });

                // Attach event listeners for "View Details" buttons
                document.querySelectorAll('#publicTestResultsList .btn-view-details').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const submissionId = event.target.dataset.submissionId;
                        const submissionType = event.target.dataset.submissionType;
                        const userId = event.target.dataset.userId || null;
                        viewPublicTestSubmissionDetails(submissionId, submissionType, userId);
                    });
                });

                // Attach event listeners for "Delete" buttons
                document.querySelectorAll('#publicTestResultsList .btn-delete').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const submissionId = event.target.dataset.id;
                        const submissionType = event.target.dataset.type;
                        const userId = event.target.dataset.userId || null;
                        deleteMentalHealthTestSubmission(submissionId, submissionType, userId);
                    });
                });

            } else {
                publicTestResultsListDiv.innerHTML = '<p>No mental health test results found.</p>';
            }
            console.log("Admin: Combined mental health test submissions loaded. Total unique displayed:", uniqueSubmissions.length);

        }

        // NEW: Function to display full Public Test submission details in a modal (now supports combined data)
        async function viewPublicTestSubmissionDetails(submissionId, submissionType, userId) {
            console.log("Admin: Viewing test submission details for ID:", submissionId, "Type:", submissionType, "User ID:", userId);
            try {
                let submission;
                let originalPath = ''; // To store the path for assignment logic

                // Determine the correct Firebase path based on the submission type
                if (submissionType === 'public-anonymous' || submissionType === 'logged-in-copy') {
                    originalPath = `publicMentalHealthTestSubmissions/${submissionId}`;
                    const snapshot = await get(ref(database, originalPath));
                    submission = snapshot.val();
                } else if (submissionType === 'logged-in-original' && userId) {
                    originalPath = `testResults/${submissionId}`;
                    const snapshot = await get(ref(database, originalPath));
                    submission = snapshot.val();
                }

                if (submission) {
                    let finalFullName = submission.fullName || 'Anonymous User';
                    let finalEmail = submission.email || 'N/A';
                    let finalPhone = submission.phoneNumber || 'N/A';

                    // If it's an 'original' logged-in submission, ensure we fetch the contact info
                    if (submissionType === 'logged-in-original' && submission.userId) {
                        const patientSnapshot = await get(ref(database, `patients/${submission.userId}`));
                        const patientData = patientSnapshot.val();
                        if (patientData) {
                            finalFullName = patientData.fullName;
                            finalEmail = patientData.email;
                            finalPhone = patientData.phoneNumber;
                        }
                    }

                    document.getElementById('publicTestModalType').textContent = submission.testType;
                    document.getElementById('publicTestModalSubmitter').textContent = finalFullName;
                    document.getElementById('publicTestModalSubmitterEmail').textContent = finalEmail;
                    document.getElementById('publicTestModalSubmitterPhone').textContent = finalPhone;
                    document.getElementById('publicTestModalScore').textContent = submission.score;
                    document.getElementById('publicTestModalBreakdown').textContent = submission.breakdown;
                    document.getElementById('publicTestModalSubmittedAt').textContent = new Date(submission.submittedAt || submission.createdAt).toLocaleString(); // Use createdAt for logged-in original

                    const answersDiv = document.getElementById('publicTestModalAnswers');
                    answersDiv.innerHTML = '<h4>Questionnaire Answers:</h4>';
                    if (submission.answers && Array.isArray(submission.answers)) {
                        submission.answers.forEach((ans, index) => {
                            answersDiv.innerHTML += `<p><strong>${index + 1}. ${ans.question}:</strong> ${ans.answer} (Score: ${ans.score})</p>`;
                        });
                    } else {
                        answersDiv.innerHTML += '<p>No detailed answers available.</p>';
                    }

                    // Set up "Move to Patient" button and dropdown
                    const moveBtn = document.getElementById('movePublicTestToPatientBtn');
                    const assignSection = document.getElementById('assignPublicTestToPatientSection');
                    const patientDropdown = document.getElementById('publicTestPatientSelectDropdown');
                    const confirmAssignBtn = document.getElementById('confirmPublicTestAssignmentBtn');

                    // Only show "Move to Patient" if it's a public-anonymous submission
                    if (submissionType === 'public-anonymous') {
                        moveBtn.classList.remove('hidden');
                        moveBtn.onclick = () => {
                            assignSection.classList.toggle('hidden');
                            if (!assignSection.classList.contains('hidden')) {
                                populatePatientDropdown(patientDropdown);
                            }
                        };
                        confirmAssignBtn.onclick = () => {
                            const newPatientId = patientDropdown.value;
                            if (newPatientId) {
                                assignSubmissionToPatient(submissionId, 'mentalHealthTest', null, newPatientId); // currentUserId is null for public-anonymous
                                document.getElementById('publicTestDetailModal').classList.add('hidden'); // Close modal after action
                            } else {
                                showMessage('Please select a patient to assign to.', true);
                            }
                        };
                    } else {
                        moveBtn.classList.add('hidden'); // Hide if not public-anonymous
                        assignSection.classList.add('hidden'); // Ensure assignment section is hidden
                    }


                    document.getElementById('publicTestDetailModal').classList.remove('hidden');
                    console.log("Admin: Mental health test submission details modal displayed for:", submission.testType);
                } else {
                    showMessage('Mental health test submission details not found.', true);
                    console.error("Admin: Test submission not found for ID:", submissionId, "Type:", submissionType);
                }
            } catch (error) {
                console.error("Admin: Error fetching mental health test submission details:", error);
                showMessage(`Error fetching test submission details: ${error.message}`, true);
            }
        }

        // NEW: Function to populate patient dropdowns
        async function populatePatientDropdown(dropdownElement) {
            // Ensure allPatientsData is loaded
            if (allPatientsData.length === 0) {
                const patientsSnapshot = await get(ref(database, 'patients'));
                if (patientsSnapshot.exists()) {
                    allPatientsData = Object.keys(patientsSnapshot.val()).map(key => ({ id: key, ...patientsSnapshot.val()[key] }));
                    // Filter out "Jane Doe" and "user testing"
                    allPatientsData = allPatientsData.filter(patient =>
                        patient.fullName !== "Jane Doe" && patient.fullName !== "user testing"
                    );
                    allPatientsData.sort((a, b) => a.fullName.localeCompare(b.fullName));
                }
            }

            dropdownElement.innerHTML = '<option value="">Select a Patient</option>';
            allPatientsData.forEach(patient => {
                const option = document.createElement('option');
                option.value = patient.id;
                option.textContent = `${patient.fullName} (${patient.email})`;
                dropdownElement.appendChild(option);
            });
            console.log("Admin: Patient dropdown populated.");
        }

        // NEW: Function to assign a submission (TMS or Mental Health Test) to a specific patient
        async function assignSubmissionToPatient(submissionId, submissionType, currentUserId, newPatientId) {
            if (!currentUser || !isAdmin) {
                showMessage('Unauthorized action.', true);
                return;
            }
            if (!newPatientId) {
                showMessage('Please select a patient to assign the submission to.', true);
                return;
            }

            console.log(`Admin: Attempting to assign ${submissionType} submission ${submissionId} to patient ${newPatientId}`);

            try {
                let originalSubmissionPath;
                let targetCollectionPath;
                let submissionData;

                if (submissionType === 'tms') {
                    originalSubmissionPath = currentUserId ? `tmsQuestionnaires/${currentUserId}/${submissionId}` : `publicTmsQuestionnaires/${submissionId}`;
                    targetCollectionPath = `tmsQuestionnaires/${newPatientId}`;
                } else if (submissionType === 'mentalHealthTest') {
                    originalSubmissionPath = currentUserId ? `testResults/${submissionId}` : `publicMentalHealthTestSubmissions/${submissionId}`;
                    targetCollectionPath = `testResults`; // Mental health tests are flat under testResults
                } else {
                    showMessage('Invalid submission type for assignment.', true);
                    return;
                }

                // 1. Fetch the original submission data
                const originalSnapshot = await get(ref(database, originalSubmissionPath));
                if (!originalSnapshot.exists()) {
                    showMessage('Original submission not found.', true);
                    return;
                }
                submissionData = originalSnapshot.val();

                // 2. Get the new patient's details
                const newPatientSnapshot = await get(ref(database, `patients/${newPatientId}`));
                if (!newPatientSnapshot.exists()) {
                    showMessage('Target patient not found.', true);
                    return;
                }
                const newPatientData = newPatientSnapshot.val();

                // 3. Prepare data for the new entry, updating contact info
                const newSubmissionData = {
                    ...submissionData,
                    userId: newPatientId,
                    fullName: newPatientData.fullName,
                    email: newPatientData.email,
                    phoneNumber: newPatientData.phoneNumber,
                    // Preserve original submittedAt/createdAt
                    submittedAt: submissionData.submittedAt || submissionData.createdAt,
                    createdAt: submissionData.createdAt || submissionData.submittedAt // Ensure createdAt is present for testResults
                };

                // 4. Push the new entry to the target patient's path
                const newEntryRef = push(ref(database, targetCollectionPath));
                await set(newEntryRef, newSubmissionData);
                console.log(`Admin: New entry created at ${newEntryRef.toString()}`);

                // 5. Delete the original submission
                await remove(ref(database, originalSubmissionPath));
                console.log(`Admin: Original submission deleted from ${originalSubmissionPath}`);

                showMessage('Submission successfully assigned to the selected patient!');

                // Refresh relevant admin lists
                if (submissionType === 'tms') {
                    loadAdminTmsSubmissions();
                } else if (submissionType === 'mentalHealthTest') {
                    loadAdminPublicTestResults();
                }
                // If patient details view is open, refresh that too
                if (currentPatientIdInAdminView === newPatientId) {
                    loadPatientDataSection(newPatientId, submissionType === 'tms' ? 'tmsQuestionnaires' : 'mentalHealthTests');
                }

            } catch (error) {
                console.error("Admin: Error assigning submission to patient:", error);
                showMessage(`Error assigning submission: ${error.message}`, true);
            }
        }


        // Helper to parse old string format (e.g., "Thursday 1-2 PM") to a Date object
        function getNextOccurringDateTime(dayTimeString) {
            console.log("Calendar: Attempting to parse legacy time string:", dayTimeString);
            const now = new Date();
            const daysOfWeek = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            
            const dayPartMatch = dayTimeString.match(/^(monday|tuesday|wednesday|thursday|friday|saturday|sunday)/i);
            const timePartMatch = dayTimeString.match(/(\d+)(?:-\d+)?\s*(AM|PM)/i);

            if (!dayPartMatch || !timePartMatch) {
                console.warn("Calendar: Could not parse old time format for getNextOccurringDateTime:", dayTimeString, "Returning null.");
                return null;
            }

            const targetDayName = dayPartMatch[1].toLowerCase();
            const targetDayIndex = daysOfWeek.indexOf(targetDayName);

            let hour = parseInt(timePartMatch[1]);
            const ampm = timePartMatch[2] ? timePartMatch[2].toLowerCase() : '';

            if (ampm === 'pm' && hour < 12) hour += 12;
            if (ampm === 'am' && hour === 12) hour = 0; // 12 AM (midnight) is 0 hour

            // Start with today's date components, then set the target hour and minute
            let resultDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            resultDate.setHours(hour, 0, 0, 0); // Set desired time for today

            let currentDayIndex = resultDate.getDay();
            let dayDifference = targetDayIndex - currentDayIndex;

            if (dayDifference < 0 || (dayDifference === 0 && resultDate.getTime() < now.getTime())) {
                dayDifference += 7;
            }

            resultDate.setDate(resultDate.getDate() + dayDifference);
            console.log("Calendar: Parsed legacy time string to Date object (local timezone):", resultDate.toLocaleString());
            return resultDate; // Return the Date object
        }


        // NEW: Function to update appointment date and time in Firebase
        async function updateAppointmentDateTime(appointmentId, newStart, newEnd) {
            console.log(`Calendar: Updating appointment ${appointmentId} to start: ${newStart.toISOString()}, end: ${newEnd.toISOString()}`);
            try {
                // Format newStart back to YYYY-MM-DD and HH:MM strings for Firebase
                const newDateStr = newStart.toISOString().split('T')[0]; // YYYY-MM-DD
                const newTimeStr = newStart.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hourCycle: 'h23' }); // HH:MM (24-hour format)

                // Update the Firebase record
                await update(ref(database, `appointments/${appointmentId}`), {
                    appointmentDate: newDateStr,
                    appointmentTime: newTimeStr
                    // Note: We don't store 'end' in Firebase for simplicity,
                    // as it's typically derived as +1 hour from start.
                    // If your appointments can have variable durations, you might need to store `durationMinutes` or `appointmentEndTime`.
                });
                showMessage('Appointment updated successfully!');
                console.log(`Calendar: Appointment ${appointmentId} updated in Firebase.`);
            } catch (error) {
                console.error("Calendar: Error updating appointment date/time in Firebase:", error);
                showMessage(`Error updating appointment: ${error.message}`, true);
            }
        }


        // Load Approved Appointments for Admin Calendar (Now integrates FullCalendar)
        function loadAdminCalendar() {
            const calendarEl = document.getElementById('calendar');
            const eventDetailsModal = document.getElementById('eventDetailsModal');
            const closeModalBtn = document.getElementById('closeModalBtn');

            if (!currentUser || !isAdmin) {
                calendarEl.innerHTML = '<p>Unauthorized access. Please log in as Admin.</p>';
                if (adminCalendarInstance) {
                    adminCalendarInstance.destroy();
                    adminCalendarInstance = null;
                }
                console.log("Calendar: Unauthorized or not admin, destroying/not initializing calendar.");
                return;
            }

            console.log("Calendar: Attempting to initialize/Reload FullCalendar for approved appointments.");

            if (adminCalendarInstance) {
                adminCalendarInstance.destroy(); // Destroy previous instance to prevent re-rendering issues
                adminCalendarInstance = null;
                console.log("Calendar: Destroyed existing FullCalendar instance.");
            }

            adminCalendarInstance = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                navLinks: true,
                editable: true, // <--- CHANGED: Enable dragging and resizing
                selectable: false,
                dayMaxEvents: true,
                datesSet: function(dateInfo) {
                    console.log("Calendar: Current date range set:", dateInfo.startStr, "to", dateInfo.endStr);
                },

                eventContent: function(arg) {
                    // Robust check to ensure classNames is always an array
                    const classNames = Array.isArray(arg.event.classNames) ? arg.event.classNames : [];
                    
                    if (classNames.includes('approved-event')) {
                        return { html: `<div class="event-circle"></div><span>${arg.event.title}</span>` };
                    }
                    return { html: `<span>${arg.event.title}</span>` };
                },
                events: async function(fetchInfo, successCallback, failureCallback) {
                    console.log("Calendar: events callback fired. Fetching approved appointments from Firebase for range:", fetchInfo.startStr, "to", fetchInfo.endStr);
                    // Use onValue to listen for real-time updates
                    onValue(ref(database, 'appointments'), async (snapshot) => {
                        const rawSnapshotData = snapshot.val();
                        console.log("Calendar: Raw appointments snapshot data (from Firebase):", JSON.stringify(rawSnapshotData, null, 2));

                        const events = [];
                        if (rawSnapshotData) {
                            const appointmentsArray = Object.keys(rawSnapshotData).map(key => ({ id: key, ...rawSnapshotData[key] }));
                            // CRITICAL FIX: Ensure status is trimmed and explicitly 'approved'
                            const approvedAppointments = appointmentsArray.filter(appt => appt.status && appt.status.trim() === 'approved');
                            console.log("Calendar: Filtered approved appointments (after trim):", approvedAppointments);

                            const patientPromises = approvedAppointments.map(appt => get(ref(database, 'patients/' + appt.userId)));
                            const patientMap = {};
                            patientSnapshots.forEach(snap => {
                                if (snap.exists()) {
                                    patientMap[snap.key] = snap.val().fullName || 'Unknown Patient';
                                }
                            });
                            console.log("Calendar: Patient map for event titles:", patientMap);

                            approvedAppointments.forEach(appt => {
                                let eventStart;
                                let eventEnd;
                                let eventTitle;
                                let displayTimeForModal;
                                
                                const patientFirstName = patientMap[appt.userId] ? patientMap[appt.userId].split(' ')[0] : 'N/A';

                                // Case 1: New appointments with precise date and time (YYYY-MM-DD and HH:MM)
                                if (appt.appointmentDate && appt.appointmentTime) {
                                    // Construct Date object in local time
                                    const year = parseInt(appt.appointmentDate.substring(0, 4));
                                    const month = parseInt(appt.appointmentDate.substring(5, 7)) - 1; // Month is 0-indexed
                                    const day = parseInt(appt.appointmentDate.substring(8, 10));
                                    const hour = parseInt(appt.appointmentTime.substring(0, 2));
                                    const minute = parseInt(appt.appointmentTime.substring(3, 5));

                                    const startDateTime = new Date(year, month, day, hour, minute, 0, 0);
                                    
                                    // Calculate end time by adding 1 hour to the local time
                                    const endDateTime = new Date(startDateTime); 
                                    endDateTime.setHours(startDateTime.getHours() + 1);

                                    eventStart = startDateTime;
                                    eventEnd = endDateTime;
                                    
                                    console.log(`Calendar: Debugging NEW event times for ID ${appt.id}. ` + 
                                                `Original Firebase: ${appt.appointmentDate} ${appt.appointmentTime}, ` +
                                                `Start (local Date object): ${eventStart.toLocaleString()}, ` +
                                                `End (local Date object, +1hr): ${endDateTime.toLocaleString()}`);
                                    
                                    displayTimeForModal = startDateTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                                    eventTitle = `Appt with ${patientFirstName}`; 

                                    console.log(`Calendar: Event (NEW) ID: ${appt.id}, Title: "${eventTitle}", Start (Date object): "${eventStart}", End (Date object): "${eventEnd}"`);

                                } 
                                // Case 2: Legacy appointments with only day and time string (e.g., "Friday 1-2 PM")
                                else if (appt.time) {
                                    const inferredDate = getNextOccurringDateTime(appt.time); 
                                    if (inferredDate) {
                                        eventStart = inferredDate;
                                        const endDateTime = new Date(inferredDate.getTime() + 60 * 60 * 1000); 
                                        eventEnd = endDateTime;
                                        
                                        displayTimeForModal = appt.time; 
                                        eventTitle = `Appt (Legacy) ${patientFirstName}`;
                                        console.log(`Calendar: Event (LEGACY) ID: ${appt.id}, Title: "${eventTitle}", Inferred Start (local): "${eventStart.toLocaleString()}", Inferred End (local): "${endDateTime.toLocaleString()}"`);
                                    } else {
                                        console.error(`Calendar: Could not infer date for legacy appointment ID ${appt.id} with time: ${appt.time}. Skipping event.`);
                                        return; 
                                    }
                                } else {
                                    console.error(`Calendar: Appointment ID ${appt.id} missing valid date/time information. Skipping event.`);
                                    return; 
                                }
                                
                                events.push({
                                    id: appt.id,
                                    title: eventTitle,
                                    start: eventStart, 
                                    end: eventEnd,    
                                    allDay: false, 
                                    classNames: ['approved-event'], 
                                    extendedProps: { 
                                        patientName: patientMap[appt.userId] || 'N/A',
                                        patientEmail: appt.email,
                                        patientPhone: appt.phoneNumber,
                                        dob: appt.dob || 'N/A', 
                                        reason: appt.reason,
                                        status: appt.status,
                                        displayTime: displayTimeForModal, 
                                        originalApptDate: appt.appointmentDate 
                                    }
                                });
                            });
                        }
                        console.log("Calendar: Final events array passed to FullCalendar:", events);
                        successCallback(events); 
                    }, (error) => {
                        console.error("Calendar: Error fetching appointments from Firebase:", error);
                        failureCallback(error); 
                    });
                },
                eventClick: function(info) {
                    console.log("Calendar: Event clicked:", info.event.id, info.event.title);
                    const event = info.event;
                    const props = event.extendedProps;
                    
                    let startDateTime = null;
                    if (event.start instanceof Date && !isNaN(event.start.getTime())) {
                        startDateTime = event.start;
                    } else {
                        console.warn("Calendar: Event start date is not a valid Date object for event:", event.id, event.start);
                        startDateTime = new Date(); 
                    }

                    const formattedDate = startDateTime.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                    
                    document.getElementById('modalEventTitle').textContent = `Appointment with ${props.patientName}`;
                    document.getElementById('modalPatientName').textContent = props.patientName;
                    document.getElementById('modalPatientEmail').textContent = props.patientEmail;
                    document.getElementById('modalPatientPhone').textContent = props.patientPhone;
                    document.getElementById('modalEventDateTime').textContent = `${formattedDate} at ${props.displayTime}`;
                    document.getElementById('modalEventDob').textContent = props.dob; // Display DOB in modal
                    document.getElementById('modalEventReason').textContent = props.reason;
                    document.getElementById('modalEventStatus').textContent = props.status.toUpperCase();
                    
                    eventDetailsModal.classList.remove('hidden'); 
                    console.log("Calendar: Event details modal displayed.");
                },
                eventDrop: function(info) { // <--- NEW: Event listener for dragging events
                    console.log("Calendar: Event dropped!", info.event.id);
                    // Confirm with admin before updating
                    // Using a custom modal instead of alert/confirm for better UX
                    showConfirmationModal(
                        `Are you sure you want to move "${info.event.title}" to ${info.event.start.toLocaleString()}?`,
                        () => { // On confirm
                            updateAppointmentDateTime(info.event.id, info.event.start, info.event.end);
                        },
                        () => { // On cancel
                            info.revert(); // Revert the drag if canceled
                        }
                    );
                },
                eventResize: function(info) { // <--- NEW: Event listener for resizing events
                    console.log("Calendar: Event resized!", info.event.id);
                    // Confirm with admin before updating
                    // Using a custom modal instead of alert/confirm for better UX
                    showConfirmationModal(
                        `Are you sure you want to resize "${info.event.title}" to ${info.event.start.toLocaleTimeString()} - ${info.event.end.toLocaleTimeString()} on ${info.event.start.toLocaleDateString()}?`,
                        () => { // On confirm
                            updateAppointmentDateTime(info.event.id, info.event.start, info.event.end);
                        },
                        () => { // On cancel
                            info.revert(); // Revert the resize if canceled
                        }
                    );
                }
            });

            adminCalendarInstance.render(); 
            console.log("Calendar: FullCalendar instance rendered.");

            closeModalBtn.onclick = function() {
                eventDetailsModal.classList.add('hidden');
                console.log("Calendar: Event details modal hidden via close button.");
            };

            window.onclick = function(event) {
                if (event.target == eventDetailsModal) {
                    eventDetailsModal.classList.add('hidden');
                    console.log("Calendar: Event details modal hidden via outside click.");
                }
            };
        }


        // --- Initial Load Logic and Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM Content Loaded. Setting up event listeners.");

            // Set up main screen navigation (new layout)
            document.getElementById('loginBtn').addEventListener('click', login);
            document.getElementById('showSignupBtn').addEventListener('click', showSignup);
            document.getElementById('showAdminLoginBtn').addEventListener('click', showAdminLogin);

            document.getElementById('signupBtn').addEventListener('click', signup);
            document.getElementById('backToLoginBtn').addEventListener('click', showLogin);

            document.getElementById('adminLoginBtn').addEventListener('click', adminLogin);
            document.getElementById('backToPatientLoginBtn').addEventListener('click', showLogin);

            // NEW: Public access buttons (JavaScript actions)
            document.getElementById('publicTmsQuestionnaireBtn').addEventListener('click', () => showTmsQuestionnaire(false)); // false means not logged-in call
            document.getElementById('publicMentalHealthTestsBtn').addEventListener('click', showPublicMentalHealthTestSelection);
            document.getElementById('backToPublicAccessBtn').addEventListener('click', showLoginScreenLayout); // From public mental health tests selection

            // Public mental health test selection buttons
            document.querySelectorAll('#publicMentalHealthTestsSection .test-card').forEach(card => {
                card.addEventListener('click', (event) => {
                    const testType = event.currentTarget.dataset.testType; // Use currentTarget to get the card itself
                    startPublicTest(testType);
                });
            });

            // Set up dashboard logout buttons
            document.getElementById('patientLogoutBtn').addEventListener('click', logout);
            document.getElementById('adminLogoutBtn').addEventListener('click', logout);

            // Set up patient dashboard buttons (logged-in mental health tests)
            document.getElementById('showBookingFormBtn').addEventListener('click', showBookingForm);
            document.getElementById('submitAppointmentRequestBtn').addEventListener('click', bookAppointment);
            document.getElementById('hideBookingFormBtn').addEventListener('click', hideBookingForm);
            
            // Logged-in test specific buttons
            // These will be overridden by publicTest logic if in public mode, which is correct.
            document.getElementById('submitTestBtn').addEventListener('click', submitTest);
            document.getElementById('cancelTestBtn').addEventListener('click', cancelTest);


            // Set up patient TMS Questionnaire buttons (logged-in specific)
            document.getElementById('showTmsQuestionnaireBtnLoggedIn').addEventListener('click', () => showTmsQuestionnaire(true)); // true means logged-in call
            document.getElementById('submitTmsQuestionnaireBtn').addEventListener('click', submitTmsQuestionnaire);
            document.getElementById('cancelTmsQuestionnaireBtn').addEventListener('click', cancelTmsQuestionnaire);
            setupTmsFormListeners(); // Initialize listeners for conditional follow-ups

            // Setup TMS Detail Modal close button
            document.getElementById('closeTmsModalBtn').addEventListener('click', () => {
                document.getElementById('tmsDetailModal').classList.add('hidden');
                document.getElementById('assignTmsToPatientSection').classList.add('hidden'); // Hide assignment section on close
            });

            // Setup Public Test Detail Modal close button
            document.getElementById('closePublicTestModalBtn').addEventListener('click', () => {
                document.getElementById('publicTestDetailModal').classList.add('hidden');
                document.getElementById('assignPublicTestToPatientSection').classList.add('hidden'); // Hide assignment section on close
            });


            // Set up patient sidebar navigation using event delegation
            document.getElementById('patientSidebarNav').addEventListener('click', (event) => {
                if (event.target.tagName === 'LI' && event.target.dataset.section) {
                    console.log("Patient sidebar navigation clicked:", event.target.dataset.section);
                    showPatientSection(event.target.dataset.section);
                }
            });

            // Set up test card event listeners using event delegation for mentalHealthSection (logged-in tests)
            document.getElementById('mentalHealthSection').addEventListener('click', (event) => {
                if (event.target.closest('.test-card')) {
                    const testType = event.target.closest('.test-card').dataset.testType;
                    console.log("Mental health test card clicked (logged-in):", testType);
                    startTest(testType);
                }
            });

            // Set up admin sidebar navigation using event delegation
            document.getElementById('adminSidebarNav').addEventListener('click', (event) => {
                if (event.target.tagName === 'LI' && event.target.dataset.section) {
                    console.log("Admin sidebar navigation clicked:", event.target.dataset.section);
                    showAdminSection(event.target.dataset.section);
                }
            });

            // Set up admin patient management buttons
            document.getElementById('showAddPatientFormBtn').addEventListener('click', showAddPatientForm);
            document.getElementById('addPatientBtn').addEventListener('click', addPatient);
            document.getElementById('hideAddPatientFormBtn').addEventListener('click', hideAddPatientForm);

            // Admin Patient Detail View buttons
            document.getElementById('backToPatientsListBtn').addEventListener('click', () => { console.log("Admin: Back to patient list."); loadPatientsList(); });
            
            // Check Firebase Auth state on page load
            onAuthStateChanged(auth, (user) => {
                console.log("Auth state changed. Current user:", user ? user.uid : "No user");
                if (user) {
                    currentUser = user;
                    if (currentUser.email === ADMIN_EMAIL) {
                        isAdmin = true;
                        console.log("Auth state changed: Admin user logged in. UID:", user.uid);
                        showAdminDashboard();
                    } else {
                        isAdmin = false;
                        console.log("Auth state changed: Regular patient user logged in. UID:", user.uid);
                        showPatientDashboard();
                    }
                } else {
                    if (sessionStorage.getItem('isAdminLoggedIn') === 'true') {
                        isAdmin = true;
                        console.log("Auth state changed: Admin session found (from storage, no current Firebase Auth user yet).");
                        showAdminDashboard();
                    } else {
                        console.log("Auth state changed: No user or admin session found. Showing login.");
                        showLoginScreenLayout(); // Show the new login/public access wrapper
                        showLogin(); // Show default login form within it
                    }
                }
            });
        });

    </script>
</body>
</html>
