<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealMed Patient/Admin Portal</title>
    <style>
        /* All your CSS styles are now embedded here */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow-y: auto; /* Allow scrolling for content that overflows viewport */
        }

        .container {
            width: 100%;
            max-width: 1200px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            margin: 20px;
        }

        .hidden {
            display: none !important;
        }

        /* Login Screen */
        .login-screen {
            padding: 60px;
            text-align: center;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh; /* Ensure login screen takes full height too */
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .login-form {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .login-form h2 {
            margin-bottom: 30px;
            color: #333;
            font-size: 28px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            color: #333;
        }

        .link-btn {
            background: none;
            color: #667eea;
            text-decoration: underline;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }

        /* Dashboard */
        .dashboard {
            display: flex;
            min-height: 100vh;
            position: relative; /* For logout button positioning */
        }

        .sidebar {
            width: 250px;
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px 0;
            flex-shrink: 0; /* Prevent sidebar from shrinking */
        }

        .sidebar h3 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
        }

        .sidebar ul {
            list-style: none;
        }

        .sidebar li {
            padding: 15px 30px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .sidebar li:hover, .sidebar li.active {
            background-color: rgba(255,255,255,0.1);
        }

        .main-content {
            flex: 1;
            padding: 40px;
            background: #f8f9fa;
            overflow-y: auto; /* Allow scrolling for main content */
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px; /* Add margin between sections */
        }

        .section h2 {
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 24px;
        }

        /* Appointments */
        .appointment-card {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .appointment-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .status-pending {
            background: #f39c12;
        }

        .status-approved {
            background: #27ae60;
        }

        .status-denied {
            background: #e74c3c;
        }

        /* Mental Health Tests */
        .test-card {
            background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .test-card:hover {
            transform: translateY(-3px);
        }

        .question {
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            color: #333; /* Ensure text is readable */
        }

        .question h4 {
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .radio-option:hover {
            background: #e9ecef;
        }

        .test-result-item { /* Changed from test-result to avoid conflict */
            background: linear-gradient(135deg, #00b894 0%, #00a085 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            margin-bottom: 15px; /* Add margin for list items */
        }

        /* Admin specific styles */
        .admin-card {
            background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .action-buttons {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        .btn-approve {
            background: #27ae60;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .btn-approve:hover {
            transform: translateY(-2px);
        }

        .btn-deny {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .btn-deny:hover {
            transform: translateY(-2px);
        }


        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 100; /* Ensure it's above other content */
        }

        .calendar-entry {
            background: linear-gradient(135deg, #81ecec 0%, #00cec9 100%);
            color: #333;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .calendar-entry h4 {
            color: #2c3e50;
            margin-bottom: 5px;
        }


        @media (max-width: 768px) {
            .dashboard {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                padding: 20px 0;
            }

            .sidebar ul {
                display: flex;
                overflow-x: auto;
                justify-content: space-around; /* Distribute items */
            }

            .sidebar li {
                white-space: nowrap;
                min-width: 120px; /* Adjusted minimum width for smaller screens */
                text-align: center;
            }

            .main-content {
                padding: 20px;
            }
            .login-screen {
                padding: 30px;
            }
            .login-form {
                padding: 30px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Screen -->
        <div id="loginScreen" class="login-screen">
            <div class="login-form">
                <h2>Patient Portal Login</h2>
                <div class="form-group">
                    <label for="loginEmail">Email:</label>
                    <input type="email" id="loginEmail" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password:</label>
                    <input type="password" id="loginPassword" placeholder="Enter your password" required>
                </div>
                <button class="btn" id="loginBtn">Login</button>
                <button class="btn btn-secondary" id="showSignupBtn">Create Account</button>
                <button class="link-btn" id="showAdminLoginBtn">Staff Login</button>
            </div>
        </div>

        <!-- Signup Screen -->
        <div id="signupScreen" class="login-screen hidden">
            <div class="login-form">
                <h2>Create Account</h2>
                <div class="form-group">
                    <label for="signupName">Full Name:</label>
                    <input type="text" id="signupName" placeholder="Enter your full name" required>
                </div>
                <div class="form-group">
                    <label for="signupEmail">Email:</label>
                    <input type="email" id="signupEmail" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="signupPassword">Password:</label>
                    <input type="password" id="signupPassword" placeholder="Create a password" required>
                </div>
                <div class="form-group">
                    <label for="signupPhone">Phone Number:</label>
                    <input type="tel" id="signupPhone" placeholder="Enter your phone number" required>
                </div>
                <div class="form-group">
                    <label for="signupGender">Gender:</label>
                    <select id="signupGender" required>
                        <option value="">Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                        <option value="prefer-not-to-say">Prefer not to say</option>
                    </select>
                </div>
                <button class="btn" id="signupBtn">Create Account</button>
                <button class="link-btn" id="backToLoginBtn">Back to Login</button>
            </div>
        </div>

        <!-- Admin Login Screen -->
        <div id="adminLoginScreen" class="login-screen hidden">
            <div class="login-form">
                <h2>Staff Login</h2>
                <div class="form-group">
                    <!-- Changed from username to email as we'll use Firebase Auth -->
                    <label for="adminEmail">Email:</label>
                    <input type="email" id="adminEmail" placeholder="Enter admin email" required>
                </div>
                <div class="form-group">
                    <label for="adminPassword">Password:</label>
                    <input type="password" id="adminPassword" placeholder="Enter password" required>
                </div>
                <button class="btn" id="adminLoginBtn">Login</button>
                <button class="link-btn" id="backToPatientLoginBtn">Back to Patient Login</button>
            </div>
        </div>

        <!-- Patient Dashboard -->
        <div id="patientDashboard" class="dashboard hidden">
            <button class="logout-btn" id="patientLogoutBtn">Logout</button>
            <div class="sidebar">
                <h3>Patient Portal</h3>
                <ul id="patientSidebarNav">
                    <li class="active" data-section="appointments">Manage Appointments</li>
                    <li data-section="mentalHealth">Mental Health Tests</li>
                    <li data-section="healthRecords">Health Records</li>
                    <li data-section="profile">Profile</li>
                </ul>
            </div>
            <div class="main-content">
                <!-- Appointments Section -->
                <div id="appointmentsSection" class="section">
                    <h2>Manage Appointments</h2>
                    <div id="appointmentsList"></div>
                    <button class="btn" id="showBookingFormBtn">Book New Appointment</button>

                    <!-- Booking Form -->
                    <div id="bookingForm" class="hidden" style="margin-top: 20px; background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <h3>Book New Appointment</h3>
                        <div class="form-group">
                            <label for="appointmentTime">Preferred Appointment Time:</label>
                            <select id="appointmentTime" required>
                                <option value="">Select Time</option>
                                <option value="Thursday 1-2 PM">Thursday 1-2 PM</option>
                                <option value="Friday 1-2 PM">Friday 1-2 PM</option>
                                <option value="Monday 10-11 AM">Monday 10-11 AM</option>
                                <option value="Tuesday 2-3 PM">Tuesday 2-3 PM</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="appointmentReason">Reason for Visit:</label>
                            <textarea id="appointmentReason" placeholder="Please describe the reason for your visit" required></textarea>
                        </div>
                        <button class="btn" id="submitAppointmentRequestBtn">Submit Request</button>
                        <button class="btn btn-secondary" id="hideBookingFormBtn">Cancel</button>
                    </div>
                </div>

                <!-- Mental Health Tests Section -->
                <div id="mentalHealthSection" class="section hidden">
                    <h2>Mental Health Tests</h2>
                    <div class="test-card" data-test-type="depression">
                        <h3>Depression Screening (PHQ-9)</h3>
                        <p>Take a self-assessment to screen for depression symptoms</p>
                    </div>
                    <div class="test-card" data-test-type="anxiety">
                        <h3>Anxiety Screening (GAD-7)</h3>
                        <p>Take a self-assessment to screen for anxiety symptoms</p>
                    </div>
                    <div class="test-card" data-test-type="adhd">
                        <h3>ADHD Screening</h3>
                        <p>Take a self-assessment to screen for ADHD symptoms</p>
                    </div>
                    <h4>Your Past Test Results:</h4>
                    <div id="testResultsList"></div>
                </div>

                <!-- Test Taking Interface -->
                <div id="testInterface" class="section hidden">
                    <h2 id="testTitle"></h2>
                    <div id="testQuestions"></div>
                    <button class="btn" id="submitTestBtn">Submit Test</button>
                    <button class="btn btn-secondary" id="cancelTestBtn">Cancel</button>
                </div>

                <!-- Health Records Section -->
                <div id="healthRecordsSection" class="section hidden">
                    <h2>Health Records</h2>
                    <p>Your health records and medical history will be displayed here.</p>
                    <div id="healthRecordsList"></div>
                </div>

                <!-- Profile Section -->
                <div id="profileSection" class="section hidden">
                    <h2>Profile</h2>
                    <div id="profileInfo"></div>
                </div>
            </div>
        </div>

        <!-- Admin Dashboard -->
        <div id="adminDashboard" class="dashboard hidden">
            <button class="logout-btn" id="adminLogoutBtn">Logout</button>
            <div class="sidebar">
                <h3>Admin Portal</h3>
                <ul id="adminSidebarNav">
                    <li class="active" data-section="appointments">Appointment Requests</li>
                    <li data-section="patients">Patient Management</li>
                    <li data-section="testResults">Test Results</li>
                    <li data-section="calendar">Calendar</li> <!-- New Calendar Section -->
                </ul>
            </div>
            <div class="main-content">
                <!-- Admin Appointments Section -->
                <div id="adminAppointmentsSection" class="section">
                    <h2>Appointment Requests</h2>
                    <div id="adminAppointmentsList"></div>
                </div>

                <!-- Admin Patients Section -->
                <div id="adminPatientsSection" class="section hidden">
                    <h2>Patient Management</h2>
                    <button class="btn" id="showAddPatientFormBtn">Add New Patient (via Admin)</button>
                    <div id="patientsList"></div>

                    <!-- Add Patient Form -->
                    <div id="addPatientForm" class="hidden" style="margin-top: 20px; background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <h3>Add New Patient</h3>
                        <div class="form-group">
                            <label for="newPatientName">Full Name:</label>
                            <input type="text" id="newPatientName" required>
                        </div>
                        <div class="form-group">
                            <label for="newPatientEmail">Email:</label>
                            <input type="email" id="newPatientEmail" required>
                        </div>
                        <div class="form-group">
                            <label for="newPatientPassword">Password:</label>
                            <input type="password" id="newPatientPassword" required>
                        </div>
                        <div class="form-group">
                            <label for="newPatientPhone">Phone:</label>
                            <input type="tel" id="newPatientPhone" required>
                        </div>
                        <div class="form-group">
                            <label for="newPatientGender">Gender:</label>
                            <select id="newPatientGender" required>
                                <option value="">Select Gender</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other</option>
                                <option value="prefer-not-to-say">Prefer not to say</option>
                            </select>
                        </div>
                        <button class="btn" id="addPatientBtn">Add Patient</button>
                        <button class="btn btn-secondary" id="hideAddPatientFormBtn">Cancel</button>
                    </div>
                </div>

                <!-- Admin Test Results Section -->
                <div id="adminTestResultsSection" class="section hidden">
                    <h2>Patient Test Results</h2>
                    <div id="adminTestResultsList"></div>
                </div>

                <!-- New Admin Calendar Section -->
                <div id="adminCalendarSection" class="section hidden">
                    <h2>Approved Appointments Calendar</h2>
                    <div id="calendarEntries">
                        <p>Approved appointments will appear here.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Firebase Configuration (YOUR ACTUAL KEYS) ---
        // This configuration has been updated with the details you provided.
        // The 'databaseURL' has been explicitly added, as it's crucial for Realtime Database operations.
        const firebaseConfig = {
            apiKey: "AIzaSyD440QOEKOT3oRUORipguPtttraawzPGgs",
            authDomain: "healmed-portal-backend.firebaseapp.com",
            projectId: "healmed-portal-backend",
            storageBucket: "healmed-portal-backend.firebasestorage.app",
            messagingSenderId: "979152928801",
            appId: "1:979152928801:web:2e5dbbd801732a4e44e360",
            measurementId: "G-1MKT9TNCJ5",
            // IMPORTANT: databaseURL is derived from your projectId
            databaseURL: "https://healmed-portal-backend-default-rtdb.firebaseio.com"
        };

        // --- Firebase SDK v9 Modular Imports from CDN ---
        // These URLs are stable and directly link to Firebase's CDN for modular SDK.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, update, remove, get } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-analytics.js";

        // --- Initialize Firebase Services ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        const analytics = getAnalytics(app);

        // --- Global State Variables ---
        let currentUser = null; // Stores current Firebase authenticated user object
        let isAdmin = false; // Flag for admin status (set after successful Firebase admin login)
        let currentTest = null; // Stores details of the test currently being taken

        // --- Admin Credentials (No longer hardcoded as username, but for reference) ---
        // The actual admin credentials will be a user created in Firebase Authentication
        const ADMIN_EMAIL = 'admin@healmed.com'; // Use the email you create in Firebase Auth
        const ADMIN_PASSWORD_REFERENCE = 'healthcare2024'; // For clarity, we still refer to it.

        // --- Mental Health Test Questions and Scoring ---
        const testQuestions = {
            depression: {
                title: 'Depression Screening (PHQ-9)',
                questions: [
                    'Little interest or pleasure in doing things',
                    'Feeling down, depressed, or hopeless',
                    'Trouble falling or staying asleep, or sleeping too much',
                    'Feeling tired or having little energy',
                    'Poor appetite or overeating',
                    'Feeling bad about yourself — or that you are a failure or have let yourself or your family down',
                    'Trouble concentrating on things, such as reading the newspaper or watching television',
                    'Moving or speaking so slowly that other people could have noticed. Or the opposite — being so fidgety or restless that you have been moving around a lot more than usual',
                    'Thoughts that you would be better off dead, or of hurting yourself in any way'
                ],
                options: [
                    { text: 'Not at all', value: 0 },
                    { text: 'Several days', value: 1 },
                    { text: 'More than half the days', value: 2 },
                    { text: 'Nearly every day', value: 3 }
                ],
                scoring: {
                    ranges: [
                        { min: 0, max: 4, level: 'Minimal', description: 'Minimal depression symptoms' },
                        { min: 5, max: 9, level: 'Mild', description: 'Mild depression symptoms' },
                        { min: 10, max: 14, level: 'Moderate', description: 'Moderate depression symptoms' },
                        { min: 15, max: 19, level: 'Moderately Severe', description: 'Moderately severe depression symptoms' },
                        { min: 20, max: 27, level: 'Severe', description: 'Severe depression symptoms' }
                    ]
                },
                 getBreakdown: (score) => {
                    for (const range of testQuestions.depression.scoring.ranges) {
                        if (score >= range.min && score <= range.max) {
                            return range.description;
                        }
                    }
                    return 'N/A';
                }
            },
            anxiety: {
                title: 'Anxiety Screening (GAD-7)',
                questions: [
                    'Feeling nervous, anxious, or on edge',
                    'Not being able to stop or control worrying',
                    'Worrying too much about different things',
                    'Trouble relaxing',
                    'Being so restless that it is hard to sit still',
                    'Becoming easily annoyed or irritable',
                    'Feeling afraid, as if something awful might happen'
                ],
                options: [
                    { text: 'Not at all', value: 0 },
                    { text: 'Several days', value: 1 },
                    { text: 'More than half the days', value: 2 },
                    { text: 'Nearly every day', value: 3 }
                ],
                scoring: {
                    ranges: [
                        { min: 0, max: 4, level: 'Minimal', description: 'Minimal anxiety symptoms' },
                        { min: 5, max: 9, level: 'Mild', description: 'Mild anxiety symptoms' },
                        { min: 10, max: 14, level: 'Moderate', description: 'Moderate anxiety symptoms' },
                        { min: 15, max: 21, level: 'Severe', description: 'Severe anxiety symptoms' }
                    ]
                },
                getBreakdown: (score) => {
                    for (const range of testQuestions.anxiety.scoring.ranges) {
                        if (score >= range.min && score <= range.max) {
                            return range.description;
                        }
                    }
                    return 'N/A';
                }
            },
            adhd: {
                title: 'ADHD Screening',
                questions: [
                    'How often do you have trouble wrapping up the final details of a project, once the challenging parts have been done?',
                    'How often do you have difficulty getting things in order when you have to do a task that requires organization?',
                    'How often do you have problems remembering appointments or obligations?',
                    'When you have a task that requires a lot of thought, how often do you avoid or delay getting started?',
                    'How often do you fidget or squirm with your hands or feet when you have to sit down for a long time?',
                    'How often do you feel overly active and compelled to do things, like you were driven by a motor?'
                ],
                options: [
                    { text: 'Never', value: 0 },
                    { text: 'Rarely', value: 1 },
                    { text: 'Sometimes', value: 2 },
                    { text: 'Often', value: 3 },
                    { text: 'Very Often', value: 4 }
                ],
                scoring: {
                    ranges: [
                        { min: 0, max: 8, level: 'Low', description: 'Low likelihood of ADHD symptoms' },
                        { min: 9, max: 13, level: 'Moderate', description: 'Moderate likelihood of ADHD symptoms' },
                        { min: 14, max: 24, level: 'High', description: 'High likelihood of ADHD symptoms' }
                    ]
                },
                getBreakdown: (score) => {
                    for (const range of testQuestions.adhd.scoring.ranges) {
                        if (score >= range.min && score <= range.max) {
                            return range.description;
                        }
                    }
                    return 'N/A';
                }
            }
        };

        // --- Helper Functions for UI and Messages ---
        function showMessage(message, isError = false) {
            alert(message); // Using alert as per previous pattern. Consider a custom modal for better UX.
            if (isError) {
                console.error(message);
            } else {
                console.log(message);
            }
        }

        function hideAllScreens() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('signupScreen').classList.add('hidden');
            document.getElementById('adminLoginScreen').classList.add('hidden');
            document.getElementById('patientDashboard').classList.add('hidden');
            document.getElementById('adminDashboard').classList.add('hidden');
        }

        // --- Authentication Functions (Firebase Integrated) ---

        // Patient Login
        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showMessage('Please enter both email and password', true);
                return;
            }

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                currentUser = userCredential.user;
                isAdmin = false; // Ensure admin flag is false for patient login
                console.log("Patient login successful for UID:", currentUser.uid);
                showMessage('Patient login successful!');
                showPatientDashboard();
            } catch (error) {
                console.error("Login failed:", error);
                showMessage(`Login failed: ${error.message}`, true);
            }
        }

        // Admin Login (NOW using Firebase Auth)
        async function adminLogin() {
            // Updated: Using adminEmail instead of adminUsername
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;

            if (!email || !password) {
                showMessage('Please enter both email and password for admin login', true);
                return;
            }

            try {
                // IMPORTANT: We now try to sign in the admin with Firebase Authentication
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                currentUser = userCredential.user; // Set current user to admin's Firebase user object
                
                // Optional: You could check user.uid against a list of known admin UIDs
                // For simplicity, we assume anyone logging in with the specific admin credentials is an admin.
                if (email === ADMIN_EMAIL && password === ADMIN_PASSWORD_REFERENCE) { // Perform local check too
                    sessionStorage.setItem('isAdminLoggedIn', 'true');
                    isAdmin = true;
                    console.log("Admin login successful via Firebase Auth. UID:", currentUser.uid);
                    showMessage('Admin login successful!');
                    showAdminDashboard();
                } else {
                    // This case should ideally not be hit if credentials are correct and user exists in Auth
                    console.error("Admin: Firebase Auth login succeeded but local check failed. This is unexpected.");
                    showMessage('Admin login failed: Internal error or credentials mismatch.', true);
                    await signOut(auth); // Sign out if local check fails for safety
                }

            } catch (error) {
                console.error("Admin login failed:", error);
                showMessage(`Admin login failed: ${error.message}`, true);
                // Clear any stored admin session if login fails
                sessionStorage.removeItem('isAdminLoggedIn');
                isAdmin = false;
            }
        }

        // Patient Signup
        async function signup() {
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const phone = document.getElementById('signupPhone').value;
            const gender = document.getElementById('signupGender').value;

            if (!name || !email || !password || !phone || !gender) {
                showMessage('Please fill in all fields', true);
                return;
            }

            // Client-side password length check for Firebase Auth
            if (password.length < 6) {
                showMessage('Password must be at least 6 characters long.', true);
                return;
            }

            try {
                console.log("Attempting to create user with email:", email);
                // Create user with Firebase Authentication
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const userId = userCredential.user.uid;
                console.log("User created in Firebase Auth with UID:", userId);

                // Save additional patient data to Realtime Database
                await set(ref(database, 'patients/' + userId), {
                    fullName: name,
                    email: email,
                    phoneNumber: phone,
                    gender: gender,
                    createdAt: new Date().toISOString()
                });
                console.log("Patient data saved to Realtime Database for UID:", userId);

                showMessage('Account created successfully! Please login.');
                showLogin(); // Redirect to login screen after successful signup
            } catch (error) {
                console.error("Firebase Auth Error during signup:", error);
                showMessage(`Error creating account: ${error.message}`, true);
            }
        }

        // Logout
        async function logout() {
            // Always try to sign out from Firebase Auth
            try {
                await signOut(auth);
                console.log("Firebase Auth user signed out.");
            } catch (error) {
                console.error("Firebase Auth signOut failed:", error);
                // Continue with local cleanup even if Firebase signOut fails
            }

            // Clear local state and session storage
            sessionStorage.removeItem('isAdminLoggedIn');
            isAdmin = false;
            currentUser = null;
            console.log("Local state cleared. User logged out.");
            showMessage('Logged out successfully.');
            showLogin();
        }

        // --- UI Navigation Functions ---
        function showLogin() {
            hideAllScreens();
            document.getElementById('loginScreen').classList.remove('hidden');
        }

        function showSignup() {
            hideAllScreens();
            document.getElementById('signupScreen').classList.remove('hidden');
        }

        function showAdminLogin() {
            hideAllScreens();
            document.getElementById('adminLoginScreen').classList.remove('hidden');
            // Clear fields on showing admin login
            document.getElementById('adminEmail').value = '';
            document.getElementById('adminPassword').value = '';
        }

        function showPatientDashboard() {
            hideAllScreens();
            document.getElementById('patientDashboard').classList.remove('hidden');
            // Default to appointments section
            showPatientSection('appointments');
            // Load patient-specific data when dashboard is shown
            loadAppointments();
            loadTestResults(); // Load patient's test results
            loadProfile();
        }

        function showAdminDashboard() {
            hideAllScreens();
            document.getElementById('adminDashboard').classList.remove('hidden');
            // Default to appointment requests
            showAdminSection('appointments');
            // Load admin-specific data when dashboard is shown
            loadAdminAppointments();
            loadPatientsList(); // Load all patients for management
            loadAdminTestResults(); // Load all test results for review
            loadAdminCalendar(); // Load approved appointments for calendar
        }

        // Generic function to show a specific section within patient dashboard
        function showPatientSection(sectionId) {
            document.querySelectorAll('#patientDashboard .section').forEach(s => s.classList.add('hidden'));
            document.getElementById('testInterface').classList.add('hidden'); // Ensure test interface is hidden

            document.querySelectorAll('#patientSidebarNav li').forEach(li => li.classList.remove('active'));
            // Use dataset for better event handling consistency
            const targetListItem = document.querySelector(`#patientSidebarNav li[data-section="${sectionId}"]`);
            if (targetListItem) {
                targetListItem.classList.add('active');
            }

            document.getElementById(`${sectionId}Section`).classList.remove('hidden');
        }

        // Generic function to show a specific section within admin dashboard
        function showAdminSection(sectionId) {
            document.querySelectorAll('#adminDashboard .section').forEach(s => s.classList.add('hidden'));

            document.querySelectorAll('#adminSidebarNav li').forEach(li => li.classList.remove('active'));
            // Use dataset for better event handling consistency
            const targetListItem = document.querySelector(`#adminSidebarNav li[data-section="${sectionId}"]`);
            if (targetListItem) {
                targetListItem.classList.add('active');
            }

            document.getElementById(`admin${sectionId.charAt(0).toUpperCase() + sectionId.slice(1)}Section`).classList.remove('hidden');
        }

        // --- Patient-Specific Functionality ---

        // Load Patient Profile
        function loadProfile() {
            if (!currentUser) return;
            const profileInfoDiv = document.getElementById('profileInfo');
            console.log("Patient: Loading profile for UID:", currentUser.uid);
            onValue(ref(database, 'patients/' + currentUser.uid), (snapshot) => {
                const patientData = snapshot.val();
                if (patientData) {
                    profileInfoDiv.innerHTML = `
                        <p><strong>Name:</strong> ${patientData.fullName}</p>
                        <p><strong>Email:</strong> ${patientData.email}</p>
                        <p><strong>Phone:</strong> ${patientData.phoneNumber}</p>
                        <p><strong>Gender:</strong> ${patientData.gender}</p>
                        <p><strong>Account Created:</strong> ${new Date(patientData.createdAt).toLocaleString()}</p>
                    `;
                    console.log("Patient: Profile data loaded:", patientData.fullName);
                } else {
                    profileInfoDiv.innerHTML = '<p>No profile data found.</p>';
                    console.log("Patient: No profile data found for UID:", currentUser.uid);
                }
            }, {
                onlyOnce: false // Listen for real-time changes
            });
        }

        // Show/Hide Appointment Booking Form
        function showBookingForm() {
            document.getElementById('bookingForm').classList.remove('hidden');
            console.log("Patient: Showing booking form.");
        }

        function hideBookingForm() {
            document.getElementById('bookingForm').classList.add('hidden');
            // Clear form fields
            document.getElementById('appointmentTime').value = '';
            document.getElementById('appointmentReason').value = '';
            console.log("Patient: Hiding booking form.");
        }

        // Book New Appointment
        async function bookAppointment() {
            const time = document.getElementById('appointmentTime').value;
            const reason = document.getElementById('appointmentReason').value;

            if (!time || !reason) {
                showMessage('Please select a time and enter a reason for your visit', true);
                return;
            }
            if (!currentUser) {
                showMessage('You must be logged in to book an appointment.', true);
                return;
            }

            try {
                console.log("Patient: Attempting to book appointment for user UID:", currentUser.uid);
                // Fetch current patient details for the appointment record
                const patientSnapshot = await get(ref(database, 'patients/' + currentUser.uid));
                const patientData = patientSnapshot.val();

                if (!patientData) {
                    showMessage('Could not retrieve patient data. Please try logging in again.', true);
                    console.error("Patient: Data not found for UID:", currentUser.uid);
                    return;
                }

                const newAppointmentRef = push(ref(database, 'appointments')); // Firebase generates unique ID
                await set(newAppointmentRef, {
                    userId: currentUser.uid,
                    fullName: patientData.fullName,
                    email: patientData.email,
                    phoneNumber: patientData.phoneNumber,
                    time: time,
                    reason: reason,
                    status: 'pending', // Initial status
                    createdAt: new Date().toISOString()
                });
                console.log("Patient: Appointment request submitted successfully to Firebase. Path:", newAppointmentRef.toString());
                showMessage('Appointment request submitted successfully!');
                hideBookingForm();
                // loadAppointments() will automatically update due to onValue listener
            } catch (error) {
                console.error("Patient: Error booking appointment:", error);
                showMessage(`Error booking appointment: ${error.message}`, true);
            }
        }

        // Load Patient's Appointments
        function loadAppointments() {
            const appointmentsListDiv = document.getElementById('appointmentsList');
            if (!currentUser) {
                appointmentsListDiv.innerHTML = '<p>Please log in to view your appointments.</p>';
                return;
            }
            console.log("Patient: Loading appointments for patient UID:", currentUser.uid);
            onValue(ref(database, 'appointments'), (snapshot) => {
                appointmentsListDiv.innerHTML = ''; // Clear previous content
                let hasAppointments = false;
                snapshot.forEach((childSnapshot) => {
                    const appt = childSnapshot.val();
                    const apptId = childSnapshot.key; // Get the unique key for possible future modifications

                    if (appt.userId === currentUser.uid) { // Filter appointments for current user
                        hasAppointments = true;
                        const statusClass = `status-${appt.status}`;
                        appointmentsListDiv.innerHTML += `
                            <div class="appointment-card">
                                <h4>Appointment Request</h4>
                                <p><strong>Time:</strong> ${appt.time}</p>
                                <p><strong>Reason:</strong> ${appt.reason}</p>
                                <p><strong>Status:</strong> <span class="appointment-status ${statusClass}">${appt.status.toUpperCase()}</span></p>
                                <p style="font-size: 0.8em; opacity: 0.8;">Requested on: ${new Date(appt.createdAt).toLocaleString()}</p>
                                <p style="font-size: 0.8em; opacity: 0.8;">Appointment ID: ${apptId}</p>
                            </div>
                        `;
                    }
                });
                if (!hasAppointments) {
                    appointmentsListDiv.innerHTML = '<p>No appointments found.</p>';
                }
                console.log("Patient: Appointments loaded. Total displayed:", appointmentsListDiv.children.length);
            }, {
                onlyOnce: false // Listen for real-time changes
            });
        }

        // Start a Mental Health Test
        function startTest(testType) {
            if (!currentUser) {
                showMessage('You must be logged in to take a test.', true);
                return;
            }
            console.log("Patient: Starting test:", testType);
            currentTest = testQuestions[testType];
            if (!currentTest) {
                console.error("Patient: Test type not found in testQuestions object:", testType);
                showMessage("Selected test not found. Please try again.", true);
                return;
            }
            // Clear previous answers for a new test
            const testQuestionsDiv = document.getElementById('testQuestions');
            testQuestionsDiv.innerHTML = '';

            document.getElementById('testTitle').textContent = currentTest.title;


            currentTest.questions.forEach((questionText, index) => {
                const questionHtml = `
                    <div class="question">
                        <h4>${index + 1}. ${currentTest.title.includes('PHQ-9') || currentTest.title.includes('GAD-7') ? 'Over the last 2 weeks, how often have you been bothered by: ' : ''}${questionText}?</h4>
                        <div class="radio-group">
                            ${currentTest.options.map((option, optIndex) => `
                                <label class="radio-option">
                                    <input type="radio" name="q${index}" value="${option.value}" id="q${index}_${optIndex}" required>
                                    ${option.text}
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;
                testQuestionsDiv.innerHTML += questionHtml;
            });

            // Show test interface, hide mental health section
            document.getElementById('mentalHealthSection').classList.add('hidden');
            document.getElementById('testInterface').classList.remove('hidden');
            console.log("Patient: Test interface displayed for:", testType);
        }

        // Submit Mental Health Test
        async function submitTest() {
            let score = 0;
            const totalQuestions = currentTest.questions.length;
            const answers = [];

            for (let i = 0; i < totalQuestions; i++) {
                const selectedOption = document.querySelector(`input[name="q${i}"]:checked`);
                if (!selectedOption) {
                    showMessage(`Please answer question ${i + 1} before submitting.`, true);
                    return;
                }
                const value = parseInt(selectedOption.value);
                score += value;
                answers.push({ question: currentTest.questions[i], answer: currentTest.options.find(opt => opt.value === value).text, score: value });
            }

            const breakdown = currentTest.getBreakdown(score);
            console.log("Patient: Test submitted. Calculated Score:", score, "Breakdown:", breakdown);

            try {
                const newTestResultRef = push(ref(database, 'testResults')); // Firebase generates unique ID
                await set(newTestResultRef, {
                    userId: currentUser.uid,
                    testType: currentTest.title,
                    score: score,
                    breakdown: breakdown,
                    answers: answers, // Store for admin review
                    createdAt: new Date().toISOString()
                });
                console.log("Patient: Test results saved to Firebase. Path:", newTestResultRef.toString());
                showMessage('Test submitted successfully!');
                cancelTest(); // Clear test interface
                loadTestResults(); // Refresh patient's test results
            } catch (error) {
                console.error("Patient: Error submitting test:", error);
                showMessage(`Error submitting test: ${error.message}`, true);
            }
        }

        // Cancel Test
        function cancelTest() {
            console.log("Patient: Test cancelled.");
            currentTest = null;
            document.getElementById('testInterface').classList.add('hidden');
            document.getElementById('mentalHealthSection').classList.remove('hidden');
            // Clear questions
            document.getElementById('testQuestions').innerHTML = '';
        }

        // Load Patient's Past Test Results
        function loadTestResults() {
            const testResultsListDiv = document.getElementById('testResultsList');
            if (!currentUser) {
                testResultsListDiv.innerHTML = '<p>Please log in to view your test results.</p>';
                return;
            }
            console.log("Patient: Loading past test results for patient UID:", currentUser.uid);
            onValue(ref(database, 'testResults'), (snapshot) => {
                testResultsListDiv.innerHTML = ''; // Clear previous content
                let hasResults = false;
                snapshot.forEach((childSnapshot) => {
                    const result = childSnapshot.val();
                    if (result.userId === currentUser.uid) { // Filter results for current user
                        hasResults = true;
                        testResultsListDiv.innerHTML += `
                            <div class="test-result-item">
                                <h4>${result.testType}</h4>
                                <p><strong>Score:</strong> ${result.score}</p>
                                <p><strong>Breakdown:</strong> ${result.breakdown}</p>
                                <p style="font-size: 0.8em; opacity: 0.8;">Taken on: ${new Date(result.createdAt).toLocaleString()}</p>
                            </div>
                        `;
                    }
                });
                if (!hasResults) {
                    testResultsListDiv.innerHTML = '<p>No test results found. Take a test to see your results here.</p>';
                }
                console.log("Patient: Test results loaded. Total displayed:", testResultsListDiv.children.length);
            }, {
                onlyOnce: false // Listen for real-time changes
            });
        }

        // --- Admin-Specific Functionality ---

        // Load All Appointment Requests for Admin
        function loadAdminAppointments() {
            const adminAppointmentsListDiv = document.getElementById('adminAppointmentsList');
            // IMPORTANT: Now checks if currentUser is set and isAdmin flag is true based on Firebase Auth
            if (!currentUser || !isAdmin) {
                adminAppointmentsListDiv.innerHTML = '<p>Unauthorized access. Please log in as Admin.</p>';
                return;
            }
            console.log("Admin: Loading all appointment requests.");
            onValue(ref(database, 'appointments'), (snapshot) => {
                adminAppointmentsListDiv.innerHTML = ''; // Clear previous content
                let hasAppointments = false;
                const rawSnapshotData = snapshot.val();
                console.log("Admin: Raw appointments snapshot data (from Firebase):", JSON.stringify(rawSnapshotData, null, 2)); // CRITICAL: Log raw data from Firebase, stringified for readability

                if (rawSnapshotData) { // Only iterate if there's data
                    // Convert object to array for sorting by creation date (newest first)
                    const appointmentsArray = Object.keys(rawSnapshotData).map(key => ({ id: key, ...rawSnapshotData[key] }));
                    appointmentsArray.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                    appointmentsArray.forEach((appt) => {
                        console.log("Admin: Processing individual appointment:", appt.id, appt); // Log each appointment

                        hasAppointments = true;
                        const statusClass = `status-${appt.status}`;
                        adminAppointmentsListDiv.innerHTML += `
                            <div class="appointment-card admin-card">
                                <h4>Appointment Request from ${appt.fullName}</h4>
                                <p><strong>Email:</strong> ${appt.email}</p>
                                <p><strong>Phone:</strong> ${appt.phoneNumber}</p>
                                <p><strong>Requested Time:</strong> ${appt.time}</p>
                                <p><strong>Reason:</strong> ${appt.reason}</p>
                                <p><strong>Status:</strong> <span class="appointment-status ${statusClass}">${appt.status.toUpperCase()}</span></p>
                                <p style="font-size: 0.8em; opacity: 0.8;">Requested on: ${new Date(appt.createdAt).toLocaleString()}</p>
                                <p style="font-size: 0.8em; opacity: 0.8;">Appointment ID: ${appt.id}</p>
                                <div class="action-buttons">
                                    <button class="btn-approve" data-id="${appt.id}" ${appt.status === 'approved' || appt.status === 'denied' ? 'disabled' : ''}>Approve</button>
                                    <button class="btn-deny" data-id="${appt.id}" ${appt.status === 'approved' || appt.status === 'denied' ? 'disabled' : ''}>Deny</button>
                                </div>
                            </div>
                        `;
                    });
                }
                if (!hasAppointments) {
                    adminAppointmentsListDiv.innerHTML = '<p>No appointment requests found.</p>';
                }
                console.log("Admin: Appointments loaded. Total displayed elements:", adminAppointmentsListDiv.children.length);
                // Attach event listeners to new buttons (must be done after elements are added to DOM)
                document.querySelectorAll('#adminAppointmentsSection .btn-approve').forEach(button => {
                    button.onclick = (e) => approveAppointment(e.target.dataset.id);
                });
                document.querySelectorAll('#adminAppointmentsSection .btn-deny').forEach(button => {
                    button.onclick = (e) => denyAppointment(e.target.dataset.id);
                });
            }, {
                onlyOnce: false
            });
        }

        // Approve Appointment
        async function approveAppointment(apptId) {
            // IMPORTANT: Now checks if currentUser is set and isAdmin flag is true
            if (!currentUser || !isAdmin) {
                showMessage('Unauthorized action.', true);
                return;
            }
            console.log("Admin: Attempting to approve appointment ID:", apptId);
            try {
                await update(ref(database, 'appointments/' + apptId), { status: 'approved' });
                console.log("Admin: Appointment approved:", apptId);
                showMessage('Appointment approved successfully!');
                loadAdminCalendar(); // Refresh calendar after approval
            } catch (error) {
                console.error("Admin: Error approving appointment:", error);
                showMessage(`Error approving appointment: ${error.message}`, true);
            }
        }

        // Deny Appointment
        async function denyAppointment(apptId) {
            // IMPORTANT: Now checks if currentUser is set and isAdmin flag is true
            if (!currentUser || !isAdmin) {
                showMessage('Unauthorized action.', true);
                return;
            }
            console.log("Admin: Attempting to deny appointment ID:", apptId);
            try {
                await update(ref(database, 'appointments/' + apptId), { status: 'denied' });
                console.log("Admin: Appointment denied:", apptId);
                showMessage('Appointment denied.');
                loadAdminCalendar(); // Refresh calendar as status might change
            } catch (error) {
                console.error("Admin: Error denying appointment:", error);
                showMessage(`Error denying appointment: ${error.message}`, true);
            }
        }

        // Show Add Patient Form
        function showAddPatientForm() {
            if (!currentUser || !isAdmin) { // Check admin status
                showMessage('Unauthorized access.', true);
                return;
            }
            document.getElementById('addPatientForm').classList.remove('hidden');
            console.log("Admin: Showing add patient form.");
        }

        function hideAddPatientForm() {
            document.getElementById('addPatientForm').classList.add('hidden');
            // Clear form fields
            document.getElementById('newPatientName').value = '';
            document.getElementById('newPatientEmail').value = '';
            document.getElementById('newPatientPassword').value = '';
            document.getElementById('newPatientPhone').value = '';
            document.getElementById('newPatientGender').value = '';
            console.log("Admin: Hiding add patient form.");
        }

        // Add New Patient via Admin Portal (This will create a Firebase Auth user)
        async function addPatient() {
            // IMPORTANT: Now checks if currentUser is set and isAdmin flag is true
            if (!currentUser || !isAdmin) {
                showMessage('Unauthorized action.', true);
                return;
            }
            const name = document.getElementById('newPatientName').value;
            const email = document.getElementById('newPatientEmail').value;
            const password = document.getElementById('newPatientPassword').value; // Password for the new patient
            const phone = document.getElementById('newPatientPhone').value;
            const gender = document.getElementById('newPatientGender').value;

            if (!name || !email || !password || !phone || !gender) {
                showMessage('Please fill in all fields for the new patient', true);
                return;
            }

            // Check for password length as per Firebase Auth requirement
            if (password.length < 6) {
                showMessage('Password for the new patient must be at least 6 characters long.', true);
                return;
            }

            try {
                console.log("Admin: Attempting to add new patient with email:", email);
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const userId = userCredential.user.uid;
                console.log("Admin: Created new user in Auth with UID:", userId);

                await set(ref(database, 'patients/' + userId), {
                    fullName: name,
                    email: email,
                    phoneNumber: phone,
                    gender: gender,
                    createdAt: new Date().toISOString()
                });
                console.log("Admin: Saved patient data to Realtime Database for UID:", userId);
                showMessage(`Patient ${name} added successfully! Temporary password: ${password}`);
                hideAddPatientForm();
                // loadPatientsList() will automatically update
            } catch (error) {
                console.error("Admin: Error adding patient via admin portal:", error);
                showMessage(`Error adding patient: ${error.message}`, true);
            }
        }

        // Load All Patients for Admin
        function loadPatientsList() {
            // IMPORTANT: Now checks if currentUser is set and isAdmin flag is true
            if (!currentUser || !isAdmin) {
                patientsListDiv.innerHTML = '<p>Unauthorized access. Please log in as Admin.</p>';
                return;
            }
            const patientsListDiv = document.getElementById('patientsList');
            console.log("Admin: Loading all patients.");
            onValue(ref(database, 'patients'), (snapshot) => {
                patientsListDiv.innerHTML = ''; // Clear previous content
                let hasPatients = false;
                const rawSnapshotData = snapshot.val();
                console.log("Admin: Raw patients snapshot data (from Firebase):", JSON.stringify(rawSnapshotData, null, 2)); // CRITICAL: Log raw data from Firebase, stringified

                if (rawSnapshotData) {
                    const patientsArray = Object.keys(rawSnapshotData).map(key => ({ id: key, ...rawSnapshotData[key] }));
                    patientsArray.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)); // Sort by newest first

                    patientsArray.forEach((patient) => {
                        hasPatients = true;
                        const patientId = patient.id;
                        console.log("Admin: Processing individual patient:", patientId, patient);
                        patientsListDiv.innerHTML += `
                            <div class="admin-card" style="background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);">
                                <h4>${patient.fullName}</h4>
                                <p><strong>Email:</strong> ${patient.email}</p>
                                <p><strong>Phone:</strong> ${patient.phoneNumber}</p>
                                <p><strong>Gender:</strong> ${patient.gender}</p>
                                <p style="font-size: 0.8em; opacity: 0.8;">Firebase ID: ${patientId}</p>
                                <!-- You could add buttons here for 'View Records' or 'Delete Patient' -->
                            </div>
                        `;
                    });
                }
                if (!hasPatients) {
                    patientsListDiv.innerHTML = '<p>No patients registered.</p>';
                }
                console.log("Admin: Patients loaded. Total displayed elements:", patientsListDiv.children.length);
            }, {
                onlyOnce: false
            });
        }

        // Load All Test Results for Admin
        function loadAdminTestResults() {
            const adminTestResultsListDiv = document.getElementById('adminTestResultsList');
            // IMPORTANT: Now checks if currentUser is set and isAdmin flag is true
            if (!currentUser || !isAdmin) {
                adminTestResultsListDiv.innerHTML = '<p>Unauthorized access. Please log in as Admin.</p>';
                return;
            }
            console.log("Admin: Loading all test results.");
            onValue(ref(database, 'testResults'), async (snapshot) => {
                adminTestResultsListDiv.innerHTML = ''; // Clear previous content
                let hasResults = false;
                const results = [];
                const rawSnapshotData = snapshot.val();
                console.log("Admin: Raw test results snapshot data (from Firebase):", JSON.stringify(rawSnapshotData, null, 2)); // CRITICAL: Log raw data from Firebase, stringified

                if (rawSnapshotData) {
                    snapshot.forEach((childSnapshot) => {
                        results.push(childSnapshot.val());
                    });
                }

                // Fetch patient names for display (only if results exist)
                if (results.length > 0) {
                    const patientPromises = results.map(result => get(ref(database, 'patients/' + result.userId)));
                    const patientSnapshots = await Promise.all(patientPromises);
                    const patientMap = {};
                    patientSnapshots.forEach(snap => {
                        if (snap.exists()) {
                            patientMap[snap.key] = snap.val().fullName || 'Unknown Patient';
                        }
                    });

                    results.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)); // Sort by newest first

                    results.forEach(result => {
                        hasResults = true;
                        const patientName = patientMap[result.userId] || 'N/A';
                        console.log("Admin: Processing individual test result for", patientName, ":", result);
                        adminTestResultsListDiv.innerHTML += `
                            <div class="test-result-item admin-card" style="background: linear-gradient(135deg, #00b894 0%, #00a085 100%);">
                                <h4>${result.testType} for ${patientName}</h4>
                                <p><strong>Score:</strong> ${result.score}</p>
                                <p><strong>Breakdown:</strong> ${result.breakdown}</p>
                                <p style="font-size: 0.8em; opacity: 0.8;">Taken on: ${new Date(result.createdAt).toLocaleString()}</p>
                                <!-- Optional: Display individual answers -->
                                <!-- <details><summary>View Answers</summary><pre>${JSON.stringify(result.answers, null, 2)}</pre></details> -->
                            </div>
                        `;
                    });
                }
                if (!hasResults) {
                    adminTestResultsListDiv.innerHTML = '<p>No test results found.</p>';
                }
                console.log("Admin: Test results loaded. Total displayed elements:", adminTestResultsListDiv.children.length);
            }, {
                onlyOnce: false
            });
        }

        // Load Approved Appointments for Admin Calendar
        function loadAdminCalendar() {
            const calendarEntriesDiv = document.getElementById('calendarEntries');
            // IMPORTANT: Now checks if currentUser is set and isAdmin flag is true
            if (!currentUser || !isAdmin) {
                calendarEntriesDiv.innerHTML = '<p>Unauthorized access. Please log in as Admin.</p>';
                return;
            }
            console.log("Admin: Loading approved appointments for calendar.");
            onValue(ref(database, 'appointments'), (snapshot) => {
                calendarEntriesDiv.innerHTML = ''; // Clear previous content
                let hasApprovedAppointments = false;
                const rawSnapshotData = snapshot.val();
                console.log("Admin: Raw calendar appointments snapshot data (from Firebase):", JSON.stringify(rawSnapshotData, null, 2));

                if (rawSnapshotData) {
                    const appointmentsArray = Object.keys(rawSnapshotData).map(key => ({ id: key, ...rawSnapshotData[key] }));
                    const approvedAppointments = appointmentsArray.filter(appt => appt.status === 'approved');
                    // Sorting logic might need refinement based on exact time string formats
                    approvedAppointments.sort((a, b) => {
                        // More robust date parsing for sorting
                        const dateA = new Date(a.time.replace('PM', ' PM').replace('AM', ' AM')); // Ensure space for parsing
                        const dateB = new Date(b.time.replace('PM', ' PM').replace('AM', ' AM'));
                        return dateA - dateB;
                    });

                    approvedAppointments.forEach((appt) => {
                        hasApprovedAppointments = true;
                        calendarEntriesDiv.innerHTML += `
                            <div class="calendar-entry">
                                <h4>Approved Appointment for ${appt.fullName}</h4>
                                <p><strong>Time:</strong> ${appt.time}</p>
                                <p><strong>Reason:</strong> ${appt.reason}</p>
                                <p style="font-size: 0.8em; opacity: 0.8;">Appointment ID: ${appt.id}</p>
                            </div>
                        `;
                    });
                }
                if (!hasApprovedAppointments) {
                    calendarEntriesDiv.innerHTML = '<p>No approved appointments found in the calendar.</p>';
                }
                console.log("Admin: Approved appointments loaded for calendar. Total displayed:", calendarEntriesDiv.children.length);
            }, {
                onlyOnce: false
            });
        }


        // --- Initial Load Logic and Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            // Set up main screen navigation
            document.getElementById('loginBtn').addEventListener('click', login);
            document.getElementById('showSignupBtn').addEventListener('click', showSignup);
            document.getElementById('showAdminLoginBtn').addEventListener('click', showAdminLogin);

            document.getElementById('signupBtn').addEventListener('click', signup);
            document.getElementById('backToLoginBtn').addEventListener('click', showLogin);

            document.getElementById('adminLoginBtn').addEventListener('click', adminLogin);
            document.getElementById('backToPatientLoginBtn').addEventListener('click', showLogin);

            // Set up dashboard logout buttons
            document.getElementById('patientLogoutBtn').addEventListener('click', logout);
            document.getElementById('adminLogoutBtn').addEventListener('click', logout);

            // Set up patient dashboard buttons
            document.getElementById('showBookingFormBtn').addEventListener('click', showBookingForm);
            document.getElementById('submitAppointmentRequestBtn').addEventListener('click', bookAppointment);
            document.getElementById('hideBookingFormBtn').addEventListener('click', hideBookingForm);
            document.getElementById('submitTestBtn').addEventListener('click', submitTest);
            document.getElementById('cancelTestBtn').addEventListener('click', cancelTest);


            // Set up patient sidebar navigation using event delegation
            document.getElementById('patientSidebarNav').addEventListener('click', (event) => {
                if (event.target.tagName === 'LI' && event.target.dataset.section) {
                    showPatientSection(event.target.dataset.section);
                }
            });

            // Set up test card event listeners using event delegation for mentalHealthSection
            document.getElementById('mentalHealthSection').addEventListener('click', (event) => {
                if (event.target.closest('.test-card')) {
                    const testType = event.target.closest('.test-card').dataset.testType;
                    startTest(testType);
                }
            });

            // Set up admin sidebar navigation using event delegation
            document.getElementById('adminSidebarNav').addEventListener('click', (event) => {
                if (event.target.tagName === 'LI' && event.target.dataset.section) {
                    showAdminSection(event.target.dataset.section);
                }
            });

            // Set up admin patient management buttons
            document.getElementById('showAddPatientFormBtn').addEventListener('click', showAddPatientForm);
            document.getElementById('addPatientBtn').addEventListener('click', addPatient);
            document.getElementById('hideAddPatientFormBtn').addEventListener('click', hideAddPatientForm);


            // Check Firebase Auth state on page load
            onAuthStateChanged(auth, (user) => {
                console.log("Auth state changed. Current user:", user ? user.uid : "No user");
                if (user) {
                    currentUser = user;
                    // Check if this logged-in user is our admin user
                    if (currentUser.email === ADMIN_EMAIL) {
                        isAdmin = true;
                        console.log("Auth state changed: Admin user logged in. UID:", user.uid);
                        showAdminDashboard();
                    } else {
                        isAdmin = false;
                        console.log("Auth state changed: Regular patient user logged in. UID:", user.uid);
                        showPatientDashboard();
                    }
                } else {
                    // If no Firebase Auth user, check if admin was previously logged in via session storage
                    // (This fallback is mostly for initial page load before Auth state is fully determined,
                    // or if local admin status needs to persist across refreshes without immediate Auth re-check,
                    // but the primary admin login is now via Firebase Auth.)
                    if (sessionStorage.getItem('isAdminLoggedIn') === 'true') {
                         // Note: If using strict Firebase Auth for admin, this might become less critical
                         // as onAuthStateChanged would typically handle it. Keeping for robustness.
                         isAdmin = true; // Assume admin based on session storage if no current Auth user
                         console.log("Auth state changed: Admin session found (from storage, no current Auth user).");
                         showAdminDashboard();
                    } else {
                        console.log("Auth state changed: No user or admin session found. Showing login.");
                        showLogin(); // Show login screen by default
                    }
                }
            });
        });

    </script>
</body>
</html>
