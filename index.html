<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealMed Patient/Admin Portal</title>
    <!-- FullCalendar CSS -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.css" rel="stylesheet" />
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Allf CSS styles are now embedded here */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column; /* Changed to column to stack header on top */
            align-items: center;
            justify-content: flex-start; /* Align content from the top */
            overflow-y: auto; /* Allow scrolling for content that overflows viewport */
        }

        .container {
            width: 100%;
            max-width: 1200px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            margin: 20px;
            flex-grow: 1; /* Allow container to grow and fill space below header */
        }

        .hidden {
            display: none !important;
        }

        /* Top Header for Branding */
        .header-branding {
            width: 100%; /* Take full width */
            padding: 20px;
            background: #2c3e50; /* Dark background for header */
            color: white;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            margin-bottom: 20px; /* Space between header and container */
        }

        .header-branding h1 {
            font-size: 2.5em; /* Larger for main name */
            font-weight: 700;
            margin-bottom: 5px; /* Space between name and slogan */
        }
        .header-branding p {
            font-size: 1.2em; /* Slogan size */
            opacity: 0.8;
            margin: 0; /* Remove default paragraph margin */
        }


        /* Login Screen - NEW FLEXBOX LAYOUT */
        .login-screen-wrapper {
            display: flex;
            flex-direction: row; /* Default to row for larger screens */
            justify-content: center;
            align-items: flex-start; /* Align items to the top if they have different heights */
            width: 100%;
            padding: 20px;
            gap: 30px; /* Space between the two columns */
            flex-grow: 1; /* Allow it to grow and fill space */
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); /* Background for the whole area */
        }

        /* Specific styling for the login form and public access box */
        .login-form-container, .public-access-container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            flex-shrink: 0; /* Prevent shrinking */
        }

        .login-form-container {
            width: 450px; /* Fixed width for login form, adjust as needed */
            max-width: 100%; /* Ensure it doesn't overflow on very small screens */
        }

        .public-access-container {
            width: 450px; /* Fixed width for public access, adjust as needed */
            max-width: 100%; /* Ensure it doesn't overflow on very small screens */
            display: flex;
            flex-direction: column;
        }
        .public-access-container h2 {
            margin-bottom: 20px;
            color: #333;
            font-size: 28px;
            text-align: center;
        }

        .public-access-buttons {
            display: flex;
            flex-direction: column; /* Stack buttons vertically */
            gap: 15px; /* Spacing between buttons */
            margin-bottom: 20px; /* Space below buttons before info boxes */
        }

        .public-access-buttons .btn {
            background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%); /* Green for public access */
            padding: 15px;
            font-size: 1.1em;
            width: 100%; /* Ensure full width within its container */
            margin-bottom: 0; /* Override default btn margin */
            text-decoration: none !important; /* NEW: Remove underline */
            text-align: center; /* NEW: Center text */
        }
        .public-access-buttons .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .info-box {
            background: #e9ecef;
            border-left: 5px solid #667eea;
            border-radius: 8px;
            padding: 15px;
            font-size: 0.95em;
            color: #333;
            line-height: 1.5;
            margin-top: 15px; /* Space between info boxes */
        }


        .login-form h2 {
            margin-bottom: 30px;
            color: #333;
            font-size: 28px;
        }

        /* NEW: Centering buttons in login/signup forms */
        .login-form {
            text-align: center; /* Center all block/inline-block children */
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left; /* Keep labels/inputs left-aligned within their group */
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
            margin-bottom: 10px;
            text-decoration: none !important; /* NEW: Remove underline */
            text-align: center; /* NEW: Center text */
        }
        .btn.external-link-btn { /* Style for external link buttons */
            width: auto;
            padding: 10px 25px;
            margin-top: 15px;
            display: inline-block; /* Allows text to wrap without full width */
            text-decoration: none !important; /* NEW: Remove underline */
            text-align: center; /* NEW: Center text */
            margin-right: 10px; /* Space between multiple buttons */
        }
        /* Style for patient list buttons in admin panel */
        .btn.patient-card-btn {
            background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%); /* Admin patient card background */
            color: white;
            text-align: left; /* Keep left-aligned for more content */
            padding: 15px 20px;
            margin-bottom: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            font-size: 1.2em;
            font-weight: bold;
            display: flex; /* Use flex to align text and icon */
            justify-content: space-between; /* Push text to left, icon to right */
            align-items: center;
            width: 100%;
            text-decoration: none !important; /* NEW: Remove underline */
        }
        .btn.patient-card-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }

        /* New buttons for viewing specific patient data */
        .btn.view-patient-data-btn {
            background: #28a745;
            color: white;
            width: auto;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 15px;
            margin-right: 10px;
            margin-bottom: 10px;
            display: inline-block;
            text-decoration: none !important; /* NEW: Remove underline */
            text-align: center; /* NEW: Center text */
        }
        .btn.view-patient-data-btn.booked-appointments {
            background: linear-gradient(135deg, #ff8c00 0%, #ff5722 100%);
        }
        .btn.view-patient-data-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        .btn.view-patient-data-btn.booked-appointments:hover {
            background: #e66a00;
        }
        .patient-data-buttons-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            color: #333;
            text-decoration: none !important; /* NEW: Remove underline */
            text-align: center; /* NEW: Center text */
        }

        .link-btn {
            background: none;
            color: #667eea;
            text-decoration: none !important; /* NEW: Remove underline */
            border: none;
            cursor: pointer;
            font-size: 14px;
            padding: 0;
            display: inline-block; /* Essential for text-align to work on parent */
        }
        
        .radio-group-inline {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 10px;
        }
        .radio-option-inline {
            display: inline-flex;
            align-items: center;
        }
        .radio-option-inline input[type="radio"] {
            margin-right: 5px;
            width: auto;
            margin-top: 0;
        }
        .follow-up-question {
            margin-top: 10px;
            padding: 15px;
            background: #e9ecef;
            border-left: 5px solid #667eea;
            border-radius: 8px;
            font-size: 0.9em;
        }
        .follow-up-question label {
            font-weight: 600;
        }
        .follow-up-question textarea {
            min-height: 80px;
        }


        /* Dashboard */
        .dashboard {
            display: flex;
            min-height: 100%;
            position: relative;
        }

        .sidebar {
            width: 250px;
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px 0;
            flex-shrink: 0;
        }

        .sidebar h3 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
        }

        .sidebar ul {
            list-style: none;
        }

        .sidebar li {
            padding: 15px 30px;
            cursor: pointer;
            transition: background-color 0.3s;
            text-align: center; /* NEW: Center sidebar items text */
        }

        .sidebar li:hover, .sidebar li.active {
            background-color: rgba(255,255,255,0.1);
        }

        .main-content {
            flex: 1;
            padding: 40px;
            background: #f8f9fa;
            overflow-y: auto;
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }

        .section h2 {
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 24px;
        }

        /* Appointments */
        .appointment-card {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .appointment-card.booked-appt-card {
            background: linear-gradient(135deg, #ff8c00 0%, #ff5722 100%);
        }

        .appointment-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .status-pending {
            background: #f39c12;
        }

        .status-approved {
            background: #27ae60;
        }

        .status-denied {
            background: #e74c3c;
        }

        /* Mental Health Tests */
        .test-card {
            background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: transform 0.2s;
            text-decoration: none !important; /* NEW: Remove underline */
            text-align: center; /* NEW: Center text */
        }

        .test-card:hover {
            transform: translateY(-3px);
        }

        .question {
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            color: #333;
        }

        .question h4 {
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .radio-option:hover {
            background: #e9ecef;
        }

        .test-result-item {
            background: linear-gradient(135deg, #00b894 0%, #00a085 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            margin-bottom: 15px;
        }
        .tms-questionnaire-item {
            background: linear-gradient(135deg, #f0932b 0%, #eb4d4b 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            margin-bottom: 15px;
        }
        .tms-questionnaire-item ul {
            list-style: none;
            padding-left: 0;
            margin-top: 10px;
        }
        .tms-questionnaire-item li {
            margin-bottom: 5px;
        }

        /* Admin specific styles */
        .admin-card {
            background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .admin-card.approved-status {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        }
        .admin-card.denied-status {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
        .admin-card .document-image {
            max-width: 100px;
            max-height: 100px;
            border-radius: 8px;
            margin-top: 10px;
            border: 2px solid rgba(255,255,255,0.6);
            cursor: zoom-in;
            transition: transform 0.2s;
        }
        .admin-card .document-image:hover {
            transform: scale(1.05);
        }
        .admin-card .document-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed rgba(255,255,255,0.5);
        }
        .admin-card .document-item {
            margin-bottom: 10px;
        }

        .action-buttons {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        .btn-approve {
            background: #27ae60;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.2s;
            text-align: center; /* NEW: Center text */
        }
        .btn-approve:hover {
            transform: translateY(-2px);
        }

        .btn-deny {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.2s;
            text-align: center; /* NEW: Center text */
        }
        .btn-deny:hover {
            transform: translateY(-2px);
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 100;
            text-align: center; /* NEW: Center text */
        }

        .calendar-entry {
            background: linear-gradient(135deg, #81ecec 0%, #00cec9 100%);
            color: #333;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .calendar-entry h4 {
            color: #2c3e50;
            margin-bottom: 5px;
        }

        /* FullCalendar specific styles */
        #calendar {
            max-width: 900px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            min-height: 500px;
        }

        .fc .fc-toolbar-title {
            font-size: 1.8em;
            color: #2c3e50;
        }

        .fc .fc-button-primary {
            background-color: #667eea;
            border-color: #667eea;
            color: white;
            border-radius: 5px;
            padding: 8px 15px;
            transition: background-color 0.2s;
            text-decoration: none !important; /* NEW: Remove underline */
            text-align: center; /* NEW: Center text */
        }
        .fc .fc-button-primary:hover {
            background-color: #5a6de0;
            border-color: #5a6de0;
        }
        .fc .fc-button-primary:not(:disabled).fc-button-active {
            background-color: #4a5dc1;
            border-color: #4a5dc1;
        }

        /* Custom event rendering for FullCalendar: green circle */
        .fc-event-main-frame {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .event-circle {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #27ae60;
            flex-shrink: 0;
        }
        /* Default FullCalendar event background */
        .fc-event {
            background-color: #0984e3 !important;
            border-color: #0984e3 !important;
            border-radius: 5px !important;
            padding: 3px 5px !important;
            font-size: 0.85em !important;
            cursor: pointer;
            text-decoration: none !important; /* NEW: Remove underline */
            text-align: center; /* NEW: Center text */
        }
        /* Specific styling for the green dot events (if you want to override default background) */
        .fc-event.approved-event {
            background-color: #27ae60 !important;
            border-color: #27ae60 !important;
        }

        .fc-event-title {
            color: white !important;
            font-weight: bold;
        }
        
        .fc-event-time {
            color: rgba(255, 255, 255, 0.8) !important;
        }

        /* Modal for event details */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border: 1px solid #888;
            border-radius: 15px;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: relative;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-content h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 22px;
        }
        .modal-content p {
            margin-bottom: 8px;
            color: #555;
        }
        .modal-content hr {
            margin: 20px 0;
            border: 0;
            border-top: 1px solid #eee;
        }
        .modal-content .form-group {
            margin-bottom: 15px;
        }
        .modal-content .form-group label {
            font-weight: bold;
        }

        /* Admin TMS Submissions specific styles */
        .tms-submission-card, .public-test-submission-card { /* Combined style for similar cards */
            background: linear-gradient(135deg, #FFC107 0%, #FF9800 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            display: flex; /* Use flex for alignment */
            justify-content: space-between; /* Push content to left, buttons to right */
            align-items: center;
        }
        .public-test-submission-card {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%); /* Blue for public tests */
        }
        .tms-submission-card h4, .public-test-submission-card h4 {
            margin-bottom: 10px;
            font-size: 1.3em;
        }
        .tms-submission-card p, .public-test-submission-card p {
            margin-bottom: 5px;
            font-size: 0.95em;
        }
        .tms-submission-card .card-actions, .public-test-submission-card .card-actions {
            display: flex;
            flex-direction: column; /* Stack buttons vertically */
            gap: 8px;
            margin-left: 15px; /* Space from content */
            flex-shrink: 0; /* Prevent shrinking */
        }

        .tms-submission-card .btn-view-details, .public-test-submission-card .btn-view-details {
            background: #2c3e50;
            color: white;
            width: auto;
            padding: 8px 15px;
            border-radius: 5px;
            text-align: center;
            text-decoration: none !important;
        }
        .tms-submission-card .btn-view-details:hover, .public-test-submission-card .btn-view-details:hover {
            background: #34495e;
            transform: translateY(-2px);
        }

        /* Delete button styling (trash icon) */
        .btn-delete {
            background: none;
            border: none;
            color: #e74c3c; /* Red color for trash icon */
            font-size: 1.2em;
            cursor: pointer;
            padding: 5px;
            transition: color 0.2s, transform 0.2s;
        }
        .btn-delete:hover {
            color: #c0392b;
            transform: scale(1.1);
        }

        /* Public Mental Health Test Selection Screen */
        .public-test-selection {
            display: flex;
            flex-direction: column;
            gap: 20px;
            justify-content: center;
            align-items: center;
            padding: 40px;
            background: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%);
            min-height: 100%;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        }
        .public-test-selection h2 {
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 2em;
            text-align: center;
        }
        .public-test-selection .test-card {
            width: 80%;
            max-width: 400px;
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
            padding: 25px;
            font-size: 1.1em;
            text-align: center;
            cursor: pointer;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            text-decoration: none !important;
        }
        .public-test-selection .test-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .public-test-selection .test-card h3 {
            margin-bottom: 10px;
        }
        .public-test-selection .btn-back {
            margin-top: 30px;
            width: auto;
            padding: 10px 30px;
            background: #6c757d;
            color: white;
            text-align: center;
            text-decoration: none !important;
        }
        .public-test-selection .btn-back:hover {
            background: #5a6268;
        }

        /* Public Test Interface (reusing #testInterface, but styling differently for clarity) */
        #testInterface.public-test-interface {
            background: #f8f9fa;
            border-left: none;
            box-shadow: none;
            padding: 20px;
        }
        #testInterface.public-test-interface .question {
            background: white;
            border: 1px solid #e1e5e9;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        #testInterface.public-test-interface .btn {
            background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);
            text-align: center;
        }
        #testInterface.public-test-interface .btn-secondary {
            background: #6c757d;
            text-align: center;
        }

        /* Public Test Result Display */
        #publicTestResultDisplay {
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            color: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            text-align: center;
        }
        #publicTestResultDisplay h3 {
            font-size: 1.8em;
            margin-bottom: 15px;
        }
        #publicTestResultDisplay p {
            font-size: 1.1em;
            line-height: 1.6;
        }
        #publicTestResultDisplay .btn {
            margin-top: 25px;
            width: auto;
            padding: 10px 30px;
            background: #007bff;
            color: white;
            text-align: center;
            text-decoration: none !important;
        }
        #publicTestResultDisplay .btn-secondary {
            background: #6c757d;
            text-align: center;
            text-decoration: none !important;
        }

        @media (max-width: 768px) {
            .dashboard {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                padding: 10px 0;
            }

            .sidebar ul {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                padding: 0 5px;
                gap: 5px 10px;
            }

            .sidebar li {
                white-space: nowrap;
                flex-grow: 1;
                text-align: center;
                padding: 8px 12px;
                border-radius: 5px;
                margin: 0;
            }

            /* Specific spacing adjustments for the first three items (Manage Appointments, Mental Health Tests, Health Records) */
            #patientSidebarNav li:nth-child(1),
            #patientSidebarNav li:nth-child(2),
            #patientSidebarNav li:nth-child(3) {
                margin-bottom: 10px;
            }

            /* To decrease space between Profile and Forms (last two items), ensure no extra bottom margin */
            #patientSidebarNav li:nth-child(4),
            #patientSidebarNav li:nth-child(5) {
                margin-bottom: 0;
            }

            .main-content {
                padding: 15px;
            }

            .container {
                margin: 5px;
                border-radius: 10px;
            }

            /* Mobile specific for login screen */
            .login-screen-wrapper {
                flex-direction: column;
                gap: 20px;
                padding: 10px;
            }
            .login-form-container, .public-access-container {
                width: 100%;
                padding: 20px;
                border-radius: 10px;
            }
            .public-access-buttons .btn {
                padding: 12px;
                font-size: 1em;
            }

            .section {
                padding: 15px;
                border-radius: 10px;
            }

            /* Specifically target external link buttons for stacking on mobile */
            .btn.external-link-btn {
                display: block;
                width: 100%;
                margin-right: 0;
                margin-bottom: 10px;
                padding: 12px;
                font-size: 15px;
            }
            /* Adjust for the last button in a series to not have extra bottom margin */
            .section .btn.external-link-btn:last-child {
                margin-bottom: 0;
            }

            .patient-data-buttons-container {
                flex-direction: column;
                gap: 10px;
            }
            .btn.view-patient-data-btn {
                width: 100%;
                margin-right: 0;
                font-size: 14px;
            }

            #calendar {
                padding: 5px;
            }
            .fc .fc-toolbar-title {
                font-size: 1em;
            }

            .public-test-selection .test-card {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="header-branding">
        <h1>HealMed Clinic</h1>
        <p>Let's heal minds</p>
    </div>
    <div class="container">
        <!-- Login Screen and Public Access Container -->
        <div id="welcomeScreenWrapper" class="login-screen-wrapper">
            <!-- Left Side: Login/Signup Forms -->
            <div id="loginFormsContainer" class="login-form-container">
                <!-- Login Screen -->
                <div id="loginScreen">
                    <div class="login-form">
                        <h2>Patient Portal Login</h2>
                        <div class="form-group">
                            <label for="loginEmail">Email:</label>
                            <input type="email" id="loginEmail" placeholder="Enter your email" required>
                        </div>
                        <div class="form-group">
                            <label for="loginPassword">Password:</label>
                            <input type="password" id="loginPassword" placeholder="Enter your password" required>
                        </div>
                        <button class="btn" id="loginBtn">Login</button>
                        <button class="btn btn-secondary" id="showSignupBtn">Create Account</button>
                        <button class="link-btn" id="showAdminLoginBtn">Staff Login</button>
                    </div>
                </div>

                <!-- Signup Screen -->
                <div id="signupScreen" class="hidden">
                    <div class="login-form">
                        <h2>Create Account</h2>
                        <div class="form-group">
                            <label for="signupName">Full Name:</label>
                            <input type="text" id="signupName" placeholder="Enter your full name" required>
                        </div>
                        <div class="form-group">
                            <label for="signupEmail">Email:</label>
                            <input type="email" id="signupEmail" placeholder="Enter your email" required>
                        </div>
                        <div class="form-group">
                            <label for="signupPassword">Password:</label>
                            <input type="password" id="signupPassword" placeholder="Create a password" required>
                        </div>
                        <div class="form-group">
                            <label for="signupDob">Date of Birth:</label>
                            <input type="date" id="signupDob" required>
                        </div>
                        <div class="form-group">
                            <label for="signupPhone">Phone Number:</label>
                            <input type="tel" id="signupPhone" placeholder="Enter your phone number" required>
                        </div>
                        <div class="form-group">
                            <label for="signupGender">Gender:</label>
                            <select id="signupGender" required>
                                <option value="">Select Gender</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other</option>
                                <option value="prefer-not-to-say">Prefer not to say</option>
                            </select>
                        </div>
                        <button class="btn" id="signupBtn">Create Account</button>
                        <button class="link-btn" id="backToLoginBtn">Back to Login</button>
                    </div>
                </div>

                <!-- Admin Login Screen -->
                <div id="adminLoginScreen" class="hidden">
                    <div class="login-form">
                        <h2>Staff Login</h2>
                        <div class="form-group">
                            <label for="adminEmail">Email:</label>
                            <input type="email" id="adminEmail" placeholder="Enter admin email" required>
                        </div>
                        <div class="form-group">
                            <label for="adminPassword">Password:</label>
                            <input type="password" id="adminPassword" placeholder="Enter password" required>
                        </div>
                        <button class="btn" id="adminLoginBtn">Login</button>
                        <button class="link-btn" id="backToPatientLoginBtn">Back to Patient Login</button>
                    </div>
                </div>
            </div> <!-- End loginFormsContainer -->

            <!-- Right Side: Public Access Buttons -->
            <div class="public-access-container">
                <h2>Quick Access</h2>
                <div class="public-access-buttons">
                    <button class="btn" id="publicBookAppointmentBtn">Book an Appointment</button>
                    <button class="btn" id="publicTmsQuestionnaireBtn">TMS Daily Questionnaire</button>
                    <button class="btn" id="publicMentalHealthTestsBtn">Mental Health Tests</button>
                    <a href="https://www.jotform.com/sign/252266416139054/invite/01k4aw7t4ca0de73ae5eea78a9" target="_blank" class="btn">New Patient Form</a>
                    <a href="https://v-gedipudi1.github.io/consent-forms/" target="_blank" class="btn">TMS Consent Form</a>
                    <a href="https://g.page/r/CQWoZTjR8yFaEBM/review" class="btn">Write a Review</a>
                    <a href="https://docs.google.com/forms/d/e/1FAIpQLScOt3ov7drpfVaJ3GPPa3GyyEG4i3qErkgpz704BUxhGItg6Q/viewform?usp=header" target="_blank" class="btn">Upload ID and Insurance Form</a>
                </div>
                <div class="info-box" style="margin-top: 10px;">
                    <p><strong>Want to track your mental health progress?</strong> Create an account to securely view your mental health test results, past TMS questionnaires, and manage your appointments.</p>
                </div>
            </div>
        </div> <!-- End welcomeScreenWrapper -->

        <!-- NEW: Public Appointment Booking Section -->
        <div id="bookAppointmentSection" class="section hidden">
            <h2>Book an Appointment</h2>
            <p>Please fill out the form below to request an appointment. No login required.</p>
            <div class="form-group">
                <label for="publicApptFullName">Full Name:</label>
                <input type="text" id="publicApptFullName" placeholder="Enter your full name" required>
            </div>
            <div class="form-group">
                <label for="publicApptEmail">Email Address:</label>
                <input type="email" id="publicApptEmail" placeholder="Enter your email" required>
            </div>
            <div class="form-group">
                <label for="publicApptPhone">Phone Number:</label>
                <input type="tel" id="publicApptPhone" placeholder="Enter your phone number" required>
            </div>
            <div class="form-group">
                <label for="publicApptDob">Date of Birth:</label>
                <input type="date" id="publicApptDob" required>
            </div>
            <div class="form-group">
                <label for="publicApptInsurance">Insurance Provider:</label>
                <input type="text" id="publicApptInsurance" placeholder="e.g., BlueCross BlueShield, Aetna, etc." required>
            </div>
            <div class="form-group">
                <label for="publicApptReason">Reason for Visit:</label>
                <textarea id="publicApptReason" placeholder="Please describe the reason for your visit." required></textarea>
            </div>
            <button class="btn" id="submitPublicAppointmentBtn">Submit Request</button>
            <button class="btn btn-secondary" id="cancelPublicAppointmentBtn">Cancel</button>
        </div>

        <!-- NEW: Public Mental Health Test Selection Screen (initially hidden) -->
        <div id="publicMentalHealthTestsSection" class="section public-test-selection hidden">
            <h2>Select a Mental Health Test</h2>
            <div class="test-card" data-test-type="depression">
                <h3>Depression Screening (PHQ-9)</h3>
                <p>Take a self-assessment to screen for depression symptoms</p>
            </div>
            <div class="test-card" data-test-type="anxiety">
                <h3>Anxiety Screening (GAD-7)</h3>
                <p>Take a self-assessment to screen for anxiety symptoms</p>
            </div>
            <div class="test-card" data-test-type="adhd">
                <h3>ADHD Screening</h3>
                <p>Take a self-assessment to screen for ADHD symptoms</p>
            </div>
            <button class="btn btn-back" id="backToPublicAccessBtn">Back to Main Screen</button>
        </div>

        <!-- TEST INTERFACE: MOVED HERE, OUTSIDE DASHBOARD -->
        <div id="testInterface" class="section hidden">
            <h2 id="testTitle"></h2>
            <!-- NEW: Full Name field for public tests -->
            <div id="publicTestNameField" class="form-group hidden">
                <label for="publicTestFullName">Your Full Name:</label>
                <input type="text" id="publicTestFullName" placeholder="Enter your full name" required>
            </div>
            <div id="testQuestions"></div>
            <button class="btn" id="submitTestBtn">Submit Test</button>
            <button class="btn btn-secondary" id="cancelTestBtn">Cancel</button>
            <!-- Public test result display will appear here -->
            <div id="publicTestResultDisplay" class="hidden"></div>
        </div>

        <!-- TMS DAILY QUESTIONNAIRE SECTION: MOVED HERE, OUTSIDE DASHBOARD -->
        <div id="tmsQuestionnaireSection" class="section hidden">
            <h2>TMS Daily Questionnaire</h2>
            <p>Please fill out the following information and questions.</p>
            <div class="form-group">
                <label for="tmsFullName">Full Name:</label>
                <input type="text" id="tmsFullName" placeholder="Your full name" required>
            </div>
            <div class="form-group">
                <label for="tmsEmail">Email:</label>
                <input type="email" id="tmsEmail" placeholder="Your email" required>
            </div>
            <div class="form-group">
                <label for="tmsPhone">Phone Number:</label>
                <input type="tel" id="tmsPhone" placeholder="Your phone number" required>
            </div>
            <hr style="margin: 30px 0; border: 0; border-top: 1px solid #ccc;">

            <div class="form-group">
                <label>1. Have you had anything to eat or drink today?</label>
                <div class="radio-group-inline">
                    <label class="radio-option-inline"><input type="radio" name="q1_eat_drink" value="yes" required> Yes</label>
                    <label class="radio-option-inline"><input type="radio" name="q1_eat_drink" value="no"> No</label>
                </div>
                <div id="q1_followup" class="follow-up-question hidden">
                    <label for="q1_eat_drink_details">What did you have to eat or drink?</label>
                    <textarea id="q1_eat_drink_details"></textarea>
                </div>
            </div>

            <div class="form-group">
                <label>3. Have you been taking your medication as prescribed and at the same time?</label>
                <div class="radio-group-inline">
                    <label class="radio-option-inline"><input type="radio" name="q2_med_prescribed" value="yes" required> Yes</label>
                    <label class="radio-option-inline"><input type="radio" name="q2_med_prescribed" value="no"> No</label>
                </div>
                <div id="q2_followup" class="follow-up-question hidden">
                    <label>3a. Any changes to your medication?</label>
                    <div class="radio-group-inline">
                        <label class="radio-option-inline"><input type="radio" name="q2a_med_changes" value="yes" required> Yes</label>
                        <label class="radio-option-inline"><input type="radio" name="q2a_med_changes" value="no"> No</label>
                    </div>
                    <div id="q2a_followup" class="follow-up-question hidden">
                        <label for="q2a_med_changes_details">Please specify changes to your medication:</label>
                        <textarea id="q2a_med_changes_details"></textarea>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="q3_sleep_hours">4. How did you sleep last night? Number of hours?</label>
                <input type="text" id="q3_sleep_hours" min="0" max="24" placeholder="Enter hours" required>
            </div>

            <div class="form-group">
                <label>5. Any caffeine intake today?</label>
                <div class="radio-group-inline">
                    <label class="radio-option-inline"><input type="radio" name="q4_caffeine" value="yes" required> Yes</label>
                    <label class="radio-option-inline"><input type="radio" name="q4_caffeine" value="no"> No</label>
                </div>
                <div id="q4_followup" class="follow-up-question hidden">
                    <label for="q4_caffeine_details">What caffeine drink did you have or how many?</label>
                    <textarea id="q4_caffeine_details"></textarea>
                </div>
            </div>

            <div class="form-group">
                <label>6. Any alcohol intake today?</label>
                <div class="radio-group-inline">
                    <label class="radio-option-inline"><input type="radio" name="q5_alcohol" value="yes" required> Yes</label>
                    <label class="radio-option-inline"><input type="radio" name="q5_alcohol" value="no"> No</label>
                </div>
                <div id="q5_followup" class="follow-up-question hidden">
                    <label for="q5_alcohol_details">How much alcohol?</label>
                    <textarea id="q5_alcohol_details"></textarea>
                </div>
            </div>

            <div class="form-group">
                <label>2. Have you consumed any substances that were NOT prescribed by any physicians today?</label>
                <div class="radio-group-inline">
                    <label class="radio-option-inline"><input type="radio" name="q_unprescribed_substance" value="yes" required> Yes</label> <!-- Changed name to avoid conflict -->
                    <label class="radio-option-inline"><input type="radio" name="q_unprescribed_substance" value="no"> No</label>
                </div>
            </div>

            <div class="form-group">
                <label>7. Do you have any metal in or around your head (above the collar)?</label>
                <div class="radio-group-inline">
                    <label class="radio-option-inline"><input type="radio" name="q6_metal_head" value="yes" required> Yes</label>
                    <label class="radio-option-inline"><input type="radio" name="q6_metal_head" value="no"> No</label>
                </div>
                <div id="q6_followup" class="follow-up-question hidden">
                    <label for="q6_metal_head_details">Please specify (e.g., dental implants, surgical clips, shrapnel, etc.):</label>
                    <textarea id="q6_metal_head_details"></textarea>
                </div>
            </div>

            <button class="btn" id="submitTmsQuestionnaireBtn">Submit Questionnaire</button>
            <button class="btn btn-secondary" id="cancelTmsQuestionnaireBtn">Cancel</button>
        </div>

        <!-- Patient Dashboard -->
        <div id="patientDashboard" class="dashboard hidden">
            <button class="logout-btn" id="patientLogoutBtn">Logout</button>
            <div class="sidebar">
                <h3>Patient Portal</h3>
                <ul id="patientSidebarNav">
                    <li class="active" data-section="appointments">Manage Appointments</li>
                    <li data-section="mentalHealth">Mental Health Tests</li>
                    <li data-section="healthRecords">Health Records</li>
                    <li data-section="profile">Profile</li>
                    <li data-section="forms">Forms</li>
                </ul>
            </div>
            <div class="main-content">
                <!-- Appointments Section -->
                <div id="appointmentsSection" class="section">
                    <h2>Manage Appointments</h2>
                    <div id="appointmentsList"></div>
                    <button class="btn" id="showBookingFormBtn">Book New Appointment</button>

                    <!-- Booking Form (OLD - Now removed from patient portal view) -->
                    <div id="bookingForm" class="hidden" style="margin-top: 20px; background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <h3>Book New Appointment</h3>
                         <div class="form-group">
                            <label for="insuranceProvider">Insurance Provider:</label>
                            <input type="text" id="insuranceProvider" placeholder="e.g., BlueCross BlueShield, Aetna, etc." required>
                        </div>
                        <div class="form-group">
                            <label for="appointmentReason">Reason for Visit:</label>
                            <textarea id="appointmentReason" placeholder="Please describe the reason for your visit" required></textarea>
                        </div>
                        <button class="btn" id="submitAppointmentRequestBtn">Submit Request</button>
                        <button class="btn btn-secondary" id="hideBookingFormBtn">Cancel</button>
                    </div>
                </div>

                <!-- Mental Health Tests Section -->
                <div id="mentalHealthSection" class="section hidden">
                    <h2>Mental Health Tests</h2>
                    <div class="test-card" data-test-type="depression">
                        <h3>Depression Screening (PHQ-9)</h3>
                        <p>Take a self-assessment to screen for depression symptoms</p>
                    </div>
                    <div class="test-card" data-test-type="anxiety">
                        <h3>Anxiety Screening (GAD-7)</h3>
                        <p>Take a self-assessment to screen for anxiety symptoms</p>
                    </div>
                    <div class="test-card" data-test-type="adhd">
                        <h3>ADHD Screening</h3>
                        <p>Take a self-assessment to screen for ADHD symptoms</p>
                    </div>
                    <h4>Your Past Test Results:</h4>
                    <div id="testResultsList"></div>
                </div>

                <!-- Health Records Section -->
                <div id="healthRecordsSection" class="section hidden">
                    <h2>Health Records</h2>
                    <p>Your health records and medical history will be displayed here.</p>
                    <div id="healthRecordsList"></div>
                </div>

                <!-- Profile Section -->
                <div id="profileSection" class="section hidden">
                    <h2>Profile</h2>
                    <div id="profileInfo"></div>
                </div>

                <!-- Patient Forms Section (Updated with TMS Daily Questionnaire) -->
                <div id="formsSection" class="section hidden">
                    <h2>Forms</h2>
                    <p>Please review and complete any necessary forms below.</p>
                    <button class="btn" id="showTmsQuestionnaireBtnLoggedIn" style="margin-top: 15px;">TMS Daily Questionnaire</button>
                    <a href="https://www.jotform.com/sign/252085253506050/invite/01k190pcbr58c982c0b734acb5" target="_blank" class="btn external-link-btn">New Patient Form</a>
                    <a href="https://v-gedipudi1.github.io/consent-forms/" target="_blank" class="btn external-link-btn">TMS Consent Form</a>
                    <a href="https://docs.google.com/forms/d/e/1FAIpQLScOt3ov7drpfVaJ3GPPa3GyyEG4i3qErkgpz704BUxhGItg6Q/viewform?usp=header" target="_blank" class="btn external-link-btn">Upload ID and Insurance Form</a>
                </div>

            </div>
        </div>

        <!-- Admin Dashboard -->
        <div id="adminDashboard" class="dashboard hidden">
            <button class="logout-btn" id="adminLogoutBtn">Logout</button>
            <div class="sidebar">
                <h3>Admin Portal</h3>
                <ul id="adminSidebarNav">
                    <li class="active" data-section="appointments">Appointment Requests</li>
                    <li data-section="patients">Patient Management</li>
                    <li data-section="tmsSubmissions">View All TMS Submissions</li>
                    <li data-section="publicTestResults">Public Test Results</li> <!-- NEW ADMIN SIDEBAR ITEM -->
                    <li data-section="calendar">Calendar</li>
                    <li data-section="doctorPortal">Doctor Portal</li>
                </ul>
            </div>
            <div class="main-content">
                <!-- Admin Appointments Section -->
                <div id="adminAppointmentsSection" class="section">
                    <h2 id="adminAppointmentsTitle">Appointment Requests</h2>
                    <div id="adminPendingAppointmentsList"></div>
                </div>

                <!-- Admin Patients Section -->
                <div id="adminPatientsSection" class="section">
                    <h2>Patient Management</h2>
                    <button class="btn" id="showAddPatientFormBtn">Add New Patient (via Admin)</button>
                    
                    <!-- List of patient buttons -->
                    <div id="patientsList" class="patient-list-container"></div>

                    <!-- Patient Detail View (Initially Hidden) -->
                    <div id="patientDetailView" class="hidden">
                        <button class="btn btn-secondary" id="backToPatientsListBtn" style="margin-bottom: 20px;">Back to All Patients</button>
                        <h3>Patient Details: <span id="patientDetailName"></span></h3>
                        <div id="patientBasicInfo"></div>
                        <div class="patient-data-buttons-container">
                            <button class="btn view-patient-data-btn" id="viewPatientMentalHealthResultsBtn">View Mental Health Test Results</button>
                            <button class="btn view-patient-data-btn" id="viewPatientTmsQuestionnairesBtn">View TMS Daily Questionnaires</button>
                            <button class="btn view-patient-data-btn booked-appointments" id="viewPatientBookedAppointmentsBtn">View Booked Appointments</button>
                        </div>
                        <div id="patientSpecificDataResults" style="margin-top: 20px;"></div>
                    </div>

                    <!-- Add Patient Form -->
                    <div id="addPatientForm" class="hidden" style="margin-top: 20px; background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <h3>Add New Patient</h3>
                        <div class="form-group">
                            <label for="newPatientName">Full Name:</label>
                            <input type="text" id="newPatientName" required>
                        </div>
                        <div class="form-group">
                            <label for="newPatientEmail">Email:</label>
                            <input type="email" id="newPatientEmail" required>
                        </div>
                        <div class="form-group">
                            <label for="newPatientPassword">Password:</label>
                            <input type="password" id="newPatientPassword" required>
                        </div>
                        <div class="form-group">
                            <label for="newPatientDob">Date of Birth:</label>
                            <input type="date" id="newPatientDob" required>
                        </div>
                        <div class="form-group">
                            <label for="newPatientPhone">Phone:</label>
                            <input type="tel" id="newPatientPhone" required>
                        </div>
                        <div class="form-group">
                            <label for="newPatientGender">Gender:</label>
                            <select id="newPatientGender" required>
                                <option value="">Select Gender</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other</option>
                                <option value="prefer-not-to-say">Prefer not to say</option>
                            </select>
                        </div>
                        <button class="btn" id="addPatientBtn">Add Patient</button>
                        <button class="btn btn-secondary" id="hideAddPatientFormBtn">Cancel</button>
                    </div>
                </div>

                <!-- New Admin TMS Submissions Section -->
                <div id="adminTmsSubmissionsSection" class="section hidden">
                    <h2>All TMS Daily Questionnaires</h2>
                    <div id="tmsSubmissionsList">
                        <p>Loading TMS submissions...</p>
                    </div>
                </div>

                <!-- NEW ADMIN PUBLIC TEST RESULTS SECTION -->
                <div id="adminPublicTestResultsSection" class="section hidden">
                    <h2>All Mental Health Test Results</h2>
                    <div id="publicTestResultsList">
                        <p>Loading mental health test results...</p>
                    </div>
                </div>

                <!-- Admin Calendar Section (Updated for FullCalendar) -->
                <div id="adminCalendarSection" class="section hidden">
                    <h2>Approved Appointments Calendar</h2>
                    <div id="calendar"></div> <!-- FullCalendar will render here -->
                </div>

                <!-- Admin Doctor Portal Section -->
                <div id="adminDoctorPortalSection" class="section hidden">
                    <h2>Doctor Portal</h2>
                    <p>Access the specialized doctor's interface here.</p>
                    <a href="https://v-gedipudi1.github.io/consent-forms/doctor_portal.html" target="_blank" class="btn external-link-btn">Access Doctor Portal</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for displaying FullCalendar event details -->
    <div id="eventDetailsModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button" id="closeModalBtn">&times;</span>
            <h3 id="modalEventTitle"></h3>
            <p><strong>Patient:</strong> <span id="modalPatientName"></span></p>
            <p><strong>Email:</strong> <span id="modalPatientEmail"></span></p>
            <p><strong>Phone:</strong> <span id="modalPatientPhone"></span></p>
            <p><strong>Date & Time:</strong> <span id="modalEventDateTime"></span></p>
            <p><strong>Date of Birth:</strong> <span id="modalEventDob"></span></p>
            <p><strong>Reason:</strong> <span id="modalEventReason"></span></p>
            <p><strong>Status:</strong> <span id="modalEventStatus"></span></p>
        </div>
    </div>

    <!-- Modal for displaying full TMS questionnaire details (Admin side) -->
    <div id="tmsDetailModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button" id="closeTmsModalBtn">&times;</span>
            <h3 id="tmsModalTitle">TMS Questionnaire from <span id="tmsModalPatientName"></span></h3>
            <p><strong>Email:</strong> <span id="tmsModalPatientEmail"></span></p>
            <p><strong>Phone:</strong> <span id="tmsModalPatientPhone"></span></p>
            <p><strong>Submitted On:</strong> <span id="tmsModalSubmittedAt"></span></p>
            <hr>
            <div id="tmsModalAnswers"></div>
            <hr>
            <!-- NEW: Download PDF Button -->
            <button class="btn" id="downloadTmsPdfBtn" style="margin-top: 15px;">Download PDF</button>
            <button class="btn" id="moveTmsToPatientBtn" style="margin-top: 15px;">Move to Patient Account</button>
            <div id="assignTmsToPatientSection" class="form-group hidden" style="margin-top: 20px;">
                <label for="tmsPatientSelectDropdown">Assign to Patient:</label>
                <select id="tmsPatientSelectDropdown" style="width: 100%; padding: 10px; border-radius: 5px; margin-bottom: 10px;"></select>
                <button class="btn" id="confirmTmsAssignmentBtn" style="width: 100%;">Confirm Assignment</button>
            </div>
        </div>
    </div>
    
    <!-- NEW: Modal for displaying full Public Test submission details (Admin side) -->
    <div id="publicTestDetailModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button" id="closePublicTestModalBtn">&times;</span>
            <h3 id="publicTestModalTitle">Mental Health Test Submission (<span id="publicTestModalType"></span>)</h3>
            <p><strong>Submitted By:</strong> <span id="publicTestModalSubmitter"></span></p>
            <p><strong>Email:</strong> <span id="publicTestModalSubmitterEmail"></span></p>
            <p><strong>Phone:</strong> <span id="publicTestModalSubmitterPhone"></span></p>
            <p><strong>Score:</strong> <span id="publicTestModalScore"></span></p>
            <p><strong>Breakdown:</strong> <span id="publicTestModalBreakdown"></span></p>
            <p><strong>Submitted On:</strong> <span id="publicTestModalSubmittedAt"></span></p>
            <hr>
            <div id="publicTestModalAnswers"></div>
            <hr>
            <button class="btn" id="movePublicTestToPatientBtn" style="margin-top: 15px;">Move to Patient Account</button>
            <div id="assignPublicTestToPatientSection" class="form-group hidden" style="margin-top: 20px;">
                <label for="publicTestPatientSelectDropdown">Assign to Patient:</label>
                <select id="publicTestPatientSelectDropdown" style="width: 100%; padding: 10px; border-radius: 5px; margin-bottom: 10px;"></select>
                <button class="btn" id="confirmPublicTestAssignmentBtn" style="width: 100%;">Confirm Assignment</button>
            </div>
        </div>
    </div>

    <!-- NEW: Custom Confirmation Modal HTML -->
    <!-- This modal will be dynamically inserted by showConfirmationModal JS function -->


    <!-- FullCalendar JavaScript (Must be loaded AFTER the DOM elements) -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

    <script type="module">
        // --- Firebase Configuration (YOUR ACTUAL KEYS) ---
        const firebaseConfig = {
            apiKey: "AIzaSyD440QOEKOT3oRUORipguPtttraawzPGgs",
            authDomain: "healmed-portal-backend.firebaseapp.com",
            projectId: "healmed-portal-backend",
            storageBucket: "healmed-portal-backend.firebasestorage.app",
            messagingSenderId: "979152928801",
            appId: "1:979152928801:web:2e5dbbd801732a4e44e360",
            measurementId: "G-1MKT9TNCJ5",
            databaseURL: "https://healmed-portal-backend-default-rtdb.firebaseio.com"
        };

        // --- Firebase SDK v9 Modular Imports from CDN ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, deleteUser } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, update, remove, get } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-analytics.js";

        // --- Initialize Firebase Services ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        const analytics = getAnalytics(app);

        // --- Global State Variables ---
        let currentUser = null; // Stores current Firebase authenticated user object
        let isAdmin = false; // Flag for admin status (set after successful Firebase admin login)
        let currentTest = null; // Stores details of the test currently being taken
        let adminCalendarInstance = null; // To hold the FullCalendar object for the admin portal
        let currentPatientIdInAdminView = null; // To track which patient is currently being viewed by admin
        let isPublicTestMode = false; // Flag to indicate if currently taking a public test
        let allPatientsData = []; // To store a list of all patients for dropdowns
        let currentTmsSubmissionForPdf = null; // Stores the TMS submission data for PDF download


        // --- Admin Credentials (Email must exist in Firebase Authentication) ---
        const ADMIN_EMAIL = 'admin@healmed.com'; // Use the email you created in Firebase Auth
        const ADMIN_PASSWORD_REFERENCE = 'healthcare2024'; // For clarity, we refer to it.

        // --- Mental Health Test Questions and Scoring ---
        const testQuestions = {
            depression: {
                title: 'Depression Screening (PHQ-9)',
                questions: [
                    'Little interest or pleasure in doing things',
                    'Feeling down, depressed, or hopeless',
                    'Trouble falling or staying asleep, or sleeping too much',
                    'Feeling tired or having little energy',
                    'Poor appetite or overeating',
                    'Feeling bad about yourself — or that you are a failure or have let yourself or your family down',
                    'Trouble concentrating on things, such as reading the newspaper or watching television',
                    'Moving or speaking so slowly that other people could have noticed. Or the opposite — being so fidgety or restless that you have been moving around a lot more than usual',
                    'Thoughts that you would be better off dead, or of hurting yourself in any way'
                ],
                options: [
                    { text: 'Not at all', value: 0 },
                    { text: 'Several days', value: 1 },
                    { text: 'More than half the days', value: 2 },
                    { text: 'Nearly every day', value: 3 }
                ],
                scoring: {
                    ranges: [
                        { min: 0, max: 4, level: 'Minimal', description: 'Minimal depression symptoms. No treatment is warranted at this time.' },
                        { min: 5, max: 9, level: 'Mild', description: 'Mild depression symptoms. Watchful waiting; repeat PHQ-9 at follow-up.' },
                        { min: 10, max: 14, level: 'Moderate', description: 'Moderate depression symptoms. Treatment plan, considering counseling, follow-up and/or pharmacotherapy.' },
                        { min: 15, max: 19, level: 'Moderately Severe', description: 'Moderately severe depression symptoms. Active treatment with pharmacotherapy and/or psychotherapy.' },
                        { min: 20, max: 27, level: 'Severe', description: 'Severe depression symptoms. Immediate initiation of pharmacotherapy and, if severe impairment or poor response to therapy, expedited referral to a mental health specialist for psychotherapy and/or collaborative management.' }
                    ]
                },
                getBreakdown: (score) => {
                    for (const range of testQuestions.depression.scoring.ranges) {
                        if (score >= range.min && score <= range.max) {
                            return range.description;
                        }
                    }
                    return 'N/A';
                }
            },
            anxiety: {
                title: 'Anxiety Screening (GAD-7)',
                questions: [
                    'Feeling nervous, anxious, or on edge',
                    'Not being able to stop or control worrying',
                    'Worrying too much about different things',
                    'Trouble relaxing',
                    'Being so restless that it is hard to sit still',
                    'Becoming easily annoyed or irritable',
                    'Feeling afraid, as if something awful might happen'
                ],
                options: [
                    { text: 'Not at all', value: 0 },
                    { text: 'Several days', value: 1 },
                    { text: 'More than half the days', value: 2 },
                    { text: 'Nearly every day', value: 3 }
                ],
                scoring: {
                    ranges: [
                        { min: 0, max: 4, level: 'Minimal', description: 'Minimal anxiety symptoms. No follow-up is warranted at this time.' },
                        { min: 5, max: 9, level: 'Mild', description: 'Mild anxiety symptoms. It is recommended to monitor symptoms and follow-up as indicated.' },
                        { min: 10, max: 14, level: 'Moderate', description: 'Moderate anxiety symptoms. Likely to be diagnosed with an anxiety or related disorder. Symptoms are clinically significant and warrant further assessment and/or referral to a mental health professional.' },
                        { min: 15, max: 21, level: 'Severe', description: 'Severe anxiety symptoms. Symptoms likely warrant active treatment. Likely to be diagnosed with an anxiety or related disorder. Further assessment and/or referral to a mental health professional is recommended.' }
                    ]
                },
                getBreakdown: (score) => {
                    for (const range of testQuestions.anxiety.scoring.ranges) {
                        if (score >= range.min && score <= range.max) {
                            return range.description;
                        }
                    }
                    return 'N/A';
                }
            },
            adhd: {
                title: 'ADHD Screening (ASRS-v1.1)',
                questions: [
                    // Part A (Highly predictive, questions 1-6)
                    'How often do you have trouble wrapping up the final details of a project, once the challenging parts have been done?', // 1
                    'How often do you have difficulty getting things in order when you have to do a task that requires organization?', // 2
                    'How often do you have problems remembering appointments or obligations?', // 3
                    'When you have a task that requires a lot of thought, how often do you avoid or delay getting started?', // 4
                    'How often do you fidget or squirm with your hands or feet when you have to sit down for a long time?', // 5
                    'How often do you feel overly active and compelled to do things, like you were driven by a motor?', // 6
                    // Part B (Additional symptoms, questions 7-18)
                    'How often do you make careless mistakes when you have to work on a boring or difficult project?', // 7
                    'How often do you have difficulty keeping your attention when you are doing boring or repetitive work?', // 8
                    'How often do you have difficulty concentrating on what people say to you, even when they are speaking to you directly?', // 9
                    'How often do you misplace or have difficulty finding things at home or at work?', // 10
                    'How often are you distracted by activity or noise around you?', // 11
                    'How often do you leave your seat in meetings or other situations in which you are expected to remain seated?', // 12
                    'How often do you feel restless or fidgety?', // 13
                    'How often do you have difficulty unwinding and relaxing when you have time to yourself?', // 14
                    'How often do you find yourself talking too much when you are in social situations?', // 15
                    'When you\'re in a conversation, how often do you find yourself finishing the sentences of the people you are talking to, before they can finish them themselves?', // 16
                    'How often do you have difficulty waiting your turn in situations when turn taking is required?', // 17
                    'How often do you interrupt others when they are busy?' // 18
                ],
                options: [
                    { text: 'Never', value: 0 },
                    { text: 'Rarely', value: 1 },
                    { text: 'Sometimes', value: 2 },
                    { text: 'Often', value: 3 },
                    { text: 'Very Often', value: 4 }
                ],
                // ASRS specific scoring logic
                scoring: {
                    // This is not a simple total score range, but a specific rule for Part A
                    // And then general total score ranges for severity.
                    partA_questions_indices: [0, 1, 2, 3, 4, 5], // Indices of questions in Part A (first 6)
                    partA_high_risk_threshold_count: 4, // 4 or more answers in 'Often' or 'Very Often' in Part A
                    partA_high_risk_values: [3, 4], // Values for 'Often' and 'Very Often'

                    total_score_ranges: [
                        { min: 0, max: 30, level: 'Low Likelihood', description: 'Your responses suggest a low likelihood of ADHD symptoms. If concerns persist, consider consulting a healthcare professional.' },
                        { min: 31, max: 39, level: 'Mild to Moderate Likelihood', description: 'Your responses suggest a mild to moderate likelihood of ADHD symptoms. Further assessment by a healthcare professional is recommended for a definitive diagnosis.' },
                        { min: 40, max: 49, level: 'High Likelihood', description: 'Your responses suggest a high likelihood of ADHD symptoms. It is strongly recommended to seek further evaluation from a mental health specialist.' },
                        { min: 50, max: 72, level: 'Very High Likelihood', description: 'Your responses suggest a very high likelihood of ADHD symptoms, consistent with a clinical diagnosis. Immediate consultation with a mental health specialist is highly recommended for comprehensive assessment and support.' }
                    ]
                },
                getBreakdown: (score, answersArray) => {
                    let partA_high_risk_count = 0;
                    testQuestions.adhd.scoring.partA_questions_indices.forEach(index => {
                        const answerValue = answersArray[index].score; // Score of the selected option for this question
                        if (testQuestions.adhd.scoring.partA_high_risk_values.includes(answerValue)) {
                            partA_high_risk_count++;
                        }
                    });

                    let initialScreeningResult = '';
                    if (partA_high_risk_count >= testQuestions.adhd.scoring.partA_high_risk_threshold_count) {
                        initialScreeningResult = 'Symptoms highly consistent with ADHD in adults based on Part A. Further investigation is warranted. ';
                    } else {
                        initialScreeningResult = 'Part A results do not strongly indicate ADHD on their own. ';
                    }

                    let totalScoreEvaluation = '';
                    for (const range of testQuestions.adhd.scoring.total_score_ranges) {
                        if (score >= range.min && score <= range.max) {
                            totalScoreEvaluation = range.description;
                            break;
                        }
                    }

                    return `${initialScreeningResult} Overall, based on your total score: ${totalScoreEvaluation}`;
                }
            }
        };

        // --- Helper Functions for UI and Messages ---
        function showMessage(message, isError = false) {
            const messageType = isError ? 'Error' : 'Info';
            const modalHtml = `
                <div id="messageModal" class="modal">
                    <div class="modal-content">
                        <span class="close-button" id="messageModalCloseBtn">&times;</span>
                        <h3>${messageType}</h3>
                        <p>${message}</p>
                        <button class="btn" id="messageModalOkBtn" style="margin-top: 20px; width: 100%;">OK</button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            const modal = document.getElementById('messageModal');
            const closeBtn = document.getElementById('messageModalCloseBtn');
            const okBtn = document.getElementById('messageModalOkBtn');

            const cleanup = () => {
                modal.remove();
            };

            closeBtn.onclick = cleanup;
            okBtn.onclick = cleanup;
            modal.onclick = (event) => {
                if (event.target === modal) {
                    cleanup();
                }
            };
        }

        function showConfirmationModal(message, onConfirm, onCancel) {
            const modalHtml = `
                <div id="customConfirmModal" class="modal">
                    <div class="modal-content">
                        <span class="close-button" id="customConfirmCloseBtn">&times;</span>
                        <h3>Confirmation</h3>
                        <p>${message}</p>
                        <div style="display: flex; justify-content: space-around; margin-top: 20px;">
                            <button class="btn" id="customConfirmYesBtn" style="width: 45%; background: #27ae60;">Yes</button>
                            <button class="btn btn-secondary" id="customConfirmNoBtn" style="width: 45%;">No</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            const modal = document.getElementById('customConfirmModal');
            const closeBtn = document.getElementById('customConfirmCloseBtn');
            const yesBtn = document.getElementById('customConfirmYesBtn');
            const noBtn = document.getElementById('customConfirmNoBtn');

            const cleanup = () => {
                modal.remove();
            };

            closeBtn.onclick = () => {
                cleanup();
                if (onCancel) onCancel();
            };
            yesBtn.onclick = () => {
                cleanup();
                if (onConfirm) onConfirm();
            };
            noBtn.onclick = () => {
                cleanup();
                if (onCancel) onCancel();
            };

            modal.onclick = (event) => {
                if (event.target === modal) {
                    cleanup();
                    if (onCancel) onCancel();
                }
            };
        }

        function hideAllScreens() {
            document.getElementById('welcomeScreenWrapper').classList.add('hidden');
            document.getElementById('patientDashboard').classList.add('hidden');
            document.getElementById('adminDashboard').classList.add('hidden');
            document.getElementById('bookAppointmentSection').classList.add('hidden');
            document.getElementById('publicMentalHealthTestsSection').classList.add('hidden');
            document.getElementById('tmsQuestionnaireSection').classList.add('hidden');
            document.getElementById('testInterface').classList.add('hidden');
        }

        // --- Authentication Functions (Firebase Integrated) ---

        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showMessage('Please enter both email and password', true);
                return;
            }

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                currentUser = userCredential.user;
                isAdmin = false;
                console.log("Patient login successful for UID:", currentUser.uid);
                showMessage('Patient login successful!');
                showPatientDashboard();
            }
            catch (error) {
                console.error("Login failed:", error);
                showMessage(`Login failed: ${error.message}`, true);
            }
        }

        async function adminLogin() {
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;

            if (!email || !password) {
                showMessage('Please enter both email and password for admin login', true);
                return;
            }

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                currentUser = userCredential.user;
                
                if (email === ADMIN_EMAIL) {
                    sessionStorage.setItem('isAdminLoggedIn', 'true');
                    isAdmin = true;
                    console.log("Admin login successful via Firebase Auth. UID:", currentUser.uid);
                    showMessage('Admin login successful!');
                    showAdminDashboard();
                } else {
                    console.error("Admin: A Firebase user logged in, but not the designated admin email.");
                    showMessage('Admin login failed: Invalid admin credentials.', true);
                    await signOut(auth);
                    sessionStorage.removeItem('isAdminLoggedIn');
                    isAdmin = false;
                }

            } catch (error) {
                console.error("Admin login failed:", error);
                showMessage(`Admin login failed: ${error.message}`, true);
                sessionStorage.removeItem('isAdminLoggedIn');
                isAdmin = false;
            }
        }

        async function signup() {
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const dob = document.getElementById('signupDob').value;
            const phone = document.getElementById('signupPhone').value;
            const gender = document.getElementById('signupGender').value;

            if (!name || !email || !password || !dob || !phone || !gender) {
                showMessage('Please fill in all fields', true);
                return;
            }
            if (password.length < 6) {
                showMessage('Password must be at least 6 characters long.', true);
                return;
            }

            try {
                console.log("Attempting to create user with email:", email);
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const userId = userCredential.user.uid;
                console.log("User created in Firebase Auth with UID:", userId);

                await set(ref(database, 'patients/' + userId), {
                    fullName: name,
                    email: email,
                    phoneNumber: phone,
                    dob: dob,
                    gender: gender,
                    createdAt: new Date().toISOString()
                });
                console.log("Patient data saved to Realtime Database for UID:", userId);

                showMessage('Account created successfully! Please login.');
                showLoginScreenLayout();
                showLogin();
            } catch (error) {
                console.error("Firebase Auth Error during signup:", error);
                showMessage(`Error creating account: ${error.message}`, true);
            }
        }

        async function logout() {
            try {
                await signOut(auth);
                console.log("Firebase Auth user signed out.");
            } catch (error) {
                console.error("Firebase Auth signOut failed:", error);
            }
            sessionStorage.removeItem('isAdminLoggedIn');
            isAdmin = false;
            currentUser = null;
            console.log("Local state cleared. User logged out.");
            showMessage('Logged out successfully.');
            showLoginScreenLayout();
            showLogin();
        }

        // --- UI Navigation Functions ---

        function showLoginScreenLayout() {
            document.getElementById('welcomeScreenWrapper').classList.remove('hidden');
            document.getElementById('patientDashboard').classList.add('hidden');
            document.getElementById('adminDashboard').classList.add('hidden');
            document.getElementById('bookAppointmentSection').classList.add('hidden');
            document.getElementById('publicMentalHealthTestsSection').classList.add('hidden');
            document.getElementById('tmsQuestionnaireSection').classList.add('hidden');
            document.getElementById('testInterface').classList.add('hidden');
        }

        function showLogin() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('signupScreen').classList.add('hidden');
            document.getElementById('adminLoginScreen').classList.add('hidden');
        }

        function showSignup() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('signupScreen').classList.remove('hidden');
            document.getElementById('adminLoginScreen').classList.add('hidden');
        }

        function showAdminLogin() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('signupScreen').classList.add('hidden');
            document.getElementById('adminLoginScreen').classList.remove('hidden');
            document.getElementById('adminEmail').value = '';
            document.getElementById('adminPassword').value = '';
        }

        function showPatientDashboard() {
            hideAllScreens();
            document.getElementById('patientDashboard').classList.remove('hidden');
            showPatientSection('appointments');
            loadAppointments();
            loadTestResults();
            loadProfile();
        }

        function showAdminDashboard() {
            hideAllScreens();
            document.getElementById('adminDashboard').classList.remove('hidden');
            showAdminSection('appointments');
            loadPatientsList();
        }

        function showPatientSection(sectionId) {
            document.querySelectorAll('#patientDashboard .section').forEach(s => s.classList.add('hidden'));
            document.getElementById('testInterface').classList.add('hidden');
            document.getElementById('tmsQuestionnaireSection').classList.add('hidden');

            document.querySelectorAll('#patientSidebarNav li').forEach(li => li.classList.remove('active'));
            const targetListItem = document.querySelector(`#patientSidebarNav li[data-section="${sectionId}"]`);
            if (targetListItem) {
                targetListItem.classList.add('active');
            }

            document.getElementById(`${sectionId}Section`).classList.remove('hidden');
        }

        function showAdminSection(sectionId) {
            document.querySelectorAll('#adminDashboard .section').forEach(s => s.classList.add('hidden'));
            document.getElementById('patientDetailView').classList.add('hidden');
            document.getElementById('addPatientForm').classList.add('hidden');

            document.querySelectorAll('#adminSidebarNav li').forEach(li => li.classList.remove('active'));
            const targetListItem = document.querySelector(`#adminSidebarNav li[data-section="${sectionId}"]`);
            if (targetListItem) {
                targetListItem.classList.add('active');
            }

            const targetSectionId = `admin${sectionId.charAt(0).toUpperCase() + sectionId.slice(1)}Section`;
            const targetSectionElement = document.getElementById(targetSectionId);
            
            if (targetSectionElement) {
                targetSectionElement.classList.remove('hidden');
            } else {
                console.error(`Admin: Could not find section with ID: ${targetSectionId}`);
            }

            if (sectionId === 'calendar') {
                loadAdminCalendar();
            } else if (sectionId === 'appointments') {
                loadAdminAppointments();
                document.getElementById('adminAppointmentsTitle').textContent = "Appointment Requests";
            } else if (sectionId === 'patients') {
                loadPatientsList();
            } else if (sectionId === 'tmsSubmissions') {
                loadAdminTmsSubmissions();
            } else if (sectionId === 'publicTestResults') {
                loadAdminPublicTestResults();
            }
        }

        // --- Patient-Specific Functionality ---

        function loadProfile() {
            if (!currentUser) return;
            const profileInfoDiv = document.getElementById('profileInfo');
            console.log("Patient: Loading profile for UID:", currentUser.uid);
            onValue(ref(database, 'patients/' + currentUser.uid), (snapshot) => {
                const patientData = snapshot.val();
                if (patientData) {
                    profileInfoDiv.innerHTML = `
                        <p><strong>Name:</strong> ${patientData.fullName}</p>
                        <p><strong>Email:</strong> ${patientData.email}</p>
                        <p><strong>Phone:</strong> ${patientData.phoneNumber}</p>
                        <p><strong>Date of Birth:</strong> ${patientData.dob || 'N/A'}</p>
                        <p><strong>Gender:</strong> ${patientData.gender}</p>
                        <p><strong>Account Created:</strong> ${new Date(patientData.createdAt).toLocaleString()}</p>
                    `;
                    console.log("Patient: Profile data loaded:", patientData.fullName);
                } else {
                    profileInfoDiv.innerHTML = '<p>No profile data found.</p>';
                    console.log("Patient: No profile data found for UID:", currentUser.uid);
                }
            }, {
                onlyOnce: false
            });
        }
        
        function showPublicBookingForm() {
            hideAllScreens();
            document.getElementById('bookAppointmentSection').classList.remove('hidden');
            // Clear form
            document.getElementById('publicApptFullName').value = '';
            document.getElementById('publicApptEmail').value = '';
            document.getElementById('publicApptPhone').value = '';
            document.getElementById('publicApptDob').value = '';
            document.getElementById('publicApptInsurance').value = '';
            document.getElementById('publicApptReason').value = '';
        }

        async function submitPublicAppointment() {
            const fullName = document.getElementById('publicApptFullName').value;
            const email = document.getElementById('publicApptEmail').value;
            const phone = document.getElementById('publicApptPhone').value;
            const dob = document.getElementById('publicApptDob').value;
            const insurance = document.getElementById('publicApptInsurance').value;
            const reason = document.getElementById('publicApptReason').value;

            if (!fullName || !email || !phone || !dob || !insurance || !reason) {
                showMessage('Please fill in all appointment details.', true);
                return;
            }

            try {
                const newAppointmentRef = push(ref(database, 'appointments'));
                await set(newAppointmentRef, {
                    userId: 'public', // Mark as public
                    fullName: fullName,
                    email: email,
                    phoneNumber: phone,
                    dob: dob,
                    insuranceProvider: insurance,
                    reason: reason,
                    status: 'pending',
                    createdAt: new Date().toISOString()
                });
                
                showConfirmationModal(
                    "Thank you. Your appointment request has been submitted. Please wait 24 hours for HealMed Clinic to email or call you back with details. You can also call HealMed Clinic at (732) 508-2136 to speak to the front desk.",
                    () => showLoginScreenLayout() // On OK/Confirm
                );
                showLoginScreenLayout();

            } catch (error) {
                showMessage(`Error booking appointment: ${error.message}`, true);
            }
        }

        function showBookingForm() {
            document.getElementById('bookingForm').classList.remove('hidden');
            document.getElementById('insuranceProvider').value = '';
            document.getElementById('appointmentReason').value = '';
            console.log("Patient: Showing booking form.");
        }

        function hideBookingForm() {
            document.getElementById('bookingForm').classList.add('hidden');
            document.getElementById('insuranceProvider').value = '';
            document.getElementById('appointmentReason').value = '';
            console.log("Patient: Hiding booking form.");
        }

        async function bookAppointment() {
            const insurance = document.getElementById('insuranceProvider').value;
            const reason = document.getElementById('appointmentReason').value;

            if (!insurance || !reason) {
                showMessage('Please provide your insurance provider and reason for visit.', true);
                return;
            }
            if (!currentUser) {
                showMessage('You must be logged in to book an appointment.', true);
                return;
            }

            try {
                const patientSnapshot = await get(ref(database, 'patients/' + currentUser.uid));
                const patientData = patientSnapshot.val();

                if (!patientData) {
                    showMessage('Could not retrieve patient data. Please try logging in again.', true);
                    return;
                }

                const newAppointmentRef = push(ref(database, 'appointments'));
                await set(newAppointmentRef, {
                    userId: currentUser.uid,
                    fullName: patientData.fullName,
                    email: patientData.email,
                    phoneNumber: patientData.phoneNumber,
                    dob: patientData.dob,
                    insuranceProvider: insurance,
                    reason: reason,
                    status: 'pending',
                    createdAt: new Date().toISOString()
                });
                
                showConfirmationModal(
                    "Thank you. Your appointment request has been submitted. Please wait 24 hours for HealMed Clinic to email or call you back with details. You can also call HealMed Clinic at (732) 508-2136 to speak to the front desk.",
                    () => hideBookingForm() // On OK/Confirm
                );
                hideBookingForm();

            } catch (error) {
                showMessage(`Error booking appointment: ${error.message}`, true);
            }
        }

        function loadAppointments() {
            const appointmentsListDiv = document.getElementById('appointmentsList');
            if (!currentUser) {
                appointmentsListDiv.innerHTML = '<p>Please log in to view your appointments.</p>';
                return;
            }
            onValue(ref(database, 'appointments'), (snapshot) => {
                appointmentsListDiv.innerHTML = '';
                let hasAppointments = false;
                snapshot.forEach((childSnapshot) => {
                    const appt = childSnapshot.val();
                    const apptId = childSnapshot.key;

                    if (appt.userId === currentUser.uid) {
                        hasAppointments = true;
                        const statusClass = `status-${appt.status}`;
                        appointmentsListDiv.innerHTML += `
                            <div class="appointment-card">
                                <h4>Appointment Request</h4>
                                <p><strong>Reason:</strong> ${appt.reason}</p>
                                <p><strong>Status:</strong> <span class="appointment-status ${statusClass}">${appt.status.toUpperCase()}</span></p>
                                <p style="font-size: 0.8em; opacity: 0.8;">Requested on: ${new Date(appt.createdAt).toLocaleString()}</p>
                            </div>
                        `;
                    }
                });
                if (!hasAppointments) {
                    appointmentsListDiv.innerHTML = '<p>No appointments found.</p>';
                }
            }, {
                onlyOnce: false
            });
        }

        function startTest(testType) {
            console.log("Patient: Starting logged-in test:", testType);
            isPublicTestMode = false;
            currentTest = testQuestions[testType];
            if (!currentTest) {
                showMessage("Selected test not found. Please try again.", true);
                return;
            }
            document.getElementById('testTitle').textContent = currentTest.title;
            document.getElementById('testQuestions').innerHTML = '';
            document.getElementById('publicTestResultDisplay').classList.add('hidden');
            document.getElementById('publicTestNameField').classList.add('hidden');
            document.getElementById('publicTestFullName').value = '';

            let questionsHtml = '';
            currentTest.questions.forEach((questionText, index) => {
                let questionPrefix = '';
                if (testType === 'depression' || testType === 'anxiety') {
                    questionPrefix = 'Over the last 2 weeks, how often have you been bothered by: ';
                }
                questionsHtml += `
                    <div class="question">
                        <h4>${index + 1}. ${questionPrefix}${questionText}?</h4>
                        <div class="radio-group">
                            ${currentTest.options.map((option, optIndex) => `
                                <label class="radio-option">
                                    <input type="radio" name="q${index}" value="${option.value}" id="q${index}_${optIndex}" required>
                                    ${option.text}
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            document.getElementById('testQuestions').innerHTML = questionsHtml;
            document.getElementById('testInterface').classList.remove('hidden');
            document.getElementById('testInterface').classList.remove('public-test-interface');
            document.getElementById('submitTestBtn').classList.remove('hidden');
            document.getElementById('cancelTestBtn').classList.remove('hidden');
            document.getElementById('submitTestBtn').onclick = submitTest;
            document.getElementById('cancelTestBtn').onclick = cancelTest;
        }

        async function submitTest() {
            let score = 0;
            const totalQuestions = currentTest.questions.length;
            const answers = [];

            for (let i = 0; i < totalQuestions; i++) {
                const selectedOption = document.querySelector(`input[name="q${i}"]:checked`);
                if (!selectedOption) {
                    showMessage(`Please answer question ${i + 1} before submitting.`, true);
                    return;
                }
                const value = parseInt(selectedOption.value);
                score += value;
                answers.push({ question: currentTest.questions[i], answer: currentTest.options.find(opt => opt.value === value).text, score: value });
            }

            const breakdown = currentTest.getBreakdown(score, answers);
            if (!currentUser) {
                showMessage('Your test results have successfully been submitted for review!', true);
                return;
            }

            try {
                const newTestResultRef = push(ref(database, 'testResults'));
                await set(newTestResultRef, {
                    userId: currentUser.uid,
                    testType: currentTest.title,
                    score: score,
                    breakdown: breakdown,
                    answers: answers,
                    createdAt: new Date().toISOString()
                });

                const patientSnapshot = await get(ref(database, 'patients/' + currentUser.uid));
                const patientData = patientSnapshot.val();

                const newPublicSubmissionRef = push(ref(database, 'publicMentalHealthTestSubmissions'));
                await set(newPublicSubmissionRef, {
                    userId: currentUser.uid,
                    fullName: patientData ? patientData.fullName : 'Logged-in User',
                    email: patientData ? patientData.email : 'N/A',
                    phoneNumber: patientData ? patientData.phoneNumber : 'N/A',
                    testType: currentTest.title,
                    score: score,
                    breakdown: breakdown,
                    answers: answers,
                    submittedAt: new Date().toISOString()
                });

                showMessage('Test submitted successfully! Your results have been saved and forwarded for review.');
                cancelTest();
                loadTestResults();
            } catch (error) {
                showMessage(`Error submitting test: ${error.message}`, true);
            }
        }

        function cancelTest() {
            currentTest = null;
            document.getElementById('testInterface').classList.add('hidden');
            document.getElementById('mentalHealthSection').classList.remove('hidden');
            document.getElementById('testQuestions').innerHTML = '';
            document.getElementById('publicTestResultDisplay').classList.add('hidden');
        }

        function loadTestResults() {
            const testResultsListDiv = document.getElementById('testResultsList');
            if (!currentUser) {
                testResultsListDiv.innerHTML = '<p>Please log in to view your test results.</p>';
                return;
            }
            onValue(ref(database, 'testResults'), (snapshot) => {
                testResultsListDiv.innerHTML = '';
                let hasResults = false;
                snapshot.forEach((childSnapshot) => {
                    const result = childSnapshot.val();
                    if (result.userId === currentUser.uid) {
                        hasResults = true;
                        testResultsListDiv.innerHTML += `
                            <div class="test-result-item">
                                <h4>${result.testType}</h4>
                                <p><strong>Score:</strong> ${result.score}</p>
                                <p><strong>Breakdown:</strong> ${result.breakdown}</p>
                                <p style="font-size: 0.8em; opacity: 0.8;">Taken on: ${new Date(result.createdAt).toLocaleString()}</p>
                            </div>
                        `;
                    }
                });
                if (!hasResults) {
                    testResultsListDiv.innerHTML = '<p>No test results found. Take a test to see your results here.</p>';
                }
            }, {
                onlyOnce: false
            });
        }


        // --- Public Mental Health Test Functions ---

        function showPublicMentalHealthTestSelection() {
            hideAllScreens();
            document.getElementById('publicMentalHealthTestsSection').classList.remove('hidden');
        }

        function startPublicTest(testType) {
            hideAllScreens();
            
            isPublicTestMode = true;
            currentTest = testQuestions[testType];
            if (!currentTest) {
                showMessage("Selected test not found. Please try again.", true);
                return;
            }

            const testQuestionsDiv = document.getElementById('testQuestions');
            testQuestionsDiv.innerHTML = '';
            document.getElementById('publicTestResultDisplay').classList.add('hidden');
            document.getElementById('testTitle').textContent = currentTest.title;

            document.getElementById('publicTestNameField').classList.remove('hidden');
            document.getElementById('publicTestFullName').value = '';
            document.getElementById('submitTestBtn').classList.remove('hidden');
            document.getElementById('cancelTestBtn').classList.remove('hidden');

            let questionsHtml = '';
            currentTest.questions.forEach((questionText, index) => {
                let questionPrefix = '';
                if (testType === 'depression' || testType === 'anxiety') {
                    questionPrefix = 'Over the last 2 weeks, how often have you been bothered by: ';
                }
                questionsHtml += `
                    <div class="question">
                        <h4>${index + 1}. ${questionPrefix}${questionText}?</h4>
                        <div class="radio-group">
                            ${currentTest.options.map((option, optIndex) => `
                                <label class="radio-option">
                                    <input type="radio" name="q${index}" value="${option.value}" id="q${index}_${optIndex}" required>
                                    ${option.text}
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            document.getElementById('testQuestions').innerHTML = questionsHtml;

            document.getElementById('testInterface').classList.remove('hidden');
            document.getElementById('testInterface').classList.add('public-test-interface');
            
            document.getElementById('submitTestBtn').onclick = submitPublicTest;
            document.getElementById('cancelTestBtn').onclick = cancelPublicTest;
        }

     async function submitPublicTest() {
        const publicFullName = document.getElementById('publicTestFullName').value.trim();
        if (!publicFullName) {
            showMessage('Please enter your full name before submitting the test.', true);
            return;
        }

        let score = 0;
        const totalQuestions = currentTest.questions.length;
        const answers = [];

        for (let i = 0; i < totalQuestions; i++) {
            const selectedOption = document.querySelector(`input[name="q${i}"]:checked`);
            if (!selectedOption) {
                showMessage(`Please answer question ${i + 1} before submitting.`, true);
                return;
            }
            const value = parseInt(selectedOption.value);
            score += value;
            answers.push({ question: currentTest.questions[i], answer: currentTest.options.find(opt => opt.value === value).text, score: value });
        }

        const breakdown = currentTest.getBreakdown(score, answers);

        try {
            const newPublicTestResultRef = push(ref(database, 'publicMentalHealthTestSubmissions'));
            await set(newPublicTestResultRef, {
                fullName: publicFullName,
                testType: currentTest.title,
                score: score,
                breakdown: breakdown,
                answers: answers,
                submittedAt: new Date().toISOString()
            });
        } catch (error) {
            showMessage(`Error submitting test: ${error.message}`, true);
        }

        const resultDisplayDiv = document.getElementById('publicTestResultDisplay');
        resultDisplayDiv.innerHTML = `
            <h3>Your Test Results for ${currentTest.title}</h3>
            <p><strong>Score:</strong> ${score}</p>
            <p><strong>Result:</strong> ${breakdown}</p>
            <p style="margin-top: 15px; font-size: 0.9em;">These results have been recorded for staff review. For a professional evaluation or to track your progress, please create an account.</p>
            <button class="btn" id="publicTestBackToSelectionBtn">Back to Test Selection</button>
            <button class="btn btn-primary" id="publicTestReturnToPortalBtn">Return to Patient Portal</button> 
        `;
        resultDisplayDiv.classList.remove('hidden');
        document.getElementById('testQuestions').innerHTML = '';
        document.getElementById('publicTestNameField').classList.add('hidden');
        document.getElementById('submitTestBtn').classList.add('hidden');
        document.getElementById('cancelTestBtn').classList.add('hidden');

        document.getElementById('publicTestBackToSelectionBtn').onclick = () => {
            resultDisplayDiv.classList.add('hidden');
            document.getElementById('testInterface').classList.add('hidden');
            document.getElementById('submitTestBtn').classList.remove('hidden');
            document.getElementById('cancelTestBtn').classList.remove('hidden');
            showPublicMentalHealthTestSelection();
        };

        document.getElementById('publicTestReturnToPortalBtn').onclick = () => {
            window.location.href = 'https://healmedclinic.github.io/patient-portal/';
        };
    }

    function cancelPublicTest() {
        currentTest = null;
        document.getElementById('testInterface').classList.add('hidden');
        document.getElementById('testInterface').classList.remove('public-test-interface');
        document.getElementById('testQuestions').innerHTML = '';
        document.getElementById('publicTestNameField').classList.add('hidden');
        document.getElementById('publicTestFullName').value = '';
        document.getElementById('publicTestResultDisplay').classList.add('hidden');
        showPublicMentalHealthTestSelection();
    }


        // --- TMS Daily Questionnaire Functions (Patient Side / Public Access) ---

        function showTmsQuestionnaire(isLoggedInCall = false) {
            document.getElementById('tmsFullName').value = '';
            document.getElementById('tmsEmail').value = '';
            document.getElementById('tmsPhone').value = '';

            if (isLoggedInCall && currentUser) {
                get(ref(database, 'patients/' + currentUser.uid)).then(snapshot => {
                    const patientData = snapshot.val();
                    if (patientData) {
                        document.getElementById('tmsFullName').value = patientData.fullName || '';
                        document.getElementById('tmsEmail').value = patientData.email || '';
                        document.getElementById('tmsPhone').value = patientData.phoneNumber || '';
                    }
                }).catch(error => console.error("Error pre-filling TMS form:", error));
            }

            hideAllScreens();
            document.getElementById('tmsQuestionnaireSection').classList.remove('hidden');
            resetTmsForm();
        }

        function cancelTmsQuestionnaire() {
            document.getElementById('tmsQuestionnaireSection').classList.add('hidden');
            
            if (currentUser) {
                showPatientSection('forms');
            } else {
                showLoginScreenLayout();
                showLogin();
            }
            resetTmsForm();
        }

        function resetTmsForm() {
            document.getElementById('tmsQuestionnaireSection').querySelectorAll('input[type="radio"]').forEach(radio => radio.checked = false);
            document.getElementById('tmsQuestionnaireSection').querySelectorAll('textarea').forEach(textarea => textarea.value = '');
            document.getElementById('tmsQuestionnaireSection').querySelectorAll('input[type="text"]').forEach(input => input.value = '');
            document.getElementById('tmsQuestionnaireSection').querySelectorAll('.follow-up-question').forEach(div => div.classList.add('hidden'));
        }

        function setupTmsFormListeners() {
            document.querySelectorAll('input[name="q1_eat_drink"]').forEach(radio => {
                radio.addEventListener('change', (event) => {
                    if (event.target.value === 'yes') {
                        document.getElementById('q1_followup').classList.remove('hidden');
                    } else {
                        document.getElementById('q1_followup').classList.add('hidden');
                        document.getElementById('q1_eat_drink_details').value = '';
                    }
                });
            });

            document.querySelectorAll('input[name="q2_med_prescribed"]').forEach(radio => {
                radio.addEventListener('change', (event) => {
                    if (event.target.value === 'no') {
                        document.getElementById('q2_followup').classList.remove('hidden');
                    } else {
                        document.getElementById('q2_followup').classList.add('hidden');
                        document.querySelectorAll('input[name="q2a_med_changes"]').forEach(r => r.checked = false);
                        document.getElementById('q2a_followup').classList.add('hidden');
                        document.getElementById('q2a_med_changes_details').value = '';
                    }
                });
            });

            document.querySelectorAll('input[name="q2a_med_changes"]').forEach(radio => {
                radio.addEventListener('change', (event) => {
                    if (event.target.value === 'yes') {
                        document.getElementById('q2a_followup').classList.remove('hidden');
                    } else {
                        document.getElementById('q2a_followup').classList.add('hidden');
                        document.getElementById('q2a_med_changes_details').value = '';
                    }
                });
            });

            document.querySelectorAll('input[name="q4_caffeine"]').forEach(radio => {
                radio.addEventListener('change', (event) => {
                    if (event.target.value === 'yes') {
                        document.getElementById('q4_followup').classList.remove('hidden');
                    } else {
                        document.getElementById('q4_followup').classList.add('hidden');
                        document.getElementById('q4_caffeine_details').value = '';
                    }
                });
            });

            document.querySelectorAll('input[name="q5_alcohol"]').forEach(radio => {
                radio.addEventListener('change', (event) => {
                    if (event.target.value === 'yes') {
                        document.getElementById('q5_followup').classList.remove('hidden');
                    } else {
                        document.getElementById('q5_followup').classList.add('hidden');
                        document.getElementById('q5_alcohol_details').value = '';
                    }
                });
            });

            document.querySelectorAll('input[name="q6_metal_head"]').forEach(radio => {
                radio.addEventListener('change', (event) => {
                    if (event.target.value === 'yes') {
                        document.getElementById('q6_followup').classList.remove('hidden');
                    } else {
                        document.getElementById('q6_followup').classList.add('hidden');
                        document.getElementById('q6_metal_head_details').value = '';
                    }
                });
            });
        }

        async function submitTmsQuestionnaire() {
            const tmsFullName = document.getElementById('tmsFullName').value.trim();
            const tmsEmail = document.getElementById('tmsEmail').value.trim();
            const tmsPhone = document.getElementById('tmsPhone').value.trim();

            if (!tmsFullName || !tmsEmail || !tmsPhone) {
                showMessage('Please provide your Full Name, Email, and Phone Number at the top of the questionnaire.', true);
                return;
            }

            const answers = {};
            let allRequiredAnswered = true;

            const q1Answer = document.querySelector('input[name="q1_eat_drink"]:checked');
            if (!q1Answer) { allRequiredAnswered = false; } else {
                answers.q1_eat_drink = q1Answer.value;
                if (q1Answer.value === 'yes') {
                    const details = document.getElementById('q1_eat_drink_details').value.trim();
                    if (!details) { showMessage("Please provide details for Q1.", true); return; }
                    answers.q1_eat_drink_details = details;
                }
            }

            const q2Answer = document.querySelector('input[name="q2_med_prescribed"]:checked');
            if (!q2Answer) { allRequiredAnswered = false; } else {
                answers.q2_med_prescribed = q2Answer.value;
                if (q2Answer.value === 'no') {
                    const q2aAnswer = document.querySelector('input[name="q2a_med_changes"]:checked');
                    if (!q2aAnswer) { showMessage("Please answer Q2a.", true); return; }
                    answers.q2a_med_changes = q2aAnswer.value;
                    if (q2aAnswer.value === 'yes') {
                        const details = document.getElementById('q2a_med_changes_details').value.trim();
                        if (!details) { showMessage("Please provide details for Q2a.", true); return; }
                        answers.q2a_med_changes_details = details;
                    }
                }
            }

            const q3Answer = document.getElementById('q3_sleep_hours').value;
            if (q3Answer === '' || isNaN(q3Answer)) { showMessage("Please enter sleep hours for Q3.", true); return; }
            answers.q3_sleep_hours = parseFloat(q3Answer);

            const q4Answer = document.querySelector('input[name="q4_caffeine"]:checked');
            if (!q4Answer) { allRequiredAnswered = false; } else {
                answers.q4_caffeine = q4Answer.value;
                if (q4Answer.value === 'yes') {
                    const details = document.getElementById('q4_caffeine_details').value.trim();
                    if (!details) { showMessage("Please provide details for Q4.", true); return; }
                    answers.q4_caffeine_details = details;
                }
            }

            const q5Answer = document.querySelector('input[name="q5_alcohol"]:checked');
            if (!q5Answer) { allRequiredAnswered = false; } else {
                answers.q5_alcohol = q5Answer.value;
                if (q5Answer.value === 'yes') {
                    const details = document.getElementById('q5_alcohol_details').value.trim();
                    if (!details) { showMessage("Please provide details for Q5.", true); return; }
                    answers.q5_alcohol_details = details;
                }
            }

            const qUnprescribedSubstanceAnswer = document.querySelector('input[name="q_unprescribed_substance"]:checked');
            if (!qUnprescribedSubstanceAnswer) { allRequiredAnswered = false; } else {
                answers.q_unprescribed_substance = qUnprescribedSubstanceAnswer.value;
            }

            const q6Answer = document.querySelector('input[name="q6_metal_head"]:checked');
            if (!q6Answer) { allRequiredAnswered = false; } else {
                answers.q6_metal_head = q6Answer.value;
                if (q6Answer.value === 'yes') {
                    const details = document.getElementById('q6_metal_head_details').value.trim();
                    if (!details) { showMessage("Please provide details for Q6.", true); return; }
                    answers.q6_metal_head_details = details;
                }
            }
            
            if (!allRequiredAnswered) {
                showMessage("Please answer all required questions before submitting.", true);
                return;
            }

            try {
                let tmsRefPath;
                let tmsData = {
                    fullName: tmsFullName,
                    email: tmsEmail,
                    phoneNumber: tmsPhone,
                    answers: answers,
                    submittedAt: new Date().toISOString()
                };

                if (currentUser) {
                    tmsRefPath = `tmsQuestionnaires/${currentUser.uid}`;
                    tmsData.userId = currentUser.uid;
                } else {
                    tmsRefPath = `publicTmsQuestionnaires`;
                }

                const newTmsRef = push(ref(database, tmsRefPath));
                await set(newTmsRef, tmsData);
                
                showMessage('TMS Daily Questionnaire submitted successfully!');
                cancelTmsQuestionnaire();
            } catch (error) {
                showMessage(`Error submitting TMS Questionnaire: ${error.message}`, true);
            }
        }


        // --- Admin-Specific Functionality ---

        function loadAdminAppointments() {
            const adminPendingAppointmentsListDiv = document.getElementById('adminPendingAppointmentsList');
            if (!currentUser || !isAdmin) {
                adminPendingAppointmentsListDiv.innerHTML = '<p>Unauthorized access. Please log in as Admin.</p>';
                return;
            }
            onValue(ref(database, 'appointments'), (snapshot) => {
                adminPendingAppointmentsListDiv.innerHTML = '';
                let hasPendingAppointments = false;
                const rawSnapshotData = snapshot.val();

                if (rawSnapshotData) {
                    const appointmentsArray = Object.keys(rawSnapshotData).map(key => ({ id: key, ...rawSnapshotData[key] }));
                    const pendingAppointments = appointmentsArray.filter(appt => appt.status && appt.status.trim() === 'pending');
                    pendingAppointments.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                    pendingAppointments.forEach((appt) => {
                        hasPendingAppointments = true;
                        const statusClass = `status-${appt.status}`;
                        adminPendingAppointmentsListDiv.innerHTML += `
                            <div class="appointment-card admin-card">
                                <h4>Appointment Request from ${appt.fullName}</h4>
                                <p><strong>Email:</strong> ${appt.email}</p>
                                <p><strong>Phone:</strong> ${appt.phoneNumber}</p>
                                <p><strong>Insurance:</strong> ${appt.insuranceProvider || 'N/A'}</p>
                                <p><strong>Date of Birth:</strong> ${appt.dob || 'N/A'}</p>
                                <p><strong>Reason:</strong> ${appt.reason}</p>
                                <p><strong>Status:</strong> <span class="appointment-status ${statusClass}">${appt.status.toUpperCase()}</span></p>
                                <p style="font-size: 0.8em; opacity: 0.8;">Requested on: ${new Date(appt.createdAt).toLocaleString()}</p>
                                <div class="action-buttons">
                                    <button class="btn-approve" data-id="${appt.id}">Approve</button>
                                    <button class="btn-deny" data-id="${appt.id}">Deny</button>
                                </div>
                            </div>
                        `;
                    });
                }
                if (!hasPendingAppointments) {
                    adminPendingAppointmentsListDiv.innerHTML = '<p>No pending appointment requests found.</p>';
                }
                document.querySelectorAll('#adminPendingAppointmentsList .btn-approve').forEach(button => {
                    button.onclick = (e) => approveAppointment(e.target.dataset.id);
                });
                document.querySelectorAll('#adminPendingAppointmentsList .btn-deny').forEach(button => {
                    button.onclick = (e) => denyAppointment(e.target.dataset.id);
                });
            }, {
                onlyOnce: false
            });
        }

        async function approveAppointment(apptId) {
            if (!currentUser || !isAdmin) {
                showMessage('Unauthorized action.', true);
                return;
            }
            try {
                await update(ref(database, 'appointments/' + apptId), { status: 'approved' });
                showMessage('Appointment approved successfully!');
                if (adminCalendarInstance) {
                    adminCalendarInstance.refetchEvents();
                }
            } catch (error) {
                showMessage(`Error approving appointment: ${error.message}`, true);
            }
        }

        async function denyAppointment(apptId) {
            if (!currentUser || !isAdmin) {
                showMessage('Unauthorized action.', true);
                return;
            }
            try {
                await update(ref(database, 'appointments/' + apptId), { status: 'denied' });
                showMessage('Appointment denied.');
                if (adminCalendarInstance) {
                    adminCalendarInstance.refetchEvents();
                }
            } catch (error) {
                showMessage(`Error denying appointment: ${error.message}`, true);
            }
        }

        function showAddPatientForm() {
            if (!currentUser || !isAdmin) {
                showMessage('Unauthorized access.', true);
                return;
            }
            document.getElementById('addPatientForm').classList.remove('hidden');
            document.getElementById('patientsList').classList.add('hidden');
            document.getElementById('patientDetailView').classList.add('hidden');
            document.getElementById('newPatientName').value = '';
            document.getElementById('newPatientEmail').value = '';
            document.getElementById('newPatientPassword').value = '';
            document.getElementById('newPatientDob').value = '';
            document.getElementById('newPatientPhone').value = '';
            document.getElementById('newPatientGender').value = '';
        }

        function hideAddPatientForm() {
            document.getElementById('addPatientForm').classList.add('hidden');
            document.getElementById('patientsList').classList.remove('hidden');
        }

        async function addPatient() {
            if (!currentUser || !isAdmin) {
                showMessage('Unauthorized action.', true);
                return;
            }
            const name = document.getElementById('newPatientName').value;
            const email = document.getElementById('newPatientEmail').value;
            const password = document.getElementById('newPatientPassword').value;
            const dob = document.getElementById('newPatientDob').value;
            const phone = document.getElementById('newPatientPhone').value;
            const gender = document.getElementById('newPatientGender').value;

            if (!name || !email || !password || !dob || !phone || !gender) {
                showMessage('Please fill in all fields for the new patient', true);
                return;
            }
            if (password.length < 6) {
                showMessage('Password for the new patient must be at least 6 characters long.', true);
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const userId = userCredential.user.uid;

                await set(ref(database, 'patients/' + userId), {
                    fullName: name,
                    email: email,
                    phoneNumber: phone,
                    dob: dob,
                    gender: gender,
                    createdAt: new Date().toISOString()
                });
                showMessage(`Patient ${name} added successfully! Temporary password: ${password}`);
                hideAddPatientForm();
                loadPatientsList();
            } catch (error) {
                showMessage(`Error adding patient: ${error.message}`, true);
            }
        }

        async function deletePatient(patientId) {
            if (!currentUser || !isAdmin) {
                showMessage('Unauthorized action.', true);
                return;
            }

            showConfirmationModal(
                `Are you sure you want to permanently delete this patient (UID: ${patientId}) and ALL their associated data? This action cannot be undone.`,
                async () => {
                    try {
                        await remove(ref(database, 'patients/' + patientId));
                        
                        const testResultsSnapshot = await get(ref(database, 'testResults'));
                        if (testResultsSnapshot.exists()) {
                            testResultsSnapshot.forEach(child => {
                                if (child.val().userId === patientId) {
                                    remove(ref(database, `testResults/${child.key}`));
                                }
                            });
                        }

                        await remove(ref(database, `tmsQuestionnaires/${patientId}`));

                        const appointmentsSnapshot = await get(ref(database, 'appointments'));
                        if (appointmentsSnapshot.exists()) {
                            appointmentsSnapshot.forEach(child => {
                                if (child.val().userId === patientId) {
                                    remove(ref(database, `appointments/${child.key}`));
                                }
                            });
                        }
                        
                        showMessage(`Patient data deleted from database. NOTE: Deleting the Firebase Authentication user requires server-side access.`, false);
                        
                        loadPatientsList();
                    } catch (error) {
                        showMessage(`Error deleting patient: ${error.message}`, true);
                    }
                },
                () => {
                    showMessage('Patient deletion cancelled.');
                }
            );
        }

        function loadPatientsList() {
            const patientsListDiv = document.getElementById('patientsList');
            if (!currentUser || !isAdmin) {
                patientsListDiv.innerHTML = '<p>Unauthorized access. Please log in as Admin.</p>';
                return;
            }
            
            document.getElementById('patientsList').classList.remove('hidden');
            document.getElementById('patientDetailView').classList.add('hidden');
            document.getElementById('addPatientForm').classList.add('hidden');

            onValue(ref(database, 'patients'), (snapshot) => {
                patientsListDiv.innerHTML = '';
                let hasPatients = false;
                const rawSnapshotData = snapshot.val();

                if (rawSnapshotData) {
                    const patientsArray = Object.keys(rawSnapshotData).map(key => ({ id: key, ...rawSnapshotData[key] }));
                    const filteredPatients = patientsArray.filter(patient =>
                        patient.fullName !== "Jane Doe" && patient.fullName !== "user testing"
                    );
                    allPatientsData = filteredPatients;
                    filteredPatients.sort((a, b) => a.fullName.localeCompare(b.fullName));

                    if (filteredPatients.length > 0) {
                        hasPatients = true;
                        filteredPatients.forEach((patient) => {
                            patientsListDiv.innerHTML += `
                                <button class="btn patient-card-btn" data-patient-id="${patient.id}">
                                    <span>${patient.fullName} (${patient.email})</span>
                                    <i class="fas fa-trash-alt btn-delete" data-id="${patient.id}" data-type="patient"></i>
                                </button>
                            `;
                        });
                    }
                }
                if (!hasPatients) {
                    patientsListDiv.innerHTML = '<p>No patients registered (excluding demo users).</p>';
                }

                document.querySelectorAll('#patientsList .patient-card-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        if (event.target.classList.contains('btn-delete')) {
                            event.stopPropagation();
                            const patientId = event.target.dataset.id;
                            deletePatient(patientId);
                        } else {
                            const patientId = button.dataset.patientId;
                            showPatientDetails(patientId);
                        }
                    });
                });

            }, {
                onlyOnce: false
            });
        }

        async function showPatientDetails(patientId) {
            if (!currentUser || !isAdmin) {
                showMessage('Unauthorized action.', true);
                return;
            }
            currentPatientIdInAdminView = patientId;

            document.getElementById('patientsList').classList.add('hidden');
            document.getElementById('addPatientForm').classList.add('hidden');
            document.getElementById('patientDetailView').classList.remove('hidden');
            document.getElementById('patientSpecificDataResults').innerHTML = '';

            try {
                const patientSnapshot = await get(ref(database, 'patients/' + patientId));
                const patientData = patientSnapshot.val();

                if (patientData) {
                    document.getElementById('patientDetailName').textContent = patientData.fullName;
                    document.getElementById('patientBasicInfo').innerHTML = `
                        <p><strong>Name:</strong> ${patientData.fullName}</p>
                        <p><strong>Email:</strong> ${patientData.email}</p>
                        <p><strong>Phone:</strong> ${patientData.phoneNumber}</p>
                        <p><strong>Date of Birth:</strong> ${patientData.dob || 'N/A'}</p>
                        <p><strong>Gender:</strong> ${patientData.gender}</p>
                        <p><strong>Account Created:</strong> ${new Date(patientData.createdAt).toLocaleString()}</p>
                        <p><strong>Firebase UID:</strong> ${patientId}</p>
                    `;

                    document.getElementById('viewPatientMentalHealthResultsBtn').onclick = () => loadPatientDataSection(patientId, 'mentalHealthTests');
                    document.getElementById('viewPatientTmsQuestionnairesBtn').onclick = () => loadPatientDataSection(patientId, 'tmsQuestionnaires');
                    document.getElementById('viewPatientBookedAppointmentsBtn').onclick = () => loadPatientDataSection(patientId, 'bookedAppointments');

                } else {
                    document.getElementById('patientDetailView').innerHTML = '<p>Patient not found.</p>';
                }
            } catch (error) {
                showMessage(`Error fetching patient details: ${error.message}`, true);
            }
        }

        async function loadPatientDataSection(patientId, dataType) {
            if (!currentUser || !isAdmin || !patientId) {
                showMessage('Unauthorized action or no patient selected.', true);
                return;
            }
            const resultsContainer = document.getElementById('patientSpecificDataResults');
            resultsContainer.innerHTML = '<h4>Loading Results...</h4>';

            let contentHtml = '';

            if (dataType === 'mentalHealthTests') {
                const testResultsSnapshot = await get(ref(database, 'testResults'));
                const testResults = [];
                if (testResultsSnapshot.exists()) {
                    testResultsSnapshot.forEach(child => {
                        const result = child.val();
                        if (result.userId === patientId) {
                            testResults.push(result);
                        }
                    });
                }
                
                testResults.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                if (testResults.length > 0) {
                    contentHtml += '<h3 style="margin-bottom: 15px;">Mental Health Test Results:</h3>';
                    testResults.forEach(result => {
                        contentHtml += `
                            <div class="test-result-item" style="background: linear-gradient(135deg, #00b894 0%, #00a085 100%); margin-bottom: 15px;">
                                <h4>${result.testType}</h4>
                                <p><strong>Score:</strong> ${result.score}</p>
                                <p><strong>Breakdown:</strong> ${result.breakdown}</p>
                                <p style="font-size: 0.8em; opacity: 0.8;">Taken on: ${new Date(result.createdAt).toLocaleString()}</p>
                            </div>
                        `;
                    });
                } else {
                    contentHtml = '<p>No mental health test results found for this patient.</p>';
                }
            } else if (dataType === 'tmsQuestionnaires') {
                const tmsQuestionnairesSnapshot = await get(ref(database, `tmsQuestionnaires/${patientId}`));
                const tmsQuestionnaires = [];
                if (tmsQuestionnairesSnapshot.exists()) {
                    tmsQuestionnairesSnapshot.forEach(child => {
                        tmsQuestionnaires.push(child.val());
                    });
                }

                tmsQuestionnaires.sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt));
                if (tmsQuestionnaires.length > 0) {
                    contentHtml += '<h3 style="margin-bottom: 15px;">TMS Daily Questionnaires (Logged In):</h3>';
                    tmsQuestionnaires.forEach((q, index) => {
                        contentHtml += `
                            <div class="tms-questionnaire-item" style="margin-bottom: 15px;">
                                <h4>Questionnaire Submitted on: ${new Date(q.submittedAt).toLocaleString()}</h4>
                                <!-- Details here -->
                            </div>
                        `;
                    });
                } else {
                    contentHtml = '<p>No TMS daily questionnaires found for this patient.</p>';
                }
            } else if (dataType === 'bookedAppointments') {
                const appointmentsSnapshot = await get(ref(database, 'appointments'));
                const bookedAppointments = [];
                if (appointmentsSnapshot.exists()) {
                    appointmentsSnapshot.forEach(child => {
                        const appt = child.val();
                        if (appt.userId === patientId && appt.status && appt.status.trim() === 'approved') {
                            bookedAppointments.push(appt);
                        }
                    });
                }
                
                bookedAppointments.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                if (bookedAppointments.length > 0) {
                    contentHtml += '<h3 style="margin-bottom: 15px;">Booked Appointments:</h3>';
                    bookedAppointments.forEach(appt => {
                        contentHtml += `
                            <div class="appointment-card booked-appt-card" style="margin-bottom: 15px;">
                                <h4>Appointment</h4>
                                <p><strong>Reason:</strong> ${appt.reason}</p>
                                <p style="font-size: 0.8em; opacity: 0.8;">Booked on: ${new Date(appt.createdAt).toLocaleString()}</p>
                            </div>
                        `;
                    });
                } else {
                    contentHtml = '<p>No booked appointments found for this patient.</p>';
                }

            } else {
                contentHtml = '<p>Invalid data type requested.</p>';
            }

            resultsContainer.innerHTML = contentHtml;
        }

        async function deleteTmsSubmission(submissionId, submissionPath, userIdForUserSubmission = null) {
            if (!currentUser || !isAdmin) {
                showMessage('Unauthorized action.', true);
                return;
            }

            const pathToDelete = userIdForUserSubmission ? `${submissionPath}/${userIdForUserSubmission}/${submissionId}` : `${submissionPath}/${submissionId}`;

            showConfirmationModal(
                `Are you sure you want to permanently delete this TMS questionnaire submission?`,
                async () => {
                    try {
                        await remove(ref(database, pathToDelete));
                        showMessage('TMS submission deleted successfully!');
                        loadAdminTmsSubmissions();
                    } catch (error) {
                        showMessage(`Error deleting TMS submission: ${error.message}`, true);
                    }
                },
                () => {
                    showMessage('TMS submission deletion cancelled.');
                }
            );
        }

        async function loadAdminTmsSubmissions() {
            const tmsSubmissionsListDiv = document.getElementById('tmsSubmissionsList');
            if (!currentUser || !isAdmin) {
                tmsSubmissionsListDiv.innerHTML = '<p>Unauthorized access. Please log in as Admin.</p>';
                return;
            }
            tmsSubmissionsListDiv.innerHTML = '<p>Loading TMS submissions...</p>';

            let allTmsSubmissions = [];

            try {
                const patientsSnapshot = await get(ref(database, 'patients'));
                if (patientsSnapshot.exists()) {
                    for (const userId in patientsSnapshot.val()) {
                        const userTmsSnapshot = await get(ref(database, `tmsQuestionnaires/${userId}`));
                        if (userTmsSnapshot.exists()) {
                            userTmsSnapshot.forEach(childSnapshot => {
                                const submission = childSnapshot.val();
                                allTmsSubmissions.push({ id: childSnapshot.key, fromUser: userId, ...submission });
                            });
                        }
                    }
                }
            } catch (error) { console.error(error); }

            try {
                const publicTmsSnapshot = await get(ref(database, 'publicTmsQuestionnaires'));
                if (publicTmsSnapshot.exists()) {
                    publicTmsSnapshot.forEach(childSnapshot => {
                        const submission = childSnapshot.val();
                        allTmsSubmissions.push({ id: childSnapshot.key, fromUser: 'public', ...submission });
                    });
                }
            } catch (error) { console.error(error); }

            allTmsSubmissions.sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt));

            tmsSubmissionsListDiv.innerHTML = '';

            if (allTmsSubmissions.length > 0) {
                allTmsSubmissions.forEach(submission => {
                    const submittedByInfo = submission.fromUser === 'public'
                        ? `<strong>from quick access</strong>`
                        : `<strong>Logged-in User</strong>`;
                    
                    tmsSubmissionsListDiv.innerHTML += `
                        <div class="tms-submission-card">
                            <div>
                                <h4>TMS Questionnaire from ${submission.fullName || 'Anonymous'} (${submittedByInfo})</h4>
                                <p><strong>Submitted On:</strong> ${new Date(submission.submittedAt).toLocaleString()}</p>
                            </div>
                            <div class="card-actions">
                                <button class="btn btn-view-details" data-submission-id="${submission.id}" data-submission-path="${submission.fromUser === 'public' ? 'publicTmsQuestionnaires' : `tmsQuestionnaires`}" data-user-id="${submission.fromUser === 'public' ? '' : submission.fromUser}">View Details</button>
                                <i class="fas fa-trash-alt btn-delete" data-id="${submission.id}" data-type="${submission.fromUser === 'public' ? 'publicTms' : 'userTms'}" data-user-id="${submission.fromUser === 'public' ? '' : submission.fromUser}"></i>
                            </div>
                        </div>
                    `;
                });

                document.querySelectorAll('.tms-submission-card .btn-view-details').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const { submissionId, submissionPath, userId } = event.target.dataset;
                        viewTmsSubmissionDetails(submissionId, submissionPath, userId || null);
                    });
                });

                document.querySelectorAll('.tms-submission-card .btn-delete').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const { id, type, userId } = event.target.dataset;
                        deleteTmsSubmission(id, type === 'publicTms' ? 'publicTmsQuestionnaires' : 'tmsQuestionnaires', userId || null);
                    });
                });

            } else {
                tmsSubmissionsListDiv.innerHTML = '<p>No TMS Daily Questionnaires found.</p>';
            }
        }

        async function viewTmsSubmissionDetails(submissionId, submissionPath, userId) {
            try {
                const path = userId ? `${submissionPath}/${userId}/${submissionId}` : `${submissionPath}/${submissionId}`;
                const submissionSnapshot = await get(ref(database, path));
                const submission = submissionSnapshot.val();

                if (submission) {
                    currentTmsSubmissionForPdf = submission;
                    
                    document.getElementById('tmsModalPatientName').textContent = submission.fullName || 'Anonymous';
                    document.getElementById('tmsModalPatientEmail').textContent = submission.email || 'N/A';
                    document.getElementById('tmsModalPatientPhone').textContent = submission.phoneNumber || 'N/A';
                    document.getElementById('tmsModalSubmittedAt').textContent = new Date(submission.submittedAt).toLocaleString();
                    
                    const answersDiv = document.getElementById('tmsModalAnswers');
                    answersDiv.innerHTML = '<h4>Questionnaire Answers:</h4>';
                    // Display answers
                    for(const key in submission.answers) {
                        answersDiv.innerHTML += `<p><strong>${key}:</strong> ${submission.answers[key]}</p>`;
                    }

                    const moveBtn = document.getElementById('moveTmsToPatientBtn');
                    const assignSection = document.getElementById('assignTmsToPatientSection');
                    const patientDropdown = document.getElementById('tmsPatientSelectDropdown');
                    const confirmAssignBtn = document.getElementById('confirmTmsAssignmentBtn');

                    moveBtn.onclick = () => {
                        assignSection.classList.toggle('hidden');
                        if (!assignSection.classList.contains('hidden')) {
                            populatePatientDropdown(patientDropdown);
                        }
                    };

                    confirmAssignBtn.onclick = () => {
                        const newPatientId = patientDropdown.value;
                        if (newPatientId) {
                            assignSubmissionToPatient(submissionId, 'tms', userId, newPatientId);
                            document.getElementById('tmsDetailModal').classList.add('hidden');
                        } else {
                            showMessage('Please select a patient.', true);
                        }
                    };

                    document.getElementById('tmsDetailModal').classList.remove('hidden');
                } else {
                    showMessage('TMS submission details not found.', true);
                }
            } catch (error) {
                showMessage(`Error fetching TMS submission details: ${error.message}`, true);
            }
        }

        async function deleteMentalHealthTestSubmission(submissionId, submissionType, userIdForUserSubmission = null) {
            if (!currentUser || !isAdmin) {
                showMessage('Unauthorized action.', true);
                return;
            }

            let pathToDelete = (submissionType === 'public-anonymous' || submissionType === 'logged-in-copy')
                ? `publicMentalHealthTestSubmissions/${submissionId}`
                : `testResults/${submissionId}`;

            showConfirmationModal(
                `Are you sure you want to permanently delete this Mental Health Test submission?`,
                async () => {
                    try {
                        await remove(ref(database, pathToDelete));
                        showMessage('Mental Health Test submission deleted successfully!');
                        loadAdminPublicTestResults();
                    } catch (error) {
                        showMessage(`Error deleting submission: ${error.message}`, true);
                    }
                },
                () => {
                    showMessage('Deletion cancelled.');
                }
            );
        }

        async function loadAdminPublicTestResults() {
            const listDiv = document.getElementById('publicTestResultsList');
            if (!currentUser || !isAdmin) {
                listDiv.innerHTML = '<p>Unauthorized access.</p>';
                return;
            }
            listDiv.innerHTML = '<p>Loading results...</p>';

            let allTestSubmissions = [];

            try {
                const publicTestsSnapshot = await get(ref(database, 'publicMentalHealthTestSubmissions'));
                if (publicTestsSnapshot.exists()) {
                    publicTestsSnapshot.forEach(childSnapshot => {
                        const submission = childSnapshot.val();
                        allTestSubmissions.push({
                            id: childSnapshot.key,
                            type: submission.userId ? 'logged-in-copy' : 'public-anonymous',
                            ...submission
                        });
                    });
                }
            } catch (error) { console.error(error); }
            
            allTestSubmissions.sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt));
            listDiv.innerHTML = '';

            if (allTestSubmissions.length > 0) {
                allTestSubmissions.forEach(submission => {
                    const submitterName = submission.fullName || 'Anonymous';
                    const submissionOrigin = submission.type === 'public-anonymous' ? 'Quick Access' : 'Patient Portal';

                    listDiv.innerHTML += `
                        <div class="public-test-submission-card">
                            <div>
                                <h4>${submission.testType} - from ${submissionOrigin}</h4>
                                <p><strong>Submitted By:</strong> ${submitterName}</p>
                                <p><strong>Score:</strong> ${submission.score}</p>
                            </div>
                            <div class="card-actions">
                                <button class="btn btn-view-details"
                                    data-submission-id="${submission.id}"
                                    data-submission-type="${submission.type}"
                                    data-user-id="${submission.userId || ''}">View</button>
                                <i class="fas fa-trash-alt btn-delete"
                                    data-id="${submission.id}"
                                    data-type="${submission.type}"
                                    data-user-id="${submission.userId || ''}"></i>
                            </div>
                        </div>
                    `;
                });

                document.querySelectorAll('#publicTestResultsList .btn-view-details').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const { submissionId, submissionType, userId } = event.target.dataset;
                        viewPublicTestSubmissionDetails(submissionId, submissionType, userId || null);
                    });
                });

                document.querySelectorAll('#publicTestResultsList .btn-delete').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const { id, type, userId } = event.target.dataset;
                        deleteMentalHealthTestSubmission(id, type, userId || null);
                    });
                });

            } else {
                listDiv.innerHTML = '<p>No mental health test results found.</p>';
            }
        }

        async function viewPublicTestSubmissionDetails(submissionId, submissionType, userId) {
            try {
                let submission;
                let path = (submissionType === 'public-anonymous' || submissionType === 'logged-in-copy')
                    ? `publicMentalHealthTestSubmissions/${submissionId}`
                    : `testResults/${submissionId}`;

                const snapshot = await get(ref(database, path));
                submission = snapshot.val();
                
                if (submission) {
                    let finalFullName = submission.fullName || 'Anonymous';
                    if (submissionType.startsWith('logged-in') && submission.userId) {
                        const patientSnapshot = await get(ref(database, `patients/${submission.userId}`));
                        if(patientSnapshot.exists()) finalFullName = patientSnapshot.val().fullName;
                    }

                    document.getElementById('publicTestModalType').textContent = submission.testType;
                    document.getElementById('publicTestModalSubmitter').textContent = finalFullName;
                    document.getElementById('publicTestModalScore').textContent = submission.score;
                    document.getElementById('publicTestModalBreakdown').textContent = submission.breakdown;
                    document.getElementById('publicTestModalSubmittedAt').textContent = new Date(submission.submittedAt || submission.createdAt).toLocaleString();

                    const answersDiv = document.getElementById('publicTestModalAnswers');
                    answersDiv.innerHTML = '<h4>Answers:</h4>';
                    if (submission.answers && Array.isArray(submission.answers)) {
                        submission.answers.forEach((ans, index) => {
                            answersDiv.innerHTML += `<p><strong>${index + 1}. ${ans.question}:</strong> ${ans.answer}</p>`;
                        });
                    }

                    const moveBtn = document.getElementById('movePublicTestToPatientBtn');
                    const assignSection = document.getElementById('assignPublicTestToPatientSection');
                    const patientDropdown = document.getElementById('publicTestPatientSelectDropdown');
                    const confirmAssignBtn = document.getElementById('confirmPublicTestAssignmentBtn');

                    if (submissionType === 'public-anonymous') {
                        moveBtn.classList.remove('hidden');
                        moveBtn.onclick = () => {
                            assignSection.classList.toggle('hidden');
                            if (!assignSection.classList.contains('hidden')) {
                                populatePatientDropdown(patientDropdown);
                            }
                        };
                        confirmAssignBtn.onclick = () => {
                            const newPatientId = patientDropdown.value;
                            if (newPatientId) {
                                assignSubmissionToPatient(submissionId, 'mentalHealthTest', null, newPatientId);
                                document.getElementById('publicTestDetailModal').classList.add('hidden');
                            } else {
                                showMessage('Please select a patient.', true);
                            }
                        };
                    } else {
                        moveBtn.classList.add('hidden');
                        assignSection.classList.add('hidden');
                    }
                    
                    document.getElementById('publicTestDetailModal').classList.remove('hidden');
                } else {
                    showMessage('Submission details not found.', true);
                }
            } catch (error) {
                showMessage(`Error fetching submission details: ${error.message}`, true);
            }
        }

        async function populatePatientDropdown(dropdownElement) {
            if (allPatientsData.length === 0) {
                const patientsSnapshot = await get(ref(database, 'patients'));
                if (patientsSnapshot.exists()) {
                    allPatientsData = Object.keys(patientsSnapshot.val()).map(key => ({ id: key, ...patientsSnapshot.val()[key] }));
                    allPatientsData = allPatientsData.filter(p => p.fullName !== "Jane Doe" && p.fullName !== "user testing");
                    allPatientsData.sort((a, b) => a.fullName.localeCompare(b.fullName));
                }
            }

            dropdownElement.innerHTML = '<option value="">Select a Patient</option>';
            allPatientsData.forEach(patient => {
                const option = document.createElement('option');
                option.value = patient.id;
                option.textContent = `${patient.fullName} (${patient.email})`;
                dropdownElement.appendChild(option);
            });
        }

        async function assignSubmissionToPatient(submissionId, submissionType, currentUserId, newPatientId) {
            if (!isAdmin || !newPatientId) return;

            try {
                let originalPath, targetPath;
                if (submissionType === 'tms') {
                    originalPath = currentUserId ? `tmsQuestionnaires/${currentUserId}/${submissionId}` : `publicTmsQuestionnaires/${submissionId}`;
                    targetPath = `tmsQuestionnaires/${newPatientId}`;
                } else {
                    originalPath = `publicMentalHealthTestSubmissions/${submissionId}`;
                    targetPath = `testResults`;
                }

                const originalSnapshot = await get(ref(database, originalPath));
                if (!originalSnapshot.exists()) {
                    showMessage('Original submission not found.', true);
                    return;
                }
                const submissionData = originalSnapshot.val();

                const newPatientSnapshot = await get(ref(database, `patients/${newPatientId}`));
                if (!newPatientSnapshot.exists()) {
                    showMessage('Target patient not found.', true);
                    return;
                }
                const newPatientData = newPatientSnapshot.val();

                const newSubmissionData = {
                    ...submissionData,
                    userId: newPatientId,
                    fullName: newPatientData.fullName,
                    email: newPatientData.email,
                    phoneNumber: newPatientData.phoneNumber,
                    createdAt: submissionData.createdAt || submissionData.submittedAt
                };

                const newEntryRef = push(ref(database, targetPath));
                await set(newEntryRef, newSubmissionData);
                await remove(ref(database, originalPath));

                showMessage('Submission successfully assigned!');
                if (submissionType === 'tms') loadAdminTmsSubmissions();
                else loadAdminPublicTestResults();

            } catch (error) {
                showMessage(`Error assigning submission: ${error.message}`, true);
            }
        }
        
        async function loadAdminCalendar() {
            const calendarEl = document.getElementById('calendar');
            const eventDetailsModal = document.getElementById('eventDetailsModal');
            const closeModalBtn = document.getElementById('closeModalBtn');

            if (!isAdmin) {
                calendarEl.innerHTML = '<p>Unauthorized access.</p>';
                if (adminCalendarInstance) adminCalendarInstance.destroy();
                adminCalendarInstance = null;
                return;
            }

            if (adminCalendarInstance) adminCalendarInstance.destroy();

            adminCalendarInstance = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                editable: true,
                events: async (fetchInfo, successCallback, failureCallback) => {
                    try {
                        const snapshot = await get(ref(database, 'appointments'));
                        const events = [];
                        if (snapshot.exists()) {
                            snapshot.forEach(childSnapshot => {
                                const appt = childSnapshot.val();
                                if (appt.status && appt.status.trim() === 'approved') {
                                    // Logic to create event object from appt
                                    events.push({
                                      id: childSnapshot.key,
                                      title: `Appt: ${appt.fullName}`,
                                      start: `${appt.appointmentDate}T${appt.appointmentTime || '12:00:00'}`,
                                      extendedProps: appt
                                    });
                                }
                            });
                        }
                        successCallback(events);
                    } catch (error) {
                        failureCallback(error);
                    }
                },
                eventClick: function(info) {
                    const props = info.event.extendedProps;
                    document.getElementById('modalEventTitle').textContent = `Appointment with ${props.fullName}`;
                    document.getElementById('modalPatientName').textContent = props.fullName;
                    document.getElementById('modalPatientEmail').textContent = props.email;
                    document.getElementById('modalPatientPhone').textContent = props.phoneNumber;
                    document.getElementById('modalEventDateTime').textContent = `${props.appointmentDate} at ${props.appointmentTime || 'N/A'}`;
                    document.getElementById('modalEventDob').textContent = props.dob;
                    document.getElementById('modalEventReason').textContent = props.reason;
                    document.getElementById('modalEventStatus').textContent = props.status.toUpperCase();
                    eventDetailsModal.classList.remove('hidden');
                },
                eventDrop: function(info) {
                    showConfirmationModal(
                        `Move appointment for "${info.event.extendedProps.fullName}"?`,
                        () => updateAppointmentDateTime(info.event.id, info.event.start, info.event.end),
                        () => info.revert()
                    );
                },
            });

            adminCalendarInstance.render();

            closeModalBtn.onclick = () => eventDetailsModal.classList.add('hidden');
            window.onclick = (event) => {
                if (event.target == eventDetailsModal) eventDetailsModal.classList.add('hidden');
            };
        }

        async function updateAppointmentDateTime(appointmentId, newStart, newEnd) {
            try {
                const newDateStr = newStart.toISOString().split('T')[0];
                const newTimeStr = newStart.toTimeString().split(' ')[0].substring(0,5);

                await update(ref(database, `appointments/${appointmentId}`), {
                    appointmentDate: newDateStr,
                    appointmentTime: newTimeStr
                });
                showMessage('Appointment updated successfully!');
            } catch (error) {
                showMessage(`Error updating appointment: ${error.message}`, true);
            }
        }

         function downloadTmsPdf() {
            if (!currentTmsSubmissionForPdf) {
                showMessage('No TMS submission data available for PDF.', true);
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                if (typeof jsPDF === 'undefined') {
                    showMessage("PDF generation library not found.", true);
                    return;
                }
                const doc = new jsPDF();
                // PDF generation logic here
                doc.save('tms_questionnaire.pdf');
                showMessage('PDF downloaded successfully!');
            } catch (error) {
                showMessage(`Failed to generate PDF: ${error.message}.`, true);
            }
        }

        // --- Initial Load Logic and Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('loginBtn').addEventListener('click', login);
            document.getElementById('showSignupBtn').addEventListener('click', showSignup);
            document.getElementById('showAdminLoginBtn').addEventListener('click', showAdminLogin);
            document.getElementById('signupBtn').addEventListener('click', signup);
            document.getElementById('backToLoginBtn').addEventListener('click', showLogin);
            document.getElementById('adminLoginBtn').addEventListener('click', adminLogin);
            document.getElementById('backToPatientLoginBtn').addEventListener('click', showLogin);

            document.getElementById('publicBookAppointmentBtn').addEventListener('click', showPublicBookingForm);
            document.getElementById('submitPublicAppointmentBtn').addEventListener('click', submitPublicAppointment);
            document.getElementById('cancelPublicAppointmentBtn').addEventListener('click', showLoginScreenLayout);

            document.getElementById('publicTmsQuestionnaireBtn').addEventListener('click', () => showTmsQuestionnaire(false));
            document.getElementById('publicMentalHealthTestsBtn').addEventListener('click', showPublicMentalHealthTestSelection);
            document.getElementById('backToPublicAccessBtn').addEventListener('click', showLoginScreenLayout);

            document.querySelectorAll('#publicMentalHealthTestsSection .test-card').forEach(card => {
                card.addEventListener('click', (event) => {
                    const testType = event.currentTarget.dataset.testType;
                    startPublicTest(testType);
                });
            });

            document.getElementById('patientLogoutBtn').addEventListener('click', logout);
            document.getElementById('adminLogoutBtn').addEventListener('click', logout);
            document.getElementById('showBookingFormBtn').addEventListener('click', showBookingForm);
            document.getElementById('submitAppointmentRequestBtn').addEventListener('click', bookAppointment);
            document.getElementById('hideBookingFormBtn').addEventListener('click', hideBookingForm);
            document.getElementById('submitTestBtn').addEventListener('click', submitTest);
            document.getElementById('cancelTestBtn').addEventListener('click', cancelTest);
            document.getElementById('showTmsQuestionnaireBtnLoggedIn').addEventListener('click', () => showTmsQuestionnaire(true));
            document.getElementById('submitTmsQuestionnaireBtn').addEventListener('click', submitTmsQuestionnaire);
            document.getElementById('cancelTmsQuestionnaireBtn').addEventListener('click', cancelTmsQuestionnaire);
            setupTmsFormListeners();
            document.getElementById('closeTmsModalBtn').addEventListener('click', () => document.getElementById('tmsDetailModal').classList.add('hidden'));
            document.getElementById('downloadTmsPdfBtn').addEventListener('click', downloadTmsPdf);
            document.getElementById('closePublicTestModalBtn').addEventListener('click', () => document.getElementById('publicTestDetailModal').classList.add('hidden'));

            document.getElementById('patientSidebarNav').addEventListener('click', (event) => {
                if (event.target.tagName === 'LI') showPatientSection(event.target.dataset.section);
            });
            document.getElementById('mentalHealthSection').addEventListener('click', (event) => {
                if (event.target.closest('.test-card')) startTest(event.target.closest('.test-card').dataset.testType);
            });
            document.getElementById('adminSidebarNav').addEventListener('click', (event) => {
                if (event.target.tagName === 'LI') showAdminSection(event.target.dataset.section);
            });
            document.getElementById('showAddPatientFormBtn').addEventListener('click', showAddPatientForm);
            document.getElementById('addPatientBtn').addEventListener('click', addPatient);
            document.getElementById('hideAddPatientFormBtn').addEventListener('click', hideAddPatientForm);
            document.getElementById('backToPatientsListBtn').addEventListener('click', loadPatientsList);
            
            onAuthStateChanged(auth, (user) => {
                currentUser = user;
                if (user) {
                    if (user.email === ADMIN_EMAIL) {
                        isAdmin = true;
                        showAdminDashboard();
                    } else {
                        isAdmin = false;
                        showPatientDashboard();
                    }
                } else {
                    isAdmin = false;
                    showLoginScreenLayout();
                    showLogin();
                }
            });
        });

    </script>
</body>
</html>
