<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealMed Patient/Admin Portal</title>
    <!-- FullCalendar CSS -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.css" rel="stylesheet" />
    <!-- Font Awesome for Icons (Still useful for general icons if needed) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* All your CSS styles are now embedded here */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column; /* Changed to column to stack header on top */
            align-items: center;
            justify-content: flex-start; /* Align content from the top */
            overflow-y: auto; /* Allow scrolling for content that overflows viewport */
        }

        .container {
            width: 100%;
            max-width: 1200px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            margin: 20px;
            flex-grow: 1; /* Allow container to grow and fill space below header */
        }

        .hidden {
            display: none !important;
        }

        /* Top Header for Branding */
        .header-branding {
            width: 100%; /* Take full width */
            padding: 20px;
            background: #2c3e50; /* Dark background for header */
            color: white;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            margin-bottom: 20px; /* Space between header and container */
        }

        .header-branding h1 {
            font-size: 2.5em; /* Larger for main name */
            font-weight: 700;
            margin-bottom: 5px; /* Space between name and slogan */
        }
        .header-branding p {
            font-size: 1.2em; /* Slogan size */
            opacity: 0.8;
            margin: 0; /* Remove default paragraph margin */
        }


        /* Login Screen */
        .login-screen {
            padding: 60px;
            text-align: center;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100%; /* Take full height of its parent (container) */
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .login-form {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .login-form h2 {
            margin-bottom: 30px;
            color: #333;
            font-size: 28px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            color: #333;
        }

        .link-btn {
            background: none;
            color: #667eea;
            text-decoration: underline;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }

        /* Dashboard */
        .dashboard {
            display: flex;
            min-height: 100%; /* Take full height of its parent (container) */
            position: relative; /* For logout button positioning */
        }

        .sidebar {
            width: 250px;
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px 0;
            flex-shrink: 0; /* Prevent sidebar from shrinking */
        }

        .sidebar h3 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
        }

        .sidebar ul {
            list-style: none;
        }

        .sidebar li {
            padding: 15px 30px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .sidebar li:hover, .sidebar li.active {
            background-color: rgba(255,255,255,0.1);
        }

        .main-content {
            flex: 1;
            padding: 40px;
            background: #f8f9fa;
            overflow-y: auto; /* Allow scrolling for main content */
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px; /* Add margin between sections */
        }

        .section h2 {
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 24px;
        }

        /* Appointments */
        .appointment-card {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .appointment-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .status-pending {
            background: #f39c12;
        }

        .status-approved {
            background: #27ae60;
        }

        .status-denied {
            background: #e74c3c;
        }

        /* Mental Health Tests */
        .test-card {
            background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .test-card:hover {
            transform: translateY(-3px);
        }

        .question {
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            color: #333; /* Ensure text is readable */
        }

        .question h4 {
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .radio-option:hover {
            background: #e9ecef;
        }

        .test-result-item { /* Changed from test-result to avoid conflict */
            background: linear-gradient(135deg, #00b894 0%, #00a085 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            margin-bottom: 15px; /* Add margin for list items */
        }

        /* Admin specific styles */
        .admin-card {
            background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .admin-card.approved-status {
             background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); /* Green for approved */
        }
        .admin-card.denied-status {
             background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); /* Red for denied */
        }


        .action-buttons {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        .btn-approve {
            background: #27ae60;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .btn-approve:hover {
            transform: translateY(-2px);
        }

        .btn-deny {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .btn-deny:hover {
            transform: translateY(-2px);
        }


        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 100; /* Ensure it's above other content */
        }

        .calendar-entry {
            background: linear-gradient(135deg, #81ecec 0%, #00cec9 100%);
            color: #333;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .calendar-entry h4 {
            color: #2c3e50;
            margin-bottom: 5px;
        }

        /* FullCalendar specific styles */
        #calendar {
            max-width: 900px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            min-height: 500px; /* Ensure calendar has some initial height */
        }

        .fc .fc-toolbar-title {
            font-size: 1.8em;
            color: #2c3e50;
        }

        .fc .fc-button-primary {
            background-color: #667eea;
            border-color: #667eea;
            color: white;
            border-radius: 5px;
            padding: 8px 15px;
            transition: background-color 0.2s;
        }
        .fc .fc-button-primary:hover {
            background-color: #5a6de0;
            border-color: #5a6de0;
        }
        .fc .fc-button-primary:not(:disabled).fc-button-active {
            background-color: #4a5dc1;
            border-color: #4a5dc1;
        }

        /* Custom event rendering for FullCalendar: green circle */
        .fc-event-main-frame {
            display: flex;
            align-items: center;
            gap: 5px; /* Space between circle and text */
        }
        .event-circle {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #27ae60; /* Green color for approved */
            flex-shrink: 0; /* Prevent it from shrinking */
        }
        /* Default FullCalendar event background */
        .fc-event {
            background-color: #0984e3 !important; /* Default blue for event */
            border-color: #0984e3 !important;
            border-radius: 5px !important;
            padding: 3px 5px !important;
            font-size: 0.85em !important;
            cursor: pointer; /* Indicate clickable event */
        }
        /* Specific styling for the green dot events (if you want to override default background) */
        .fc-event.approved-event {
            background-color: #27ae60 !important; /* Make the event itself green */
            border-color: #27ae60 !important;
        }

        .fc-event-title {
            color: white !important;
            font-weight: bold;
        }
        
        .fc-event-time {
            color: rgba(255, 255, 255, 0.8) !important;
        }

        /* Modal for event details */
        .modal {
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border: 1px solid #888;
            border-radius: 15px;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: relative;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-content h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 22px;
        }
        .modal-content p {
            margin-bottom: 8px;
            color: #555;
        }

        /* Admin Appointment Category Buttons */
        .admin-appt-category-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }
        .admin-appt-category-buttons .btn {
            width: auto; /* Allow buttons to size based on content */
            padding: 10px 20px;
            font-size: 14px;
            border-radius: 5px;
            background: #e9ecef; /* Neutral background */
            color: #333;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .admin-appt-category-buttons .btn.active-category {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); /* Active style */
            color: white;
        }


        @media (max-width: 768px) {
            .dashboard {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                padding: 20px 0;
            }

            .sidebar ul {
                display: flex;
                overflow-x: auto;
                justify-content: space-around; /* Distribute items */
            }

            .sidebar li {
                white-space: nowrap;
                min-width: 120px; /* Adjusted minimum width for smaller screens */
                text-align: center;
            }

            .main-content {
                padding: 20px;
            }
            .login-screen {
                padding: 30px;
            }
            .login-form {
                padding: 30px;
            }
            #calendar {
                padding: 10px;
            }
            .fc .fc-toolbar-title {
                font-size: 1.2em;
            }
            .admin-appt-category-buttons {
                flex-wrap: wrap;
            }
            .admin-appt-category-buttons .btn {
                flex-grow: 1; /* Allow them to grow and fill space */
            }
        }
    </style>
</head>
<body>
    <div class="header-branding">
        <h1>HealMed Clinic &trade;</h1>
        <p>Let's heal minds</p>
    </div>
    <div class="container">
        <!-- Login Screen -->
        <div id="loginScreen" class="login-screen">
            <div class="login-form">
                <h2>Patient Portal Login</h2>
                <div class="form-group">
                    <label for="loginEmail">Email:</label>
                    <input type="email" id="loginEmail" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password:</label>
                    <input type="password" id="loginPassword" placeholder="Enter your password" required>
                </div>
                <button class="btn" id="loginBtn">Login</button>
                <button class="btn btn-secondary" id="showSignupBtn">Create Account</button>
                <button class="link-btn" id="showAdminLoginBtn">Staff Login</button>
            </div>
        </div>

        <!-- Signup Screen -->
        <div id="signupScreen" class="login-screen hidden">
            <div class="login-form">
                <h2>Create Account</h2>
                <div class="form-group">
                    <label for="signupName">Full Name:</label>
                    <input type="text" id="signupName" placeholder="Enter your full name" required>
                </div>
                <div class="form-group">
                    <label for="signupEmail">Email:</label>
                    <input type="email" id="signupEmail" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="signupPassword">Password:</label>
                    <input type="password" id="signupPassword" placeholder="Create a password" required>
                </div>
                <div class="form-group">
                    <label for="signupPhone">Phone Number:</label>
                    <input type="tel" id="signupPhone" placeholder="Enter your phone number" required>
                </div>
                <div class="form-group">
                    <label for="signupGender">Gender:</label>
                    <select id="signupGender" required>
                        <option value="">Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                        <option value="prefer-not-to-say">Prefer not to say</option>
                    </select>
                </div>
                <button class="btn" id="signupBtn">Create Account</button>
                <button class="link-btn" id="backToLoginBtn">Back to Login</button>
            </div>
        </div>

        <!-- Admin Login Screen -->
        <div id="adminLoginScreen" class="login-screen hidden">
            <div class="login-form">
                <h2>Staff Login</h2>
                <div class="form-group">
                    <label for="adminEmail">Email:</label>
                    <input type="email" id="adminEmail" placeholder="Enter admin email" required>
                </div>
                <div class="form-group">
                    <label for="adminPassword">Password:</label>
                    <input type="password" id="adminPassword" placeholder="Enter password" required>
                </div>
                <button class="btn" id="adminLoginBtn">Login</button>
                <button class="link-btn" id="backToPatientLoginBtn">Back to Patient Login</button>
            </div>
        </div>

        <!-- Patient Dashboard -->
        <div id="patientDashboard" class="dashboard hidden">
            <button class="logout-btn" id="patientLogoutBtn">Logout</button>
            <div class="sidebar">
                <h3>Patient Portal</h3>
                <ul id="patientSidebarNav">
                    <li class="active" data-section="appointments">Manage Appointments</li>
                    <li data-section="mentalHealth">Mental Health Tests</li>
                    <li data-section="healthRecords">Health Records</li>
                    <li data-section="profile">Profile</li>
                </ul>
            </div>
            <div class="main-content">
                <!-- Appointments Section -->
                <div id="appointmentsSection" class="section">
                    <h2>Manage Appointments</h2>
                    <div id="appointmentsList"></div>
                    <button class="btn" id="showBookingFormBtn">Book New Appointment</button>

                    <!-- Booking Form (Updated to include date picker) -->
                    <div id="bookingForm" class="hidden" style="margin-top: 20px; background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <h3>Book New Appointment</h3>
                        <div class="form-group">
                            <label for="appointmentDate">Preferred Date:</label>
                            <input type="date" id="appointmentDate" required>
                        </div>
                        <div class="form-group">
                            <label for="appointmentTime">Preferred Appointment Time:</label>
                            <select id="appointmentTime" required>
                                <option value="">Select Time</option>
                                <option value="09:00">09:00 AM</option>
                                <option value="10:00">10:00 AM</option>
                                <option value="11:00">11:00 AM</option>
                                <option value="12:00">12:00 PM</option>
                                <option value="13:00">01:00 PM</option>
                                <option value="14:00">02:00 PM</option>
                                <option value="15:00">03:00 PM</option>
                                <option value="16:00">04:00 PM</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="appointmentReason">Reason for Visit:</label>
                            <textarea id="appointmentReason" placeholder="Please describe the reason for your visit" required></textarea>
                        </div>
                        <button class="btn" id="submitAppointmentRequestBtn">Submit Request</button>
                        <button class="btn btn-secondary" id="hideBookingFormBtn">Cancel</button>
                    </div>
                </div>

                <!-- Mental Health Tests Section -->
                <div id="mentalHealthSection" class="section hidden">
                    <h2>Mental Health Tests</h2>
                    <div class="test-card" data-test-type="depression">
                        <h3>Depression Screening (PHQ-9)</h3>
                        <p>Take a self-assessment to screen for depression symptoms</p>
                    </div>
                    <div class="test-card" data-test-type="anxiety">
                        <h3>Anxiety Screening (GAD-7)</h3>
                        <p>Take a self-assessment to screen for anxiety symptoms</p>
                    </div>
                    <div class="test-card" data-test-type="adhd">
                        <h3>ADHD Screening</h3>
                        <p>Take a self-assessment to screen for ADHD symptoms</p>
                    </div>
                    <h4>Your Past Test Results:</h4>
                    <div id="testResultsList"></div>
                </div>

                <!-- Test Taking Interface -->
                <div id="testInterface" class="section hidden">
                    <h2 id="testTitle"></h2>
                    <div id="testQuestions"></div>
                    <button class="btn" id="submitTestBtn">Submit Test</button>
                    <button class="btn btn-secondary" id="cancelTestBtn">Cancel</button>
                </div>

                <!-- Health Records Section -->
                <div id="healthRecordsSection" class="section hidden">
                    <h2>Health Records</h2>
                    <p>Your health records and medical history will be displayed here.</p>
                    <div id="healthRecordsList"></div>
                </div>

                <!-- Profile Section -->
                <div id="profileSection" class="section hidden">
                    <h2>Profile</h2>
                    <div id="profileInfo"></div>
                </div>
            </div>
        </div>

        <!-- Admin Dashboard -->
        <div id="adminDashboard" class="dashboard hidden">
            <button class="logout-btn" id="adminLogoutBtn">Logout</button>
            <div class="sidebar">
                <h3>Admin Portal</h3>
                <ul id="adminSidebarNav">
                    <li class="active" data-section="appointments">Appointment Requests</li>
                    <li data-section="patients">Patient Management</li>
                    <li data-section="testResults">Test Results</li>
                    <li data-section="calendar">Calendar</li> <!-- New Calendar Section -->
                </ul>
            </div>
            <div class="main-content">
                <!-- Admin Appointments Section (Reorganized) -->
                <div id="adminAppointmentsSection" class="section">
                    <div class="admin-appt-category-buttons">
                        <button class="btn active-category" data-category="pending" id="showPendingAppointmentsBtn">Pending</button>
                        <button class="btn" data-category="approved" id="showApprovedAppointmentsBtn">Approved</button>
                        <button class="btn" data-category="denied" id="showDeniedAppointmentsBtn">Denied</button>
                    </div>
                    
                    <h2 id="adminAppointmentsTitle">Appointment Requests (Pending)</h2>
                    
                    <!-- Pending Appointments List (Default View) -->
                    <div id="adminPendingAppointmentsList"></div> 
                    
                    <!-- Approved Appointments List (Initially Hidden) -->
                    <div id="adminApprovedAppointmentsList" class="hidden"></div>

                    <!-- Denied Appointments List (Initially Hidden) -->
                    <div id="adminDeniedAppointmentsList" class="hidden"></div>
                </div>

                <!-- Admin Patients Section -->
                <div id="adminPatientsSection" class="section hidden">
                    <h2>Patient Management</h2>
                    <button class="btn" id="showAddPatientFormBtn">Add New Patient (via Admin)</button>
                    <div id="patientsList"></div>

                    <!-- Add Patient Form -->
                    <div id="addPatientForm" class="hidden" style="margin-top: 20px; background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <h3>Add New Patient</h3>
                        <div class="form-group">
                            <label for="newPatientName">Full Name:</label>
                            <input type="text" id="newPatientName" required>
                        </div>
                        <div class="form-group">
                            <label for="newPatientEmail">Email:</label>
                            <input type="email" id="newPatientEmail" required>
                        </div>
                        <div class="form-group">
                            <label for="newPatientPassword">Password:</label>
                            <input type="password" id="newPatientPassword" required>
                        </div>
                        <div class="form-group">
                            <label for="newPatientPhone">Phone:</label>
                            <input type="tel" id="newPatientPhone" required>
                        </div>
                        <div class="form-group">
                            <label for="newPatientGender">Gender:</label>
                            <select id="newPatientGender" required>
                                <option value="">Select Gender</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other</option>
                                <option value="prefer-not-to-say">Prefer not to say</option>
                            </select>
                        </div>
                        <button class="btn" id="addPatientBtn">Add Patient</button>
                        <button class="btn btn-secondary" id="hideAddPatientFormBtn">Cancel</button>
                    </div>
                </div>

                <!-- Admin Test Results Section -->
                <div id="adminTestResultsSection" class="section hidden">
                    <h2>Patient Test Results</h2>
                    <div id="adminTestResultsList"></div>
                </div>

                <!-- New Admin Calendar Section (Updated for FullCalendar) -->
                <div id="adminCalendarSection" class="section hidden">
                    <h2>Approved Appointments Calendar</h2>
                    <div id="calendar"></div> <!-- FullCalendar will render here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for displaying FullCalendar event details -->
    <div id="eventDetailsModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button" id="closeModalBtn">&times;</span>
            <h3 id="modalEventTitle"></h3>
            <p><strong>Patient:</strong> <span id="modalPatientName"></span></p>
            <p><strong>Email:</strong> <span id="modalPatientEmail"></span></p>
            <p><strong>Phone:</strong> <span id="modalPatientPhone"></span></p>
            <p><strong>Date & Time:</strong> <span id="modalEventDateTime"></span></p>
            <p><strong>Reason:</strong> <span id="modalEventReason"></span></p>
            <p><strong>Status:</strong> <span id="modalEventStatus"></span></p>
        </div>
    </div>


    <!-- FullCalendar JavaScript (Must be loaded AFTER the DOM elements) -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

    <script type="module">
        // --- Firebase Configuration (YOUR ACTUAL KEYS) ---
        const firebaseConfig = {
            apiKey: "AIzaSyD440QOEKOT3oRUORipguPtttraawzPGgs",
            authDomain: "healmed-portal-backend.firebaseapp.com",
            projectId: "healmed-portal-backend",
            storageBucket: "healmed-portal-backend.firebasestorage.app",
            messagingSenderId: "979152928801",
            appId: "1:979152928801:web:2e5dbbd801732a4e44e360",
            measurementId: "G-1MKT9TNCJ5",
            databaseURL: "https://healmed-portal-backend-default-rtdb.firebaseio.com"
        };

        // --- Firebase SDK v9 Modular Imports from CDN ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, update, remove, get } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-analytics.js";

        // --- Initialize Firebase Services ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        const analytics = getAnalytics(app);

        // --- Global State Variables ---
        let currentUser = null; // Stores current Firebase authenticated user object
        let isAdmin = false; // Flag for admin status (set after successful Firebase admin login)
        let currentTest = null; // Stores details of the test currently being taken
        let adminCalendarInstance = null; // To hold the FullCalendar object for the admin portal

        // --- Admin Credentials (Email must exist in Firebase Authentication) ---
        const ADMIN_EMAIL = 'admin@healmed.com'; // Use the email you created in Firebase Auth
        const ADMIN_PASSWORD_REFERENCE = 'healthcare2024'; // For clarity, we refer to it.

        // --- Mental Health Test Questions and Scoring ---
        const testQuestions = {
            depression: {
                title: 'Depression Screening (PHQ-9)',
                questions: [
                    'Little interest or pleasure in doing things',
                    'Feeling down, depressed, or hopeless',
                    'Trouble falling or staying asleep, or sleeping too much',
                    'Feeling tired or having little energy',
                    'Poor appetite or overeating',
                    'Feeling bad about yourself — or that you are a failure or have let yourself or your family down',
                    'Trouble concentrating on things, such as reading the newspaper or watching television',
                    'Moving or speaking so slowly that other people could have noticed. Or the opposite — being so fidgety or restless that you have been moving around a lot more than usual',
                    'Thoughts that you would be better off dead, or of hurting yourself in any way'
                ],
                options: [
                    { text: 'Not at all', value: 0 },
                    { text: 'Several days', value: 1 },
                    { text: 'More than half the days', value: 2 },
                    { text: 'Nearly every day', value: 3 }
                ],
                scoring: {
                    ranges: [
                        { min: 0, max: 4, level: 'Minimal', description: 'Minimal depression symptoms' },
                        { min: 5, max: 9, level: 'Mild', description: 'Mild depression symptoms' },
                        { min: 10, max: 14, level: 'Moderate', description: 'Moderate depression symptoms' },
                        { min: 15, max: 19, level: 'Moderately Severe', description: 'Moderately severe depression symptoms' },
                        { min: 20, max: 27, level: 'Severe', description: 'Severe depression symptoms' }
                    ]
                },
                 getBreakdown: (score) => {
                    for (const range of testQuestions.depression.scoring.ranges) {
                        if (score >= range.min && score <= range.max) {
                            return range.description;
                        }
                    }
                    return 'N/A';
                }
            },
            anxiety: {
                title: 'Anxiety Screening (GAD-7)',
                questions: [
                    'Feeling nervous, anxious, or on edge',
                    'Not being able to stop or control worrying',
                    'Worrying too much about different things',
                    'Trouble relaxing',
                    'Being so restless that it is hard to sit still',
                    'Becoming easily annoyed or irritable',
                    'Feeling afraid, as if something awful might happen'
                ],
                options: [
                    { text: 'Not at all', value: 0 },
                    { text: 'Several days', value: 1 },
                    { text: 'More than half the days', value: 2 },
                    { text: 'Nearly every day', value: 3 }
                ],
                scoring: {
                    ranges: [
                        { min: 0, max: 4, level: 'Minimal', description: 'Minimal anxiety symptoms' },
                        { min: 5, max: 9, level: 'Mild', description: 'Mild anxiety symptoms' },
                        { min: 10, max: 14, level: 'Moderate', description: 'Moderate anxiety symptoms' },
                        { min: 15, max: 21, level: 'Severe', description: 'Severe anxiety symptoms' }
                    ]
                },
                getBreakdown: (score) => {
                    for (const range of testQuestions.anxiety.scoring.ranges) {
                        if (score >= range.min && score <= range.max) {
                            return range.description;
                        }
                    }
                    return 'N/A';
                }
            },
            adhd: {
                title: 'ADHD Screening',
                questions: [
                    'How often do you have trouble wrapping up the final details of a project, once the challenging parts have been done?',
                    'How often do you have difficulty getting things in order when you have to do a task that requires organization?',
                    'How often do you have problems remembering appointments or obligations?',
                    'When you have a task that requires a lot of thought, how often do you avoid or delay getting started?',
                    'How often do you fidget or squirm with your hands or feet when you have to sit down for a long time?',
                    'How often do you feel overly active and compelled to do things, like you were driven by a motor?'
                ],
                options: [
                    { text: 'Never', value: 0 },
                    { text: 'Rarely', value: 1 },
                    { text: 'Sometimes', value: 2 },
                    { text: 'Often', value: 3 },
                    { text: 'Very Often', value: 4 }
                ],
                scoring: {
                    ranges: [
                        { min: 0, max: 8, level: 'Low', description: 'Low likelihood of ADHD symptoms' },
                        { min: 9, max: 13, level: 'Moderate', description: 'Moderate likelihood of ADHD symptoms' },
                        { min: 14, max: 24, level: 'High', description: 'High likelihood of ADHD symptoms' }
                    ]
                },
                getBreakdown: (score) => {
                    for (const range of testQuestions.adhd.scoring.ranges) {
                        if (score >= range.min && score <= range.max) {
                            return range.description;
                        }
                    }
                    return 'N/A';
                }
            }
        };

        // --- Helper Functions for UI and Messages ---
        function showMessage(message, isError = false) {
            alert(message); // Using alert as per previous pattern. Consider a custom modal for better UX.
            if (isError) {
                console.error(message);
            } else {
                console.log(message);
            }
        }

        function hideAllScreens() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('signupScreen').classList.add('hidden');
            document.getElementById('adminLoginScreen').classList.add('hidden');
            document.getElementById('patientDashboard').classList.add('hidden');
            document.getElementById('adminDashboard').classList.add('hidden');
        }

        // --- Authentication Functions (Firebase Integrated) ---

        // Patient Login
        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showMessage('Please enter both email and password', true);
                return;
            }

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                currentUser = userCredential.user;
                isAdmin = false; // Ensure admin flag is false for patient login
                console.log("Patient login successful for UID:", currentUser.uid);
                showMessage('Patient login successful!');
                showPatientDashboard();
            } catch (error) {
                console.error("Login failed:", error);
                showMessage(`Login failed: ${error.message}`, true);
            }
        }

        // Admin Login (NOW using Firebase Auth)
        async function adminLogin() {
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;

            if (!email || !password) {
                showMessage('Please enter both email and password for admin login', true);
                return;
            }

            try {
                // IMPORTANT: Sign in the admin with Firebase Authentication
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                currentUser = userCredential.user;
                
                // Confirm it's the expected admin user
                if (email === ADMIN_EMAIL) {
                    sessionStorage.setItem('isAdminLoggedIn', 'true'); // Keep this for session tracking
                    isAdmin = true;
                    console.log("Admin login successful via Firebase Auth. UID:", currentUser.uid);
                    showMessage('Admin login successful!');
                    showAdminDashboard();
                } else {
                    console.error("Admin: A Firebase user logged in, but not the designated admin email.");
                    showMessage('Admin login failed: Invalid admin credentials.', true);
                    await signOut(auth); // Sign out the unexpected user
                    sessionStorage.removeItem('isAdminLoggedIn');
                    isAdmin = false;
                }

            } catch (error) {
                console.error("Admin login failed:", error);
                showMessage(`Admin login failed: ${error.message}`, true);
                sessionStorage.removeItem('isAdminLoggedIn');
                isAdmin = false;
            }
        }

        // Patient Signup
        async function signup() {
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const phone = document.getElementById('signupPhone').value;
            const gender = document.getElementById('signupGender').value;

            if (!name || !email || !password || !phone || !gender) {
                showMessage('Please fill in all fields', true);
                return;
            }
            if (password.length < 6) {
                showMessage('Password must be at least 6 characters long.', true);
                return;
            }

            try {
                console.log("Attempting to create user with email:", email);
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const userId = userCredential.user.uid;
                console.log("User created in Firebase Auth with UID:", userId);

                await set(ref(database, 'patients/' + userId), {
                    fullName: name,
                    email: email,
                    phoneNumber: phone,
                    gender: gender,
                    createdAt: new Date().toISOString()
                });
                console.log("Patient data saved to Realtime Database for UID:", userId);

                showMessage('Account created successfully! Please login.');
                showLogin();
            } catch (error) {
                console.error("Firebase Auth Error during signup:", error);
                showMessage(`Error creating account: ${error.message}`, true);
            }
        }

        // Logout
        async function logout() {
            try {
                await signOut(auth);
                console.log("Firebase Auth user signed out.");
            } catch (error) {
                console.error("Firebase Auth signOut failed:", error);
            }
            sessionStorage.removeItem('isAdminLoggedIn');
            isAdmin = false;
            currentUser = null;
            console.log("Local state cleared. User logged out.");
            showMessage('Logged out successfully.');
            showLogin();
        }

        // --- UI Navigation Functions ---
        function showLogin() {
            hideAllScreens();
            document.getElementById('loginScreen').classList.remove('hidden');
        }

        function showSignup() {
            hideAllScreens();
            document.getElementById('signupScreen').classList.remove('hidden');
        }

        function showAdminLogin() {
            hideAllScreens();
            document.getElementById('adminLoginScreen').classList.remove('hidden');
            document.getElementById('adminEmail').value = '';
            document.getElementById('adminPassword').value = '';
        }

        function showPatientDashboard() {
            hideAllScreens();
            document.getElementById('patientDashboard').classList.remove('hidden');
            showPatientSection('appointments');
            loadAppointments();
            loadTestResults();
            loadProfile();
        }

        function showAdminDashboard() {
            hideAllScreens();
            document.getElementById('adminDashboard').classList.remove('hidden');
            showAdminSection('appointments'); // Default to showing pending appointments when admin dashboard loads
            loadPatientsList();
            loadAdminTestResults();
        }

        function showPatientSection(sectionId) {
            document.querySelectorAll('#patientDashboard .section').forEach(s => s.classList.add('hidden'));
            document.getElementById('testInterface').classList.add('hidden');

            document.querySelectorAll('#patientSidebarNav li').forEach(li => li.classList.remove('active'));
            const targetListItem = document.querySelector(`#patientSidebarNav li[data-section="${sectionId}"]`);
            if (targetListItem) {
                targetListItem.classList.add('active');
            }

            document.getElementById(`${sectionId}Section`).classList.remove('hidden');
        }

        // Generic function to show a specific section within admin dashboard
        function showAdminSection(sectionId) {
            document.querySelectorAll('#adminDashboard .section').forEach(s => s.classList.add('hidden'));

            document.querySelectorAll('#adminSidebarNav li').forEach(li => li.classList.remove('active'));
            const targetListItem = document.querySelector(`#adminSidebarNav li[data-section="${sectionId}"]`);
            if (targetListItem) {
                targetListItem.classList.add('active');
            }

            document.getElementById(`admin${sectionId.charAt(0).toUpperCase() + sectionId.slice(1)}Section`).classList.remove('hidden');

            if (sectionId === 'calendar') {
                loadAdminCalendar(); // Initialize/reload calendar when this section is shown
            } else if (sectionId === 'appointments') {
                 showAdminAppointmentCategory('pending'); // Default to pending on appt tab
            }
        }

        // Helper to manage visibility of different appointment lists in admin portal
        function showAdminAppointmentCategory(category) {
            document.getElementById('adminPendingAppointmentsList').classList.add('hidden');
            document.getElementById('adminApprovedAppointmentsList').classList.add('hidden');
            document.getElementById('adminDeniedAppointmentsList').classList.add('hidden');

            document.querySelectorAll('.admin-appt-category-buttons .btn').forEach(btn => {
                btn.classList.remove('active-category');
            });

            let titleText = "Appointment Requests";
            switch (category) {
                case 'pending':
                    document.getElementById('adminPendingAppointmentsList').classList.remove('hidden');
                    document.getElementById('showPendingAppointmentsBtn').classList.add('active-category');
                    loadAdminAppointments(); // Load pending appointments
                    titleText = "Appointment Requests (Pending)";
                    break;
                case 'approved':
                    document.getElementById('adminApprovedAppointmentsList').classList.remove('hidden');
                    document.getElementById('showApprovedAppointmentsBtn').classList.add('active-category');
                    loadAdminApprovedAppointments(); // Load approved appointments
                    titleText = "Approved Appointments (Historical)";
                    break;
                case 'denied':
                    document.getElementById('adminDeniedAppointmentsList').classList.remove('hidden');
                    document.getElementById('showDeniedAppointmentsBtn').classList.add('active-category');
                    loadAdminDeniedAppointments(); // Load denied appointments
                    titleText = "Denied Appointments (Historical)";
                    break;
            }
            document.getElementById('adminAppointmentsTitle').textContent = titleText;
            console.log(`Admin: Showing ${category} appointments.`);
        }

        // --- Patient-Specific Functionality ---

        // Load Patient Profile
        function loadProfile() {
            if (!currentUser) return;
            const profileInfoDiv = document.getElementById('profileInfo');
            console.log("Patient: Loading profile for UID:", currentUser.uid);
            onValue(ref(database, 'patients/' + currentUser.uid), (snapshot) => {
                const patientData = snapshot.val();
                if (patientData) {
                    profileInfoDiv.innerHTML = `
                        <p><strong>Name:</strong> ${patientData.fullName}</p>
                        <p><strong>Email:</strong> ${patientData.email}</p>
                        <p><strong>Phone:</strong> ${patientData.phoneNumber}</p>
                        <p><strong>Gender:</strong> ${patientData.gender}</p>
                        <p><strong>Account Created:</strong> ${new Date(patientData.createdAt).toLocaleString()}</p>
                    `;
                    console.log("Patient: Profile data loaded:", patientData.fullName);
                } else {
                    profileInfoDiv.innerHTML = '<p>No profile data found.</p>';
                    console.log("Patient: No profile data found for UID:", currentUser.uid);
                }
            }, {
                onlyOnce: false
            });
        }

        // Show/Hide Appointment Booking Form
        function showBookingForm() {
            document.getElementById('bookingForm').classList.remove('hidden');
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('appointmentDate').min = today;
            console.log("Patient: Showing booking form.");
        }

        function hideBookingForm() {
            document.getElementById('bookingForm').classList.add('hidden');
            document.getElementById('appointmentDate').value = '';
            document.getElementById('appointmentTime').value = '';
            document.getElementById('appointmentReason').value = '';
            console.log("Patient: Hiding booking form.");
        }

        // Book New Appointment (Updated to save date)
        async function bookAppointment() {
            const date = document.getElementById('appointmentDate').value; //YYYY-MM-DD
            const time = document.getElementById('appointmentTime').value; // HH:MM (e.g., "09:00")
            const reason = document.getElementById('appointmentReason').value;

            if (!date || !time || !reason) {
                showMessage('Please select a date and time, and enter a reason for your visit', true);
                return;
            }
            if (!currentUser) {
                showMessage('You must be logged in to book an appointment.', true);
                return;
            }

            try {
                console.log("Patient: Attempting to book appointment for user UID:", currentUser.uid);
                const patientSnapshot = await get(ref(database, 'patients/' + currentUser.uid));
                const patientData = patientSnapshot.val();

                if (!patientData) {
                    showMessage('Could not retrieve patient data. Please try logging in again.', true);
                    console.error("Patient: Data not found for UID:", currentUser.uid);
                    return;
                }

                const newAppointmentRef = push(ref(database, 'appointments'));
                await set(newAppointmentRef, {
                    userId: currentUser.uid,
                    fullName: patientData.fullName,
                    email: patientData.email,
                    phoneNumber: patientData.phoneNumber,
                    appointmentDate: date, // Specific date (YYYY-MM-DD)
                    appointmentTime: time, // Specific time (HH:MM)
                    reason: reason,
                    status: 'pending',
                    createdAt: new Date().toISOString()
                });
                console.log("Patient: Appointment request submitted successfully to Firebase. Path:", newAppointmentRef.toString());
                showMessage('Appointment request submitted successfully!');
                hideBookingForm();
            } catch (error) {
                console.error("Patient: Error booking appointment:", error);
                showMessage(`Error booking appointment: ${error.message}`, true);
            }
        }

        // Load Patient's Appointments (Updated to show date)
        function loadAppointments() {
            const appointmentsListDiv = document.getElementById('appointmentsList');
            if (!currentUser) {
                appointmentsListDiv.innerHTML = '<p>Please log in to view your appointments.</p>';
                return;
            }
            console.log("Patient: Loading appointments for patient UID:", currentUser.uid);
            onValue(ref(database, 'appointments'), (snapshot) => {
                appointmentsListDiv.innerHTML = '';
                let hasAppointments = false;
                snapshot.forEach((childSnapshot) => {
                    const appt = childSnapshot.val();
                    const apptId = childSnapshot.key;

                    if (appt.userId === currentUser.uid) {
                        hasAppointments = true;
                        const statusClass = `status-${appt.status}`;
                        // Display both date and time if available, otherwise fallback to old 'time' string
                        const displayDateTime = appt.appointmentDate && appt.appointmentTime
                            ? `${new Date(appt.appointmentDate).toLocaleDateString()} at ${appt.appointmentTime}`
                            : appt.time || 'N/A'; // Fallback for old data without specific date/time
                        appointmentsListDiv.innerHTML += `
                            <div class="appointment-card">
                                <h4>Appointment Request</h4>
                                <p><strong>Date & Time:</strong> ${displayDateTime}</p>
                                <p><strong>Reason:</strong> ${appt.reason}</p>
                                <p><strong>Status:</strong> <span class="appointment-status ${statusClass}">${appt.status.toUpperCase()}</span></p>
                                <p style="font-size: 0.8em; opacity: 0.8;">Requested on: ${new Date(appt.createdAt).toLocaleString()}</p>
                                <p style="font-size: 0.8em; opacity: 0.8;">Appointment ID: ${apptId}</p>
                            </div>
                        `;
                    }
                });
                if (!hasAppointments) {
                    appointmentsListDiv.innerHTML = '<p>No appointments found.</p>';
                }
                console.log("Patient: Appointments loaded. Total displayed:", appointmentsListDiv.children.length);
            }, {
                onlyOnce: false
            });
        }

        // Start a Mental Health Test
        function startTest(testType) {
            if (!currentUser) {
                showMessage('You must be logged in to take a test.', true);
                return;
            }
            console.log("Patient: Starting test:", testType);
            currentTest = testQuestions[testType];
            if (!currentTest) {
                console.error("Patient: Test type not found in testQuestions object:", testType);
                showMessage("Selected test not found. Please try again.", true);
                return;
            }
            const testQuestionsDiv = document.getElementById('testQuestions');
            testQuestionsDiv.innerHTML = '';

            document.getElementById('testTitle').textContent = currentTest.title;


            currentTest.questions.forEach((questionText, index) => {
                const questionHtml = `
                    <div class="question">
                        <h4>${index + 1}. ${currentTest.title.includes('PHQ-9') || currentTest.title.includes('GAD-7') ? 'Over the last 2 weeks, how often have you been bothered by: ' : ''}${questionText}?</h4>
                        <div class="radio-group">
                            ${currentTest.options.map((option, optIndex) => `
                                <label class="radio-option">
                                    <input type="radio" name="q${index}" value="${option.value}" id="q${index}_${optIndex}" required>
                                    ${option.text}
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;
                testQuestionsDiv.innerHTML += questionHtml;
            });

            document.getElementById('mentalHealthSection').classList.add('hidden');
            document.getElementById('testInterface').classList.remove('hidden');
            console.log("Patient: Test interface displayed for:", testType);
        }

        // Submit Mental Health Test
        async function submitTest() {
            let score = 0;
            const totalQuestions = currentTest.questions.length;
            const answers = [];

            for (let i = 0; i < totalQuestions; i++) {
                const selectedOption = document.querySelector(`input[name="q${i}"]:checked`);
                if (!selectedOption) {
                    showMessage(`Please answer question ${i + 1} before submitting.`, true);
                    return;
                }
                const value = parseInt(selectedOption.value);
                score += value;
                answers.push({ question: currentTest.questions[i], answer: currentTest.options.find(opt => opt.value === value).text, score: value });
            }

            const breakdown = currentTest.getBreakdown(score);
            console.log("Patient: Test submitted. Calculated Score:", score, "Breakdown:", breakdown);

            try {
                const newTestResultRef = push(ref(database, 'testResults'));
                await set(newTestResultRef, {
                    userId: currentUser.uid,
                    testType: currentTest.title,
                    score: score,
                    breakdown: breakdown,
                    answers: answers,
                    createdAt: new Date().toISOString()
                });
                console.log("Patient: Test results saved to Firebase. Path:", newTestResultRef.toString());
                showMessage('Test submitted successfully!');
                cancelTest();
                loadTestResults();
            } catch (error) {
                console.error("Patient: Error submitting test:", error);
                showMessage(`Error submitting test: ${error.message}`, true);
            }
        }

        // Cancel Test
        function cancelTest() {
            console.log("Patient: Test cancelled.");
            currentTest = null;
            document.getElementById('testInterface').classList.add('hidden');
            document.getElementById('mentalHealthSection').classList.remove('hidden');
            document.getElementById('testQuestions').innerHTML = '';
        }

        // Load Patient's Past Test Results
        function loadTestResults() {
            const testResultsListDiv = document.getElementById('testResultsList');
            if (!currentUser) {
                testResultsListDiv.innerHTML = '<p>Please log in to view your test results.</p>';
                return;
            }
            console.log("Patient: Loading past test results for patient UID:", currentUser.uid);
            onValue(ref(database, 'testResults'), (snapshot) => {
                testResultsListDiv.innerHTML = '';
                let hasResults = false;
                snapshot.forEach((childSnapshot) => {
                    const result = childSnapshot.val();
                    if (result.userId === currentUser.uid) {
                        hasResults = true;
                        testResultsListDiv.innerHTML += `
                            <div class="test-result-item">
                                <h4>${result.testType}</h4>
                                <p><strong>Score:</strong> ${result.score}</p>
                                <p><strong>Breakdown:</strong> ${result.breakdown}</p>
                                <p style="font-size: 0.8em; opacity: 0.8;">Taken on: ${new Date(result.createdAt).toLocaleString()}</p>
                            </div>
                        `;
                    }
                });
                if (!hasResults) {
                    testResultsListDiv.innerHTML = '<p>No test results found. Take a test to see your results here.</p>';
                }
                console.log("Patient: Test results loaded. Total displayed:", testResultsListDiv.children.length);
            }, {
                onlyOnce: false
            });
        }

        // --- Admin-Specific Functionality ---

        // Load Pending Appointment Requests for Admin
        function loadAdminAppointments() {
            const adminPendingAppointmentsListDiv = document.getElementById('adminPendingAppointmentsList');
            if (!currentUser || !isAdmin) {
                adminPendingAppointmentsListDiv.innerHTML = '<p>Unauthorized access. Please log in as Admin.</p>';
                return;
            }
            console.log("Admin: Loading pending appointment requests.");
            onValue(ref(database, 'appointments'), (snapshot) => {
                adminPendingAppointmentsListDiv.innerHTML = '';
                let hasAppointments = false;
                const rawSnapshotData = snapshot.val();
                console.log("Admin: Raw appointments snapshot data (from Firebase):", JSON.stringify(rawSnapshotData, null, 2));

                if (rawSnapshotData) {
                    const appointmentsArray = Object.keys(rawSnapshotData).map(key => ({ id: key, ...rawSnapshotData[key] }));
                    const pendingAppointments = appointmentsArray.filter(appt => appt.status === 'pending');
                    pendingAppointments.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                    pendingAppointments.forEach((appt) => {
                        console.log("Admin: Processing individual pending appointment:", appt.id, appt);
                        hasAppointments = true;
                        const statusClass = `status-${appt.status}`;
                        const displayDateTime = appt.appointmentDate && appt.appointmentTime
                            ? `${new Date(appt.appointmentDate).toLocaleDateString()} at ${appt.appointmentTime}`
                            : appt.time || 'N/A';
                        adminPendingAppointmentsListDiv.innerHTML += `
                            <div class="appointment-card admin-card">
                                <h4>Appointment Request from ${appt.fullName}</h4>
                                <p><strong>Email:</strong> ${appt.email}</p>
                                <p><strong>Phone:</strong> ${appt.phoneNumber}</p>
                                <p><strong>Requested Date & Time:</strong> ${displayDateTime}</p>
                                <p><strong>Reason:</strong> ${appt.reason}</p>
                                <p><strong>Status:</strong> <span class="appointment-status ${statusClass}">${appt.status.toUpperCase()}</span></p>
                                <p style="font-size: 0.8em; opacity: 0.8;">Requested on: ${new Date(appt.createdAt).toLocaleString()}</p>
                                <p style="font-size: 0.8em; opacity: 0.8;">Appointment ID: ${appt.id}</p>
                                <div class="action-buttons">
                                    <button class="btn-approve" data-id="${appt.id}">Approve</button>
                                    <button class="btn-deny" data-id="${appt.id}">Deny</button>
                                </div>
                            </div>
                        `;
                    });
                }
                if (!hasAppointments) {
                    adminPendingAppointmentsListDiv.innerHTML = '<p>No pending appointment requests found.</p>';
                }
                console.log("Admin: Pending appointments loaded. Total displayed elements:", adminPendingAppointmentsListDiv.children.length);
                document.querySelectorAll('#adminPendingAppointmentsList .btn-approve').forEach(button => {
                    button.onclick = (e) => approveAppointment(e.target.dataset.id);
                });
                document.querySelectorAll('#adminPendingAppointmentsList .btn-deny').forEach(button => {
                    button.onclick = (e) => denyAppointment(e.target.dataset.id);
                });
            }, {
                onlyOnce: false
            });
        }

        // Load Approved Appointment Requests for Admin
        function loadAdminApprovedAppointments() {
            const adminApprovedAppointmentsListDiv = document.getElementById('adminApprovedAppointmentsList');
            if (!currentUser || !isAdmin) {
                adminApprovedAppointmentsListDiv.innerHTML = '<p>Unauthorized access. Please log in as Admin.</p>';
                return;
            }
            console.log("Admin: Loading approved appointment requests.");
            onValue(ref(database, 'appointments'), (snapshot) => {
                adminApprovedAppointmentsListDiv.innerHTML = '';
                let hasAppointments = false;
                const rawSnapshotData = snapshot.val();

                if (rawSnapshotData) {
                    const appointmentsArray = Object.keys(rawSnapshotData).map(key => ({ id: key, ...rawSnapshotData[key] }));
                    const approvedAppointments = appointmentsArray.filter(appt => appt.status === 'approved');
                    approvedAppointments.sort((a, b) => {
                        const dateA = appt.appointmentDate && appt.appointmentTime ? new Date(`${appt.appointmentDate}T${appt.appointmentTime}`) : new Date(appt.createdAt);
                        const dateB = appt.appointmentDate && appt.appointmentTime ? new Date(`${appt.appointmentDate}T${appt.appointmentTime}`) : new Date(appt.createdAt);
                        return dateB - dateA;
                    });

                    approvedAppointments.forEach((appt) => {
                        hasAppointments = true;
                        const statusClass = `status-${appt.status}`;
                        const displayDateTime = appt.appointmentDate && appt.appointmentTime
                            ? `${new Date(appt.appointmentDate).toLocaleDateString()} at ${appt.appointmentTime}`
                            : appt.time || 'N/A';
                        adminApprovedAppointmentsListDiv.innerHTML += `
                            <div class="appointment-card admin-card approved-status">
                                <h4>Appointment for ${appt.fullName}</h4>
                                <p><strong>Email:</strong> ${appt.email}</p>
                                <p><strong>Phone:</strong> ${appt.phoneNumber}</p>
                                <p><strong>Date & Time:</strong> ${displayDateTime}</p>
                                <p><strong>Reason:</strong> ${appt.reason}</p>
                                <p><strong>Status:</strong> <span class="appointment-status ${statusClass}">${appt.status.toUpperCase()}</span></p>
                                <p style="font-size: 0.8em; opacity: 0.8;">Requested on: ${new Date(appt.createdAt).toLocaleString()}</p>
                                <p style="font-size: 0.8em; opacity: 0.8;">Appointment ID: ${appt.id}</p>
                            </div>
                        `;
                    });
                }
                if (!hasAppointments) {
                    adminApprovedAppointmentsListDiv.innerHTML = '<p>No approved appointment requests found.</p>';
                }
                console.log("Admin: Approved appointments loaded. Total displayed elements:", adminApprovedAppointmentsListDiv.children.length);
            }, {
                onlyOnce: false
            });
        }

        // Load Denied Appointment Requests for Admin
        function loadAdminDeniedAppointments() {
            const adminDeniedAppointmentsListDiv = document.getElementById('adminDeniedAppointmentsList');
            if (!currentUser || !isAdmin) {
                adminDeniedAppointmentsListDiv.innerHTML = '<p>Unauthorized access. Please log in as Admin.</p>';
                return;
            }
            console.log("Admin: Loading denied appointment requests.");
            onValue(ref(database, 'appointments'), (snapshot) => {
                adminDeniedAppointmentsListDiv.innerHTML = '';
                let hasAppointments = false;
                const rawSnapshotData = snapshot.val();

                if (rawSnapshotData) {
                    const appointmentsArray = Object.keys(rawSnapshotData).map(key => ({ id: key, ...rawSnapshotData[key] }));
                    const deniedAppointments = appointmentsArray.filter(appt => appt.status === 'denied');
                    deniedAppointments.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                    deniedAppointments.forEach((appt) => {
                        hasAppointments = true;
                        const statusClass = `status-${appt.status}`;
                        const displayDateTime = appt.appointmentDate && appt.appointmentTime
                            ? `${new Date(appt.appointmentDate).toLocaleDateString()} at ${appt.appointmentTime}`
                            : appt.time || 'N/A';
                        adminDeniedAppointmentsListDiv.innerHTML += `
                            <div class="appointment-card admin-card denied-status">
                                <h4>Appointment for ${appt.fullName}</h4>
                                <p><strong>Email:</strong> ${appt.email}</p>
                                <p><strong>Phone:</strong> ${appt.phoneNumber}</p>
                                <p><strong>Date & Time:</strong> ${displayDateTime}</p>
                                <p><strong>Reason:</strong> ${appt.reason}</p>
                                <p><strong>Status:</strong> <span class="appointment-status ${statusClass}">${appt.status.toUpperCase()}</span></p>
                                <p style="font-size: 0.8em; opacity: 0.8;">Requested on: ${new Date(appt.createdAt).toLocaleString()}</p>
                                <p style="font-size: 0.8em; opacity: 0.8;">Appointment ID: ${appt.id}</p>
                            </div>
                        `;
                    });
                }
                if (!hasAppointments) {
                    adminDeniedAppointmentsListDiv.innerHTML = '<p>No denied appointment requests found.</p>';
                }
                console.log("Admin: Denied appointments loaded. Total displayed elements:", adminDeniedAppointmentsListDiv.children.length);
            }, {
                onlyOnce: false
            });
        }

        // Approve Appointment
        async function approveAppointment(apptId) {
            if (!currentUser || !isAdmin) {
                showMessage('Unauthorized action.', true);
                return;
            }
            console.log("Admin: Attempting to approve appointment ID:", apptId);
            try {
                await update(ref(database, 'appointments/' + apptId), { status: 'approved' });
                console.log("Admin: Appointment approved:", apptId);
                showMessage('Appointment approved successfully!');
            } catch (error) {
                console.error("Admin: Error approving appointment:", error);
                showMessage(`Error approving appointment: ${error.message}`, true);
            }
        }

        // Deny Appointment
        async function denyAppointment(apptId) {
            if (!currentUser || !isAdmin) {
                showMessage('Unauthorized action.', true);
                return;
            }
            console.log("Admin: Attempting to deny appointment ID:", apptId);
            try {
                await update(ref(database, 'appointments/' + apptId), { status: 'denied' });
                console.log("Admin: Appointment denied:", apptId);
                showMessage('Appointment denied.');
            } catch (error) {
                console.error("Admin: Error denying appointment:", error);
                showMessage(`Error denying appointment: ${error.message}`, true);
            }
        }

        // Show Add Patient Form
        function showAddPatientForm() {
            if (!currentUser || !isAdmin) {
                showMessage('Unauthorized access.', true);
                return;
            }
            document.getElementById('addPatientForm').classList.remove('hidden');
            console.log("Admin: Showing add patient form.");
        }

        function hideAddPatientForm() {
            document.getElementById('addPatientForm').classList.add('hidden');
            document.getElementById('newPatientName').value = '';
            document.getElementById('newPatientEmail').value = '';
            document.getElementById('newPatientPassword').value = '';
            document.getElementById('newPatientPhone').value = '';
            document.getElementById('newPatientGender').value = '';
            console.log("Admin: Hiding add patient form.");
        }

        // Add New Patient via Admin Portal
        async function addPatient() {
            if (!currentUser || !isAdmin) {
                showMessage('Unauthorized action.', true);
                return;
            }
            const name = document.getElementById('newPatientName').value;
            const email = document.getElementById('newPatientEmail').value;
            const password = document.getElementById('newPatientPassword').value;
            const phone = document.getElementById('newPatientPhone').value;
            const gender = document.getElementById('newPatientGender').value;

            if (!name || !email || !password || !phone || !gender) {
                showMessage('Please fill in all fields for the new patient', true);
                return;
            }
            if (password.length < 6) {
                showMessage('Password for the new patient must be at least 6 characters long.', true);
                return;
            }

            try {
                console.log("Admin: Attempting to add new patient with email:", email);
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const userId = userCredential.user.uid;
                console.log("Admin: Created new user in Auth with UID:", userId);

                await set(ref(database, 'patients/' + userId), {
                    fullName: name,
                    email: email,
                    phoneNumber: phone,
                    gender: gender,
                    createdAt: new Date().toISOString()
                });
                console.log("Admin: Saved patient data to Realtime Database for UID:", userId);
                showMessage(`Patient ${name} added successfully! Temporary password: ${password}`);
                hideAddPatientForm();
            } catch (error) {
                console.error("Admin: Error adding patient via admin portal:", error);
                showMessage(`Error adding patient: ${error.message}`, true);
            }
        }

        // Load All Patients for Admin
        function loadPatientsList() {
            const patientsListDiv = document.getElementById('patientsList');
            if (!currentUser || !isAdmin) {
                patientsListDiv.innerHTML = '<p>Unauthorized access. Please log in as Admin.</p>';
                return;
            }
            console.log("Admin: Loading all patients.");
            onValue(ref(database, 'patients'), (snapshot) => {
                patientsListDiv.innerHTML = '';
                let hasPatients = false;
                const rawSnapshotData = snapshot.val();
                console.log("Admin: Raw patients snapshot data (from Firebase):", JSON.stringify(rawSnapshotData, null, 2));

                if (rawSnapshotData) {
                    const patientsArray = Object.keys(rawSnapshotData).map(key => ({ id: key, ...rawSnapshotData[key] }));
                    patientsArray.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                    patientsArray.forEach((patient) => {
                        hasPatients = true;
                        patientsListDiv.innerHTML += `
                            <div class="admin-card" style="background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);">
                                <h4>${patient.fullName}</h4>
                                <p><strong>Email:</strong> ${patient.email}</p>
                                <p><strong>Phone:</strong> ${patient.phoneNumber}</p>
                                <p><strong>Gender:</strong> ${patient.gender}</p>
                                <p style="font-size: 0.8em; opacity: 0.8;">Firebase ID: ${patient.id}</p>
                            </div>
                        `;
                    });
                }
                if (!hasPatients) {
                    patientsListDiv.innerHTML = '<p>No patients registered.</p>';
                }
                console.log("Admin: Patients loaded. Total displayed elements:", patientsListDiv.children.length);
            }, {
                onlyOnce: false
            });
        }

        // Load All Test Results for Admin
        function loadAdminTestResults() {
            const adminTestResultsListDiv = document.getElementById('adminTestResultsList');
            if (!currentUser || !isAdmin) {
                adminTestResultsListDiv.innerHTML = '<p>Unauthorized access. Please log in as Admin.</p>';
                return;
            }
            console.log("Admin: Loading all test results.");
            onValue(ref(database, 'testResults'), async (snapshot) => {
                adminTestResultsListDiv.innerHTML = '';
                let hasResults = false;
                const results = [];
                const rawSnapshotData = snapshot.val();
                console.log("Admin: Raw test results snapshot data (from Firebase):", JSON.stringify(rawSnapshotData, null, 2));

                if (rawSnapshotData) {
                    snapshot.forEach((childSnapshot) => {
                        results.push(childSnapshot.val());
                    });
                }

                if (results.length > 0) {
                    const patientPromises = results.map(result => get(ref(database, 'patients/' + result.userId)));
                    const patientSnapshots = await Promise.all(patientPromises);
                    const patientMap = {};
                    patientSnapshots.forEach(snap => {
                        if (snap.exists()) {
                            patientMap[snap.key] = snap.val().fullName || 'Unknown Patient';
                        }
                    });

                    results.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                    results.forEach(result => {
                        hasResults = true;
                        const patientName = patientMap[result.userId] || 'N/A';
                        console.log("Admin: Processing individual test result for", patientName, ":", result);
                        adminTestResultsListDiv.innerHTML += `
                            <div class="test-result-item admin-card" style="background: linear-gradient(135deg, #00b894 0%, #00a085 100%);">
                                <h4>${result.testType} for ${patientName}</h4>
                                <p><strong>Score:</strong> ${result.score}</p>
                                <p><strong>Breakdown:</strong> ${result.breakdown}</p>
                                <p style="font-size: 0.8em; opacity: 0.8;">Taken on: ${new Date(result.createdAt).toLocaleString()}</p>
                            </div>
                        `;
                    });
                }
                if (!hasResults) {
                    adminTestResultsListDiv.innerHTML = '<p>No test results found.</p>';
                }
                console.log("Admin: Test results loaded. Total displayed elements:", adminTestResultsListDiv.children.length);
            }, {
                onlyOnce: false
            });
        }

        // Helper to parse old string format (e.g., "Thursday 1-2 PM") to a Date object
        // This function will find the NEXT upcoming occurrence of the specified day/time from TODAY.
        function getNextOccurringDateTime(dayTimeString) {
            const now = new Date();
            const daysOfWeek = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            
            const dayPartMatch = dayTimeString.match(/^(monday|tuesday|wednesday|thursday|friday|saturday|sunday)/i);
            const timePartMatch = dayTimeString.match(/(\d+)(?:-\d+)?\s*(AM|PM)/i);

            if (!dayPartMatch || !timePartMatch) {
                console.warn("Could not parse old time format for getNextOccurringDateTime:", dayTimeString, "Returning null.");
                return null;
            }

            const targetDayName = dayPartMatch[1].toLowerCase();
            const targetDayIndex = daysOfWeek.indexOf(targetDayName);

            let hour = parseInt(timePartMatch[1]);
            const ampm = timePartMatch[2] ? timePartMatch[2].toLowerCase() : '';

            if (ampm === 'pm' && hour < 12) hour += 12;
            if (ampm === 'am' && hour === 12) hour = 0; // 12 AM (midnight) is 0 hour

            let resultDate = new Date(now);
            resultDate.setHours(hour, 0, 0, 0); // Set desired time for today

            let currentDayIndex = resultDate.getDay();
            let dayDifference = targetDayIndex - currentDayIndex;

            // If target day is earlier in the week, or it's today and time has passed, jump to next week.
            if (dayDifference < 0 || (dayDifference === 0 && resultDate < now)) {
                dayDifference += 7;
            }

            resultDate.setDate(resultDate.getDate() + dayDifference);
            return resultDate;
        }


        // Load Approved Appointments for Admin Calendar (Now integrates FullCalendar)
        function loadAdminCalendar() {
            const calendarEl = document.getElementById('calendar');
            const eventDetailsModal = document.getElementById('eventDetailsModal');
            const closeModalBtn = document.getElementById('closeModalBtn');

            if (!currentUser || !isAdmin) {
                calendarEl.innerHTML = '<p>Unauthorized access. Please log in as Admin.</p>';
                if (adminCalendarInstance) {
                    adminCalendarInstance.destroy();
                    adminCalendarInstance = null;
                }
                return;
            }

            console.log("Admin: Initializing/Reloading FullCalendar for approved appointments.");

            if (adminCalendarInstance) {
                adminCalendarInstance.destroy(); // Destroy previous instance to prevent re-rendering issues
                adminCalendarInstance = null;
            }

            adminCalendarInstance = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                // Customize event display to include a green circle
                eventContent: function(arg) {
                    // Check if the event is an approved event using its classNames
                    if (arg.event.classNames.includes('approved-event')) {
                        return { html: `<div class="event-circle"></div><span>${arg.event.title}</span>` };
                    }
                    // For other event types (if any, not relevant here but good practice)
                    return { html: `<span>${arg.event.title}</span>` };
                },
                events: async function(fetchInfo, successCallback, failureCallback) {
                    onValue(ref(database, 'appointments'), async (snapshot) => {
                        const rawSnapshotData = snapshot.val();
                        console.log("Admin: Raw calendar appointments snapshot data (from Firebase):", JSON.stringify(rawSnapshotData, null, 2));

                        const events = [];
                        if (rawSnapshotData) {
                            const appointmentsArray = Object.keys(rawSnapshotData).map(key => ({ id: key, ...rawSnapshotData[key] }));
                            const approvedAppointments = appointmentsArray.filter(appt => appt.status === 'approved');

                            const patientPromises = approvedAppointments.map(appt => get(ref(database, 'patients/' + appt.userId)));
                            const patientSnapshots = await Promise.all(patientPromises);
                            const patientMap = {};
                            patientSnapshots.forEach(snap => {
                                if (snap.exists()) {
                                    patientMap[snap.key] = snap.val().fullName || 'Unknown Patient';
                                }
                            });

                            approvedAppointments.forEach(appt => {
                                let eventStart;
                                let eventEnd;
                                let eventTitle;
                                let displayTimeForModal;
                                
                                const patientFirstName = patientMap[appt.userId] ? patientMap[appt.userId].split(' ')[0] : 'N/A';

                                // Case 1: New appointments with precise date and time
                                if (appt.appointmentDate && appt.appointmentTime) {
                                    eventStart = `${appt.appointmentDate}T${appt.appointmentTime}:00`; // YYYY-MM-DDTHH:MM:SS
                                    const startDateTime = new Date(eventStart);
                                    const endDateTime = new Date(startDateTime.getTime() + 60 * 60 * 1000); // 1-hour appointment
                                    eventEnd = endDateTime.toISOString().slice(0, 19); // YYYY-MM-DDTHH:MM:SS
                                    
                                    displayTimeForModal = startDateTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                                    eventTitle = `Appt with ${patientFirstName}`; 

                                    console.log(`Calendar Event (NEW): ID: ${appt.id}, Title: "${eventTitle}", Start: "${eventStart}", End: "${eventEnd}"`);

                                } 
                                // Case 2: Legacy appointments with only day and time string (e.g., "Friday 1-2 PM")
                                else if (appt.time) {
                                    const inferredDate = getNextOccurringDateTime(appt.time);
                                    if (inferredDate) {
                                        eventStart = inferredDate.toISOString().slice(0, 19);
                                        const endDateTime = new Date(inferredDate.getTime() + 60 * 60 * 1000); // Assume 1-hour appt
                                        eventEnd = endDateTime.toISOString().slice(0, 19);
                                        
                                        displayTimeForModal = appt.time; // Use original string for modal
                                        eventTitle = `Appt (Legacy) ${patientFirstName}`;
                                        console.log(`Calendar Event (LEGACY): ID: ${appt.id}, Title: "${eventTitle}", Inferred Start: "${eventStart}", Inferred End: "${eventEnd}"`);
                                    } else {
                                        console.error(`Admin: Could not infer date for legacy appointment ID ${appt.id} with time: ${appt.time}. Skipping event.`);
                                        return;
                                    }
                                } else {
                                    console.error(`Admin: Appointment ID ${appt.id} missing valid date/time information. Skipping event.`);
                                    return;
                                }
                                
                                events.push({
                                    id: appt.id,
                                    title: eventTitle,
                                    start: eventStart,
                                    end: eventEnd,
                                    allDay: false, // These are time-specific appointments
                                    classNames: ['approved-event'], // Add a class for specific styling if needed
                                    extendedProps: { // Custom properties to retrieve later
                                        patientName: patientMap[appt.userId] || 'N/A',
                                        patientEmail: appt.email,
                                        patientPhone: appt.phoneNumber,
                                        reason: appt.reason,
                                        status: appt.status,
                                        displayTime: displayTimeForModal, // Store the formatted/original time for the modal
                                        originalApptDate: appt.appointmentDate // Store original date for debugging/formatting
                                    }
                                });
                            });
                        }
                        successCallback(events);
                        console.log("Admin: FullCalendar events processed. Total approved events prepared:", events.length);
                    }, {
                        onlyOnce: false
                    });
                },
                // Handler for when an event is clicked on the calendar
                eventClick: function(info) {
                    const event = info.event;
                    const props = event.extendedProps;
                    
                    const startDateTime = new Date(event.start);
                    const formattedDate = startDateTime.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                    
                    document.getElementById('modalEventTitle').textContent = `Appointment with ${props.patientName}`;
                    document.getElementById('modalPatientName').textContent = props.patientName;
                    document.getElementById('modalPatientEmail').textContent = props.patientEmail;
                    document.getElementById('modalPatientPhone').textContent = props.patientPhone;
                    document.getElementById('modalEventDateTime').textContent = `${formattedDate} at ${props.displayTime}`;
                    document.getElementById('modalEventReason').textContent = props.reason;
                    document.getElementById('modalEventStatus').textContent = props.status.toUpperCase();

                    eventDetailsModal.classList.remove('hidden'); // Show the modal
                }
            });

            adminCalendarInstance.render(); // Render the calendar for the first time

            closeModalBtn.onclick = function() {
                eventDetailsModal.classList.add('hidden');
            };

            window.onclick = function(event) {
                if (event.target == eventDetailsModal) {
                    eventDetailsModal.classList.add('hidden');
                }
            };
        }


        // --- Initial Load Logic and Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            // Set up main screen navigation
            document.getElementById('loginBtn').addEventListener('click', login);
            document.getElementById('showSignupBtn').addEventListener('click', showSignup);
            document.getElementById('showAdminLoginBtn').addEventListener('click', showAdminLogin);

            document.getElementById('signupBtn').addEventListener('click', signup);
            document.getElementById('backToLoginBtn').addEventListener('click', showLogin);

            document.getElementById('adminLoginBtn').addEventListener('click', adminLogin);
            document.getElementById('backToPatientLoginBtn').addEventListener('click', showLogin);

            // Set up dashboard logout buttons
            document.getElementById('patientLogoutBtn').addEventListener('click', logout);
            document.getElementById('adminLogoutBtn').addEventListener('click', logout);

            // Set up patient dashboard buttons
            document.getElementById('showBookingFormBtn').addEventListener('click', showBookingForm);
            document.getElementById('submitAppointmentRequestBtn').addEventListener('click', bookAppointment);
            document.getElementById('hideBookingFormBtn').addEventListener('click', hideBookingForm);
            document.getElementById('submitTestBtn').addEventListener('click', submitTest);
            document.getElementById('cancelTestBtn').addEventListener('click', cancelTest);


            // Set up patient sidebar navigation using event delegation
            document.getElementById('patientSidebarNav').addEventListener('click', (event) => {
                if (event.target.tagName === 'LI' && event.target.dataset.section) {
                    showPatientSection(event.target.dataset.section);
                }
            });

            // Set up test card event listeners using event delegation for mentalHealthSection
            document.getElementById('mentalHealthSection').addEventListener('click', (event) => {
                if (event.target.closest('.test-card')) {
                    const testType = event.target.closest('.test-card').dataset.testType;
                    startTest(testType);
                }
            });

            // Set up admin sidebar navigation using event delegation
            document.getElementById('adminSidebarNav').addEventListener('click', (event) => {
                if (event.target.tagName === 'LI' && event.target.dataset.section) {
                    showAdminSection(event.target.dataset.section);
                }
            });

            // Set up admin appointment category buttons
            document.getElementById('showPendingAppointmentsBtn').addEventListener('click', () => showAdminAppointmentCategory('pending'));
            document.getElementById('showApprovedAppointmentsBtn').addEventListener('click', () => showAdminAppointmentCategory('approved'));
            document.getElementById('showDeniedAppointmentsBtn').addEventListener('click', () => showAdminAppointmentCategory('denied'));


            // Set up admin patient management buttons
            document.getElementById('showAddPatientFormBtn').addEventListener('click', showAddPatientForm);
            document.getElementById('addPatientBtn').addEventListener('click', addPatient);
            document.getElementById('hideAddPatientFormBtn').addEventListener('click', hideAddPatientForm);


            // Check Firebase Auth state on page load
            onAuthStateChanged(auth, (user) => {
                console.log("Auth state changed. Current user:", user ? user.uid : "No user");
                if (user) {
                    currentUser = user;
                    if (currentUser.email === ADMIN_EMAIL) {
                        isAdmin = true;
                        console.log("Auth state changed: Admin user logged in. UID:", user.uid);
                        showAdminDashboard();
                    } else {
                        isAdmin = false;
                        console.log("Auth state changed: Regular patient user logged in. UID:", user.uid);
                        showPatientDashboard();
                    }
                } else {
                    if (sessionStorage.getItem('isAdminLoggedIn') === 'true') {
                         isAdmin = true;
                         console.log("Auth state changed: Admin session found (from storage, no current Firebase Auth user yet).");
                         showAdminDashboard();
                    } else {
                        console.log("Auth state changed: No user or admin session found. Showing login.");
                        showLogin();
                    }
                }
            });
        });

    </script>
</body>
</html>
